{"version":3,"names":["COLOR_PALETTE","chart_wrapper","div_wrapper","options","this","constructor","Error","_n_charts_created","id","_display_download","display_download","_download_chart_container","undefined","plot_container","_display_control_panel","display_control_panel","controls_container","d3_chart_wrapper","call","svg","toggle_visibility","element","attr","transition","linspace","start","stop","nsteps","delta","d3","range","map","i","prototype","id_string","render","replaceChildren","render_plot","render_control_panel","_render_download_panel","supported_formats","get_supported_export_formats","length","download_chart_container","common","create_dom_element","element_type","class_name","parent","format_select","format","value","text_content","toUpperCase","type","tstring","download","addEventListener","download_chart","filename","download_func_name","Object","setPrototypeOf","select","append","download_chart_as_svg","svg_data","node","outerHTML","svg_blob","Blob","url","URL","createObjectURL","tmpLink","href","setAttribute","click","remove","revokeObjectURL","CURVES","Basis","curveBasis","curveBasisClosed","curveBasisOpen","Bundle","curveBundle","curveBumpX","curveBumpY","Cardinal","curveCardinal","curveCardinalClosed","curveCardinalOpen","curveCatmullRom","curveCatmullRomClosed","curveCatmullRomOpen","Linear","curveLinear","curveLinearClosed","curveMonotoneX","curveMonotoneY","Natural","curveNatural","Step","curveStep","curveStepAfter","curveStepBefore","compute_n_bins","array_equal","arrs","size","arr","slice","sqrt","values","Math","ceil","sturges","log2","rice","pow","doane","n","sigma","std","deviation","mean","sum","skew","abs","scott","max","min","freedman_diaconis","quartile3","quantile","quartile1","iqr","TOOLTIP_STYLE","padding","display","KEY_CHANGE_EVENT_NAME","KEY_CHANGE_EVENT","Event","KEY_CHANGE_LISTENER_CLASS_NAME","boxvio_chart_wrapper","data","key_titles","_overflow","overflow","sort_xaxis","_data","sort","a","b","key","join","localeCompare","ele","entries","metrics","calc_metrics","outliers","filter","v","lower_fence","upper_fence","extent","_data_extent","flat","_key_strings","join_key","_key_size","_key_titles","_colors","_","_ylabel","ylabel","yaxis_padding","_full_width","_full_height","_chart","margin","top","right","bottom","left","width","height","yscale","scaleLinear","domain","clamp","yticks_division","yaxis","axisLeft","tickFormat","d","toFixed","ticks","violin_scale","initial","box_scale","xscale","scaleBand","xaxis","axisBottom","split_key","split","SPLITTER","xticklabel_angle","n_bins","initial_value","histogram","bin","thresholds","bins","supported_curves","violin_curve","_graphics","root_g","yaxwl_g","xaxis_g","yaxis_g","cdividers_g","violins_g","violins","boxes_g","tooltip_div","_controls","max_bins_multiplier","selected_index","median","_query_data","key_tpl","_get_key_templates","templates_wd","obj","JSON","parse","stringify","concat","Array","fill","templates","tmp_template","template","push","_get_next_key_component_values","pkey","psize","values_wd","current_value","get_index_of_key","findIndex","set_violin_scale","scale","selectAll","_render_violins","set_n_bins","chart","_render_violin","set_violin_curve","curve_name","set_box_scale","_render_boxes","style","on","e","stopPropagation","_hide_tooltip","_render_axis","_render_ygrid","_render_key2_dividers","_render_tooltip","g","xaxwl_g","apply_xticklabel_angle","text","angle","apply_ygrid_mode","mode","major_lines","major_opacity","minor_lines","minor_opacity","key2_dividers_g","dividers_g","color","key_tpls","index","queried_data","x","divider_g","is_g_ready","key_string","bandwidth","max_count","x_num","datum","area","x0","x1","y","curve","boxes","box_width","group_box","outlier","whiskers","circle","tooltip_active","tooltip_hover","tooltip_element","new_node","existing_node","parentNode","insertBefore","nextSibling","k","tooltip_text","datapoints","html","upper_container","_render_grid_select","_render_xticklabel_angle_slider","_render_violin_curve_selector","_render_checkboxes","_render_scale_sliders","_render_key_selects","_render_n_bins_control","container","select_container","grid_select_id","grid","grid_select","none_f","major","major_minor","slider_container","xticklabel_angle_slider_id","xticklabel_angle_slider","Number","curve_select_id","curve_select","container_div","show_key2_div","show_key2_checkbox_id","show_key2_checkbox","checked","show","toLowerCase","show_violins_div","show_violins_checkbox_id","show_violins_checkbox","show_violins","show_boxes_div","show_boxes_checkbox_id","show_boxes_checkbox","show_boxes","show_outliers_div","show_outliers_checkbox_id","show_outliers_checkbox","show_outliers","group","violin_container_div","violin_scale_slider_id","violin_width","violin_scale_slider","reset","box_container_div","box_scale_slider_id","box_scale_slider","key_selects","populate_key_select","key_select","select_id","j","ks","listeners","getElementsByClassName","dispatchEvent","violin_n_bins_slider_id","violin_resolution","violin_n_bins_slider","reset_all_violins","chartjs_chart_wrapper","canvas","histogram_wrapper","_density","_n_bins_default","_n_bins","_xlabel","xlabel","_n_decimals","_max_bins_multiplier","_bar_color","download_chart_as_png","toBase64Image","_tweak_c2s","offsetWidth","offsetHeight","animation","reponsive","svgContext","C2S","Chart","config","_config","encodeURIComponent","getSerializedSvg","getContext","contextId","__canvas","getAttribute","name","listener","eventListenerOptions","get_density","set_density","density","bin_centers","plot_data","half_bin_width","data_min","data_max","_get_plotting_data","datasets","label","_get_density_string","scales","title","update","get_n_bins","stepSize","plugins","tooltip","callbacks","_get_tooltip_title_callback","get_bar_color","set_bar_color","bar_color","backgroundColor","bin_width","apply","reduce","partialSum","val","n_decimals","items","dataIndex","chart_data","categoryPercentage","barPercentage","scales_options","offset","callback","labels","Boolean","font","plugins_options","legend","parsing","normalized","self","slider","density_checkbox_id","density_checkbox","color_picker_container","window","iro","ColorPicker","layoutDirection","layout","component","ui","Wheel","Slider","sliderType","rgbaString","analysis","form","area_name","row","export_data_container","form_items_container","diameter_chart_container","weight_chart_container","diameter_chart_wrapper","weight_chart_wrapper","set_up","form_node","render_form","appendChild","fragment","DocumentFragment","form_factory","form_row","item_factory","mint","q_column","value_wrapper","eq","eq_in","eq_out","is_term","form_item","activate_autocomplete","table","q_table","number_key","group_op","material","denomination","culture","iconography_obverse","value_split","q_splittable","q_selected_eq","iconography_reverse","input_type","period","sql_filter","node_input","range_slider_value_in","querySelector","range_slider_value_out","get_catalog_range_years","then","range_data","$","target","step","slide","event","change","q","submit_group","search","preventDefault","form_submit","location","replace","pathname","operators_node","build_operators_node","form_obj","scroll_result","form_items","build_filter","info_lines","document","querySelectorAll","info_lines_length","classList","add","hasChildNodes","removeChild","lastChild","result","getElementById","spinner","search_rows","limit","process_result","fn","columns","parsed_data","event_manager","publish","ref_type_number","p_mint","ref_type_material","ref_type_denomination","tmp_data","calculable","full_coins_reference_calculable","diameter_max","full_coins_reference_diameter_max","diameter_min","full_coins_reference_diameter_min","weight","full_coins_reference_weight","tmp_diameter_max","tmp_diameter_min","tmp_weight","keys","weights","number","diameters","diameter","ar_fields","order","lang","page_globals","WEB_CURRENT_LANG_CODE","Promise","resolve","parse_sql_filter","request_body","dedalo_get","count","data_manager","request","body","response","page","parse_catalog_data","db_name","WEB_DB","api_response","current_min","parseInt"],"sources":["../../lib/charts/chart-wrapper.js","../../lib/charts/d3/d3-chart-wrapper.js","../../lib/charts/d3/utils.js","../../lib/charts/compute-n-bins.js","../../lib/charts/utils.js","../../lib/charts/d3/boxvio-chart-wrapper.js","../../lib/charts/chartjs/chartjs-chart-wrapper.js","../../lib/charts/chartjs/histogram-wrapper.js","analysis.js"],"sourcesContent":["\"use strict\";\n\n/**\n * Width (in pixels) of color picker\n * @type {number}\n */\nexport const COLOR_PICKER_WIDTH = 200\n\n/**\n * Default name for the chart -> when exporting,\n * `<name>.<format>`\n * @type {string}\n */\nconst DEFAULT_CHART_NAME = 'chart'\n\n/**\n * Color palette, totally stolen from matplotlib\n * @type {string[]}\n */\nexport const COLOR_PALETTE = ['#1f77b4', '#ff7f0e', '#2ca02c', '#d62728', '#9467bd', '#8c564b', '#e377c2', '#17becf']\n\n\n/**\n * Chart wrapper class (download panel, plot, and control panel)\n *\n * The `render` method must be called for the chart to be rendered to the DOM!!!\n *\n * Within the provided div wrapper, it will create three divs:\n * 1. If download is supported, a div to containing the download section, with\n *    id `chart<id>_download_chart_container` class `download_chart_container`\n * 2. A div to contain the plot itself, with id `chart<id>_plot_wrapper` class `plot_wrapper`\n * 3. A div to contain the control panel, with id `chart<id>_control_panel` and class `control_panel`\n *\n * It clears the container div during render, so subclasses should work with the dom\n * after the render methods of this superclass (`render_plot` and `render_control_panel`) have been called.\n * In other words, subclasses should override those specific methods instead of the general `render` function\n *\n * Last reminder, the constructor is the place to do data processing exclusively. All rendering to the DOM\n * must be done in the specific render methods. Otherwise, bugs WILL appear.\n * @class\n * @abstract\n * @param {Element} div_wrapper\n * @param {Object} options configuration options\n * @param {boolean} options.display_download whether to display the download panel (default `false`)\n * @param {boolean} options.display_control_panel whether to display the control panel (default `false`)\n */\nexport function chart_wrapper(div_wrapper, options) {\n\tif (this.constructor === chart_wrapper) {\n\t\tthrow new Error(\"Abstract class 'chart_wrapper' cannot be instantiated\")\n\t}\n\tchart_wrapper._n_charts_created++;\n\t/**\n\t * Unique identifier for the chart.\n\t *\n\t * Subclasses MUST use this in order to assing IDs\n\t * to DOM elements, in order to avoid bugs and cross-chart events\n\t * @type {number}\n\t * @protected\n\t */\n\tthis.id = chart_wrapper._n_charts_created\n\t/**\n\t * Div element wrapping the chart itself and\n\t * the controls\n\t * @type {Element}\n\t * @protected\n\t */\n\tthis.div_wrapper = div_wrapper\n\t/**\n\t * Whether to display the download panel\n\t * @type {boolean}\n\t * @private\n\t */\n\tthis._display_download = options.display_download || false\n\t/**\n\t * Div container for chart download\n\t * @type {Element}\n\t * @private\n\t */\n\tthis._download_chart_container = undefined\n\t/**\n\t * Div inside the div_wrapper, that just wraps the drawing\n\t * @type {Element}\n\t * @protected\n\t */\n\tthis.plot_container = undefined\n\t/**\n\t * Whether to display the control panel\n\t * @type {boolean}\n\t * @private\n\t */\n\t this._display_control_panel = options.display_control_panel || false\n\t/**\n\t * Div container for user controls\n\t * Used freely by each subclass\n\t * @type {Element}\n\t * @protected\n\t */\n\tthis.controls_container = undefined\n}\n\n/**\n * Amount of created charts\n * @type {number}\n * @static\n * @private\n */\nchart_wrapper._n_charts_created = 0;\n\n/**\n * Get a string representing the ID of the chart\n * @returns {string} the id as a string\n *          (`'chart1'`, `'chart2'`, ...)\n */\nchart_wrapper.prototype.id_string = function () {\n\treturn `chart${this.id}`\n}\n\n/**\n * Render the chart\n *\n * Empties the div wrapper and resets properties\n *\n * Subclasses must call this method at the top\n * of their own implementation\n * @name chart_wrapper#render\n * @function\n * @public\n */\nchart_wrapper.prototype.render = function () {\n\t// Remove all children in the div_wrapper\n\tthis.div_wrapper.replaceChildren()\n\n\t// Create the div for wrapping the plot\n\tthis.render_plot()\n\n\t// Create the div for the control panel\n\tif (this._display_control_panel) {\n\t\tthis.render_control_panel()\n\t}\n\n\t// Create the chart download section\n\tif (this._display_download) {\n\t\tthis._render_download_panel()\n\t}\n}\n\n/**\n * Render the download panel to the DOM\n * @function\n * @private\n * @name chart_wrapper#_render_download_panel\n */\nchart_wrapper.prototype._render_download_panel = function () {\n\tconst supported_formats = this.get_supported_export_formats()\n\tif (supported_formats.length) {\n\t\tthis.download_chart_container = common.create_dom_element({\n\t\t\telement_type: 'div',\n\t\t\tid: `${this.id_string()}_download_chart_container`,\n\t\t\tclass_name: 'o-purple download_chart_container',\n\t\t\t// style: {\n\t\t\t// \t'display': 'flex',\n\t\t\t// \t'flex-direction': 'row',\n\t\t\t// \t'justify-content': 'center',\n\t\t\t// },\n\t\t\tparent: this.div_wrapper,\n\t\t})\n\t\tconst format_select = common.create_dom_element({\n\t\t\telement_type\t: 'select',\n\t\t\tid\t\t\t\t: `${this.id_string()}_chart_export_format`,\n\t\t\tclass_name\t\t: 'chart_format_select',\n\t\t\t// style\t\t: {\n\t\t\t// \t'width'\t\t: '75%',\n\t\t\t// },\n\t\t\tparent\t\t\t: this.download_chart_container,\n\t\t\t// TODO: add ARIA attributes?\n\t\t})\n\t\tfor (const format of supported_formats) {\n\t\t\tcommon.create_dom_element({\n\t\t\t\telement_type\t: 'option',\n\t\t\t\tvalue\t\t\t: format,\n\t\t\t\ttext_content\t: format.toUpperCase(),\n\t\t\t\tparent\t\t\t: format_select\n\t\t\t})\n\t\t}\n\t\tconst chart_download_button = common.create_dom_element({\n\t\t\telement_type\t: 'input',\n\t\t\ttype\t\t\t: 'button',\n\t\t\tclass_name\t\t: 'btn primary button_download chart',\n\t\t\tvalue\t\t\t: tstring.download || 'Download',\n\t\t\t// style\t\t: {\n\t\t\t// \t'width'\t\t: '25%',\n\t\t\t// },\n\t\t\tparent\t\t\t: this.download_chart_container\n\t\t})\n\t\tchart_download_button.addEventListener('click', () => {\n\t\t\tthis.download_chart(format_select.value)\n\t\t})\n\t}\n}\n\n/**\n * Render the plot to the DOM\n *\n * Subclasses should override this method and make\n * use of the plot container\n * @function\n * @protected\n * @name chart_wrapper#render_plot\n */\nchart_wrapper.prototype.render_plot = function () {\n\tthis.plot_container = common.create_dom_element({\n\t\telement_type: 'div',\n\t\tid: `${this.id_string()}_plot_container`,\n\t\tclass_name: 'o-purple plot_container',\n\t\tparent: this.div_wrapper,\n\t})\n}\n\n/**\n * Render the control panel to the DOM\n *\n * Subclasses should override this method and make\n * use of the controls container\n * @function\n * @protected\n * @name chart_wrapper#render_control_panel\n */\nchart_wrapper.prototype.render_control_panel = function () {\n\tthis.controls_container = common.create_dom_element({\n\t\telement_type\t: 'div',\n\t\tid\t\t\t\t: `${this.id_string()}_control_panel`,\n\t\tclass_name\t\t: 'o-green control_panel',\n\t\tparent\t\t\t: this.div_wrapper\n\t})\n}\n\n/**\n * Download the chart as an image\n *\n * For each supported format in the subclass,\n * @see chart_wrapper#get_supported_export_formats\n * the subclass must implement a method called\n * `download_chart_as_<format>`\n * @param {string} format the image format\n * @function\n * @abstract\n * @name chart_wrapper#download_chart\n */\nchart_wrapper.prototype.download_chart = function (format) {\n\t/**\n\t * File name for the chart\n\t * @type {string}\n\t */\n\tconst filename = `${DEFAULT_CHART_NAME}.${format}`\n\t/**\n\t * Function name for downloading with the particular format\n\t * @type {string}\n\t */\n\tconst download_func_name = `download_chart_as_${format}`\n\tif (this[download_func_name] === undefined) {\n\t\tthrow new Error(`${download_func_name} is not implemented!`)\n\t}\n\tthis[download_func_name](filename)\n}\n\n/**\n * Get the supported chart export formats\n *\n * Subclasses must return their own supported formats, if any, e.g.,\n * `['png', 'jpg', 'eps']`. If no format is supported, there is no\n * need to override this method.\n * @function\n * @returns {string[]} the supported formats\n * @name chart_wrapper#get_supported_export_formats\n */\nchart_wrapper.prototype.get_supported_export_formats = function () {\n\treturn []\n}","\"use strict\";\n\nimport { chart_wrapper } from \"../chart-wrapper\";\n\n/**\n * D3 chart wrapper class\n * \n * Appends an `svg` tag to the provided div.\n * \n * Subclasses MUST specify the viewBox of the svg, so that it responds to window resizing\n * The created svg tag has width=100%, spanning the width of the parent element. Subclasses\n * can alter this behavior by modifying the svg after the superclass `render_plot` method has been\n * called\n * @param {Element} div_wrapper the div containing the chart\n * @param {Object} options configuration options\n * @param {boolean} options.display_download whether to display the download panel (default `true`)\n * @param {boolean} options.display_control_panel whether to display the control panel (default `true`)\n * @class\n * @abstract\n * @extends chart_wrapper\n */\nexport function d3_chart_wrapper(div_wrapper, options) {\n\tif (this.constructor === d3_chart_wrapper) {\n\t\tthrow new Error(\"Abstract class 'd3_chart_wrapper' cannot be instantiated\")\n\t}\n\tchart_wrapper.call(this, div_wrapper, options)\n\t/**\n\t * D3 selection object for the root `svg` tag\n\t * @protected\n\t */\n\tthis.svg = undefined\n\n}\n// Set prototype chain\nObject.setPrototypeOf(d3_chart_wrapper.prototype, chart_wrapper.prototype)\n\n/**\n * Render the plot to the DOM\n * \n * Subclasses must call this method at the top\n * of their own implementation. Then, they can\n * make use of the svg d3.selection object\n * @function\n * @protected\n * @name chart_wrapper#render_plot\n */\nd3_chart_wrapper.prototype.render_plot = function () {\n\tchart_wrapper.prototype.render_plot.call(this)\n\n\tthis.svg = d3.select(this.plot_container)\n\t\t.append('svg')\n\t\t// When drawing SVG to canvas with an `Image`, if we don't add version and xmlns the `Image` will never load :(\n\t\t.attr('version', '1.1')\n\t\t.attr('xmlns', 'http://www.w3.org/2000/svg')\n\t\t.attr('width', '100%')\n}\n\n/**\n * Get the supported chart export formats\n * @function\n * @returns {string[]} the supported formats\n * @name d3_chart_wrapper#get_supported_export_formats\n */\nd3_chart_wrapper.prototype.get_supported_export_formats = function () {\n\treturn ['svg']\n}\n\n/**\n * Download the chart as svg\n * @param {string} filename the name of the file\n * @function\n * @name d3_chart_wrapper#_download_chart_as_svg\n */\nd3_chart_wrapper.prototype.download_chart_as_svg = function (filename) {\n\tconst svg_data = this.svg.node().outerHTML\n\tconst svg_blob = new Blob([svg_data], { type: \"image/svg+xml;charset=utf-8\" })\n\tconst url = URL.createObjectURL(svg_blob)\n\t/**\n\t * Temporary link\n\t * @type {Element}\n\t */\n\tconst tmpLink = common.create_dom_element({\n\t\telement_type: 'a',\n\t\thref: url,\n\t})\n\ttmpLink.setAttribute('download', filename)\n\ttmpLink.click()\n\ttmpLink.remove()\n\tURL.revokeObjectURL(url)\n}","/**\n * Toggle visibility of a d3 selection element\n * @param {d3.selection} element the elememt\n */\nexport function toggle_visibility(element) {\n\tif (element.attr('opacity') == 0) {\n\t\telement.transition().attr('opacity', 1)\n\t} else {\n\t\telement.transition().attr('opacity', 0)\n\t}\n}\n\n/**\n * Get an array of values, evenly spaced over an\n * interval\n * \n * https://gist.github.com/davebiagioni/1ac21feb1c2db04be4e6\n * @param {number} start start value\n * @param {number} stop stop value\n * @param {number} nsteps amount of steps\n * @returns {number[]} the values\n */\nexport function linspace(start, stop, nsteps){\n\tconst delta = (stop-start)/(nsteps-1)\n\treturn d3.range(nsteps).map((i) => start+i*delta)\n}\n\n/**\n * Map from name to d3 curve\n * https://github.com/d3/d3/blob/main/API.md#curves\n * @type {Object.<string, d3.curve>}\n */\nexport const CURVES = {\n\t// cubic basis spline, repeating the end points\n\t'Basis': d3.curveBasis,\n\t// a closed cubic basis spline\n\t'Basis closed': d3.curveBasisClosed,\n\t// a cubic basis spline\n\t'Basis open': d3.curveBasisOpen,\n\t// a straightened cubic basis spline (works only with d3.line, not d3.area!)\n\t'Bundle': d3.curveBundle,\n\t// a cubic Bézier spline with horizontal tangents\n\t'Bump X': d3.curveBumpX,\n\t// a cubic Bézier spline with vertical tangents\n\t'Bump Y': d3.curveBumpY,\n\t// a cubic cardinal spline, with one-sided difference at each end\n\t'Cardinal': d3.curveCardinal,\n\t// a closed cubic cardinal spline\n\t'Cardinal closed': d3.curveCardinalClosed,\n\t// a cubic cardinal spline\n\t'Cardinal open': d3.curveCardinalOpen,\n\t// a cubic Catmull–Rom spline, with one-sided difference at each end\n\t'Catmull-Rom': d3.curveCatmullRom,\n\t// a closed cubic Catmull–Rom spline\n\t'Catmull-Rom closed': d3.curveCatmullRomClosed,\n\t// a cubic Catmull–Rom spline\n\t'Catmull-Rom open': d3.curveCatmullRomOpen,\n\t// a polyline\n\t'Linear': d3.curveLinear,\n\t// a closed polyline.\n\t'Linear closed': d3.curveLinearClosed,\n\t// a cubic spline that, given monotonicity in x, preserves it in y\n\t'Monotone X': d3.curveMonotoneX,\n\t// a cubic spline that, given monotonicity in y, preserves it in x\n\t'Monotone Y': d3.curveMonotoneY,\n\t// a natural cubic spline\n\t'Natural': d3.curveNatural,\n\t// a piecewise constant function\n\t'Step': d3.curveStep,\n\t// a piecewise constant function\n\t'Step after': d3.curveStepAfter,\n\t// a piecewise constant function\n\t'Step before': d3.curveStepBefore,\n}\n","/**\n * Implements methods for computing the number of\n * bins based on the data values\n * \n * Each method takes an array of data values as input\n * and outputs the number of bins\n * @class\n */\nexport function compute_n_bins() {}\n\n/**\n * Compute number of bins with the square root rule\n * @param {number[]} values the datapoints\n * @returns {number} the number of bins \n */\ncompute_n_bins.sqrt = function (values) {\n\treturn Math.ceil(Math.sqrt(values.length))\n}\n\n/**\n * Compute number of bins with the Sturges rule\n * @param {number[]} values the datapoints\n * @returns {number} the number of bins \n */\ncompute_n_bins.sturges = function (values) {\n\treturn Math.ceil(Math.log2(values.length)) + 1\n}\n\n/**\n * Compute number of bins with the Rice rule\n * @param {number[]} values the datapoints\n * @returns {number} the number of bins \n */\ncompute_n_bins.rice = function (values) {\n\treturn Math.ceil(2*Math.pow(values.length, 1/3))\n}\n\n/**\n * Compute number of bins with Doane's formula\n * \n * @param {number[]} values the datapoints\n * @returns {number} the number of bins \n */\ncompute_n_bins.doane = function (values) {\n\tconst n = values.length\n\tif (n < 2) {\n\t\tthrow new Error(\"Doane's rule needs at least 2 datapoints\")\n\t}\n\tconst sigma = Math.sqrt(6*(n-2)/((n+1)*(n+3)))\n\tconst std = d3.deviation(values)\n\tconst mean = d3.mean(values)\n\tconst sum = d3.sum(values)\n\t// The adjusted Fisher-Pearson skewness coefficient\n\t// https://www.itl.nist.gov/div898/software/dataplot/refman2/auxillar/skewness.htm\n\tconst skew = (Math.sqrt(n*(n+1))/(n-2))*((sum-n*mean)/(n*Math.pow(std, 3)))\n\treturn 1 + Math.ceil(Math.log2(n)) + Math.ceil(Math.log2(1+Math.abs(skew)/sigma))\n}\n\n/**\n * Compute number of bins with Scott's normal\n * reference rule\n * @param {number[]} values the datapoints\n * @returns {number} the number of bins \n */\ncompute_n_bins.scott = function (values) {\n\tif (values.length < 2) {\n\t\tthrow new Error(\n\t\t\t\"Cannot compute standard deviation of an array with less than 2 values\"\n\t\t)\n\t}\n\treturn Math.ceil(\n\t\t(d3.max(values)-d3.min(values))*Math.pow(values.length, 1/3)/(3.49*d3.deviation(values))\n\t)\n}\n\n/**\n * Compute number of bins with Freedman-Diaconis' choice\n * @param {number[]} values the datapoints\n * @returns {number} the number of bins \n */\ncompute_n_bins.freedman_diaconis = function (values) {\n\tconst quartile3 = d3.quantile(values, 0.75)\n\tconst quartile1 = d3.quantile(values, 0.25)\n\tconst iqr =  quartile3 - quartile1\n\tif (quartile1 === quartile3) {\n\t\tthrow new Error(\"IQR is 0!\")\n\t}\n\treturn Math.ceil(\n\t\t(d3.max(values)-d3.min(values))*Math.pow(values.length, 1/3)/(2*iqr)\n\t)\n}\n","/**\n * Get a deep copy of an object\n * @param {Object} obj the object\n * @returns a deep copy of the object\n */\nexport function deepcopy(obj) {\n\treturn JSON.parse(JSON.stringify(obj))\n}\n\n/**\n * Insert a dom element after another\n * @param {Eleemnt} new_node the new node \n * @param {Element} existing_node the one to add after of\n */\nexport function insert_after(new_node, existing_node) {\n\texisting_node.parentNode.insertBefore(new_node, existing_node.nextSibling);\n}\n\n/**\n * Check if arrays are equal\n * @param {any[][]} arrs the arrays to compare\n * @return {boolean} `true` if they are equal,\n * \t\t   `false` otherwise\n */\nexport function array_equal(...arrs) {\n\tif (!arrs.length) {\n\t\tthrow new Error(\"There are no input arrays\")\n\t}\n\tconst size = arrs[0].length\n\tfor (const arr of arrs.slice(1)) {\n\t\tif (arr.length !== size) {\n\t\t\treturn false\n\t\t}\n\t}\n\tfor (let i = 0; i < size; i++) {\n\t\tconst value = arrs[0][i]\n\t\tfor (const arr of arrs.slice(1)) {\n\t\t\tif (arr[i] !== value) {\n\t\t\t\treturn false\n\t\t\t}\n\t\t}\n\t}\n\treturn true\n}","\"use strict\";\n\nimport { d3_chart_wrapper } from \"./d3-chart-wrapper\";\nimport { COLOR_PALETTE } from \"../chart-wrapper\";\nimport { toggle_visibility, linspace, CURVES } from \"./utils\";\nimport { compute_n_bins } from \"../compute-n-bins\";\nimport { array_equal, deepcopy, insert_after } from \"../utils\"\n\n\n/**\n * CSS style for the tooltip\n * @type {Object.<string, string | number>}\n */\nconst TOOLTIP_STYLE = {\n\t'text-align': 'left',\n\t'padding': '0.7em',\n\t'padding-left': '0.8em',\n\t'font-size': '0.9em',\n\t'display': 'none',\n}\n\n/**\n * Default flex gap\n * @type {string}\n */\nconst DEFAULT_FLEX_GAP = '1em'\n/**\n * Default flex gap (bif)\n * @type {string}\n */\nconst DEFAULT_FLEX_GAP_BIG = '3em'\n/**\n * Default margin\n * @type {string}\n */\nconst DEFAULT_MARGIN = '0.7em'\n/**\n * Default margin (big)\n * @type {string}\n */\nconst DEFAULT_MARGIN_BIG = '1em'\n\n/**\n * Name of the key change event\n * @type {string}\n */\nconst KEY_CHANGE_EVENT_NAME = 'ch_key_change'\n/**\n * Key change event\n * @type {Event}\n */\nconst KEY_CHANGE_EVENT = new Event(KEY_CHANGE_EVENT_NAME)\n/**\n * Class name for key change listeners\n * @type {string}\n */\nconst KEY_CHANGE_LISTENER_CLASS_NAME = `${KEY_CHANGE_EVENT_NAME}_listener`\n\n\n/**\n * TODO: make a superclass (in the middle of this and d3_chart_wrapper) called xy-chart-wrapper\n * which manages the axes, grid, and so on. This will be useful if we add other charts that make\n * use of x and y axis\n *\n * Boxplot + violin chart wrapper\n *\n * Inspired in:\n * - http://bl.ocks.org/asielen/d15a4f16fa618273e10f,\n * - https://d3-graph-gallery.com/graph/violin_basicHist.html,\n * - https://d3-graph-gallery.com/graph/boxplot_show_individual_points.html\n *\n * @param {Element} div_wrapper the div to work in\n * @param {{key: string[], values: number[]}[]} data the input data: an array of objects\n *        with key (array of components, from general to specific) and values (the datapoints)\n *        (KEY COMPONENTS MUST NOT INCLUDE `'_^PoT3sRanaCantora_'`, or things WILL break)\n * @param {string[]} key_titles the title for each key component\n * @param {Object} options configuration options\n * @param {boolean} options.display_download whether to display the download panel (default `false`)\n * @param {boolean} options.display_control_panel whether to display the control panel (default `false`)\n * @param {boolean} options.sort_xaxis whether to sort the xaxis (default `false`)\n * @param {string} options.ylabel the y-label (default `null`)\n * @param {boolean} options.overflow whether to go beyond the width of the plot container (default `false`)\n * @param {number} options.xticklabel_angle the angle (in degrees) for the xtick labels (default `0`)\n * @class\n * @extends d3_chart_wrapper\n */\nexport function boxvio_chart_wrapper(div_wrapper, data, key_titles, options) {\n\td3_chart_wrapper.call(this, div_wrapper, options)\n\t/**\n\t * Whether to go beyond the width of the plot container\n\t * @type {boolean}\n\t */\n\tthis._overflow = options.overflow || false\n\tconst sort_xaxis = options.sort_xaxis || false\n\tif (!data.length) {\n\t\tthrow new Error(\"Data array is empty\")\n\t}\n\t/**\n\t * Data: key (general to specific components), index, values,\n\t * boxplot metrics, outliers, extent (min and max)\n\t * @type {{\n\t *  key: string[],\n\t *  index: number\n\t *  values: number[],\n\t *  metrics: {\n\t *      max: number,\n\t *      upper_fence: number,\n\t *      quartile3: number,\n\t *      median: number,\n\t *      mean: number,\n\t *      iqr: number,\n\t *      quartile1: number,\n\t *      lower_fence: number,\n\t *      min: number\n\t *  },\n\t *  outliers: number[],\n\t *  extent: [number, number]\n\t * }[]}\n\t * @private\n\t */\n\tthis._data = sort_xaxis\n\t\t\t\t ? data.sort((a, b) => a.key.join().localeCompare(b.key.join()))\n\t\t\t\t : data\n\tfor (const [i, ele] of this._data.entries()) {\n\t\tele.metrics = calc_metrics(ele.values)\n\t\tele.outliers = ele.values.filter(\n\t\t\t(v) => v < ele.metrics.lower_fence || v > ele.metrics.upper_fence\n\t\t)\n\t\tele.extent = d3.extent(ele.values)\n\t}\n\t/**\n\t * Overall Maximum and minimum of the input data\n\t * @type {[number, number]}\n\t */\n\tthis._data_extent = d3.extent(this._data.map((ele) => ele.extent).flat())\n\t/**\n\t * Existing keys as strings\n\t * @type {string[]}\n\t * @private\n\t */\n\tthis._key_strings = this._data.map((ele) => join_key(ele.key))\n\t/**\n\t * Number of components of the key\n\t * @type {number}\n\t * @private\n\t */\n\tthis._key_size = data[0].key.length\n\t/**\n\t * Title for each key component\n\t * @type {string[]}\n\t * @private\n\t */\n\tthis._key_titles = key_titles\n\t/**\n\t * Colors\n\t * @type {string[]}\n\t * @private\n\t */\n\tthis._colors = this._data.map((_, i) => COLOR_PALETTE[i % COLOR_PALETTE.length])\n\t/**\n\t * The label for the y axis\n\t * @type {string}\n\t * @private\n\t */\n\tthis._ylabel = options.ylabel || null\n\t/**\n\t * Padding for the y axis, to account for the label and ticks\n\t * @type {number}\n\t */\n\tthis.yaxis_padding = this._ylabel ? 62 : 35;\n\t/**\n\t * Full width of svg\n\t * @type {number}\n\t */\n\tthis._full_width = this._data.length < 150\n\t\t? 330.664701211*Math.sqrt(this._data.length) - 170.664701211 + this.yaxis_padding\n\t\t: 26*this._data.length + this.yaxis_padding\n\t/**\n\t * Full height of svg\n\t * @type {number}\n\t */\n\tthis._full_height = 453\n\t/**\n\t * Non-graphic components of the chart: setting, scales,\n\t * axis generators, spacing, etc.\n\t * @private\n\t * @type {{\n\t *  margin: {\n\t *      top: number,\n\t *      right: number,\n\t *      bottom: number,\n\t *      left: number\n\t *  },\n\t *  width: number,\n\t *  height: number,\n\t *  yscale: d3.scaleLinear,\n\t *  yticks_division: number,\n\t *  yaxis: d3.axisGenerator,\n\t *  violin_scale: {initial: number, value: number},\n\t *  box_scale: {initial: number, value: number},\n\t *  xscale: d3.scaleBand,\n\t *  xaxis: d3.axisGenerator,\n\t *  xticklabel_angle: number,\n\t *  n_bins: {initial: number, value: number}[],\n\t *  histogram: d3.binGenerator[],\n\t *  bins: d3.Bin[][],\n\t *  supported_curves: string[],\n\t *  violin_curve: string\n\t * }}\n\t */\n\tthis._chart = {}\n\tthis._chart.margin = { top: 15, right: 4, bottom: 61, left: this.yaxis_padding }\n\tthis._chart.width = this._full_width - this._chart.margin.left - this._chart.margin.right\n\tthis._chart.height = this._full_height - this._chart.margin.top - this._chart.margin.bottom\n\tthis._chart.yscale = d3.scaleLinear()\n\t\t.range([this._chart.height, 0])\n\t\t.domain(this._data_extent)\n\t\t.clamp(true)  // when input outside of domain, its output is clamped to range\n\tthis._chart.yticks_division = 2  // TODO: make this part of the input options object\n\t// TODO: make number of decimals and number of ticks part of input options object\n\tthis._chart.yaxis = d3.axisLeft(this._chart.yscale)\n\t\t.tickFormat((d, i) => i % this._chart.yticks_division ? '' : d.toFixed(1))\n\t\t.ticks(19)\n\tthis._chart.violin_scale = {initial: 0.8, value: 0.8}\n\tthis._chart.box_scale = {initial: 0.3, value: 0.3}\n\tthis._chart.xscale = d3.scaleBand()\n\t\t.domain(this._key_strings)\n\t\t.range([0, this._chart.width])\n\t\t// .padding(1-this._chart.violin_scale)     // This is important: it is the space between 2 groups. 0 means no padding. 1 is the maximum.\n\tthis._chart.xaxis = d3.axisBottom(this._chart.xscale)\n\t\t.tickFormat((d) => split_key(d)[1])\n\tthis._chart.xticklabel_angle = options.xticklabel_angle || 0\n\tthis._chart.n_bins = this._data.map((ele) => {\n\t\tconst initial_value = compute_n_bins.sturges(ele.values)\n\t\treturn {\n\t\t\tinitial: initial_value,\n\t\t\tvalue: initial_value,\n\t\t}\n\t})\n\tthis._chart.histogram = this._data.map((ele, i) => {\n\t\treturn d3.bin().domain(ele.extent)\n\t\t\t.thresholds(\n\t\t\t\tlinspace(ele.extent[0], ele.extent[1], this._chart.n_bins[i].value+1)\n\t\t\t)\n\t})\n\tthis._chart.bins = this._data.map((ele, i) => {\n\t\treturn this._chart.histogram[i](ele.values)\n\t})\n\tthis._chart.supported_curves = [\n\t\t'Basis', 'Bump Y', 'Cardinal', 'Catmull-Rom', 'Linear',\n\t\t'Monotone Y', 'Natural', 'Step'\n\t]\n\tthis._chart.violin_curve = CURVES[this._chart.supported_curves[0]]\n\t/**\n\t * Graphic components of the chart\n\t * @private\n\t * @type {{\n\t *  root_g: d3.selection,\n\t *  xaxwl_g: d3.selection\n\t *  xaxis_g: d3.selection,\n\t *  yaxwl_g: d3.selection,\n\t *  yaxis_g: d3.selection,\n\t *  key2_dividers_g: d3.selection,\n\t *  violins_g: d3.selection,\n\t *  violins: d3.selection[],\n\t *  boxes_g: d3.selection,\n\t *  outliers: d3.selection[],\n\t *  tooltip_div: d3.selection\n\t * }}\n\t */\n\tthis._graphics = {\n\t\t// Root g tag (translated to account for the margins)\n\t\troot_g: null,\n\t\t// g tag for the x-axis and label\n\t\tyaxwl_g: null,\n\t\t// g tag for the x-axis\n\t\txaxis_g: null,\n\t\t// g tag for the y-axis and label\n\t\tyaxwl_g: null,\n\t\t// g tag for the y-axis\n\t\tyaxis_g: null,\n\t\t// g tag for the class dividers\n\t\tcdividers_g: null,\n\t\t// g tag grouping all violins\n\t\tviolins_g: null,\n\t\t// individual g tag for each violin\n\t\tviolins: [],\n\t\t// g tag grouping all boxes\n\t\tboxes_g: null,\n\t\t// per group: g tag grouping all outliers of each box\n\t\toutliers: [],\n\t\t// div tag of the tooltip\n\t\ttooltip_div: null,\n\t}\n\t/**\n\t * Control panel things\n\t * TODO: if modifying a particular violin gets slow\n\t * because we have to fetch it based on key, we can\n\t * keep track of the selected one so that we only fetch\n\t * if when the selected key changes. Or something like that\n\t * @private\n\t * @type {{\n\t *  max_bins_multiplier: number,\n\t *  selected_index: number\n\t * }}\n\t */\n\tthis._controls = {}\n\tthis._controls.max_bins_multiplier = 3\n\tthis._controls.selected_index = 0\n}\n// Set prototype chain\nObject.setPrototypeOf(boxvio_chart_wrapper.prototype, d3_chart_wrapper.prototype)\n\n/**\n * Query the data given a key template\n * @param {string[]} key_tpl the key template. Parts will be matched,\n * `null` counts as wildcard\n * @return {{\n *  key: string[],\n *  values: number[],\n *  metrics: {\n *      max: number,\n *      upper_fence: number,\n *      quartile3: number,\n *      median: number,\n *      mean: number,\n *      iqr: number,\n *      quartile1: number,\n *      lower_fence: number,\n *      min: number\n *  },\n *  outliers: number[],\n *  extent: [number, number]\n * }[]} the filtered data\n */\nboxvio_chart_wrapper.prototype._query_data = function (key_tpl) {\n\tif (key_tpl.length !== this._key_size) {\n\t\tthrow new Error(\"Key template is of different size than the plot keys\")\n\t}\n\treturn this._data.filter((ele) => {\n\t\tconst key = ele.key\n\t\tfor (let i = 0; i < key.length; i++) {\n\t\t\tif (key_tpl[i] && key_tpl[i] !== key[i]) {\n\t\t\t\treturn false\n\t\t\t}\n\t\t}\n\t\treturn true\n\t})\n}\n\n/**\n * Get key templates up to a key number\n * @param {number} i the key number. If 1, all existing keys\n *        will be returned. If 2, all existing keys with a wildcard in\n *        the last component will be returned. If 3, all existing keys\n *        with a wildcard in the last and second-to-last component will\n *        be returned.\n * @returns {string[][]} the templates\n */\nboxvio_chart_wrapper.prototype._get_key_templates = function (i) {\n\tif (i < 1 || i > this._key_size) {\n\t\tthrow new Error(`Invalid key number ${i}`)\n\t}\n\t// Convert to real index\n\ti = this._key_size - i\n\tconst templates_wd = this._data.map((ele) => {\n\t\treturn deepcopy(ele.key.slice(0,i+1)).concat(Array(this._key_size-i-1).fill(null))\n\t})\n\tif (!templates_wd.length) return templates_wd\n\t// Remove duplicates\n\tconst templates = [templates_wd[0]]\n\tlet tmp_template = templates_wd[0]\n\tfor (const template of templates_wd.slice(1)) {\n\t\tif (!array_equal(tmp_template, template)) {\n\t\t\ttemplates.push(template)\n\t\t\ttmp_template = template\n\t\t}\n\t}\n\treturn templates\n}\n\n/**\n * Get the possible values of the next key component, given a partial key.\n * E.g., if there are 4 components, and you provide the two leftmost ones\n * in the partial key, possible values for the third leftmost one will be\n * given\n * @param {string[]} pkey partial key\n * @returns {string[]} possible values for the next key component\n */\nboxvio_chart_wrapper.prototype._get_next_key_component_values = function (pkey) {\n\tconst psize = pkey.length\n\tif (psize >= this._key_size) {\n\t\tthrow new Error(`Input key ${pkey} is longer than the data keys`)\n\t}\n\tconst key_tpl = pkey.concat(Array(this._key_size-psize).fill(null))\n\tconst values_wd = this._query_data(key_tpl).map((ele) => ele.key[psize])\n\tif (!values_wd.length) return values_wd\n\tconst values = [values_wd[0]]\n\tlet current_value = values_wd[0]\n\tfor (const value of values_wd.slice(1)) {\n\t\tif (value !== current_value) {\n\t\t\tvalues.push(value)\n\t\t\tcurrent_value = value\n\t\t}\n\t}\n\treturn values\n}\n\n/**\n * Get the index of a key\n * @param {string[]} key the key\n * @returns the index of the key\n */\nboxvio_chart_wrapper.prototype.get_index_of_key = function (key) {\n\tconst i = this._data.findIndex((ele) => ele.key.join() === key.join())\n\tif (i === -1) {\n\t\tthrow new Error(`Key ${key} was not found in data`)\n\t}\n\treturn i\n}\n\n/**\n * Set the scale for the violins\n * @function\n * @param {number} scale the scale [0, 1]\n * @name boxvio_chart_wrapper#set_violin_scale\n */\nboxvio_chart_wrapper.prototype.set_violin_scale = function (scale) {\n\tthis._chart.violin_scale.value = scale\n\t// Remove the violin graphics, only leaving its root g tag (violins_g)\n\tthis._graphics.violins_g.selectAll('*').remove()\n\tthis._render_violins(true)\n}\n\n/**\n * Set the number of bins for a particular violin\n *\n * Updates the chart accordingly\n * @param {number} i the index of the violin\n * @param {number} n_bins number of bins\n * @name boxvio_chart_wrapper#set_n_bins\n */\nboxvio_chart_wrapper.prototype.set_n_bins = function (i, n_bins) {\n\tconst chart = this._chart\n\tconst extent = this._data[i].extent\n\tchart.n_bins[i].value = n_bins\n\tchart.histogram[i].thresholds(\n\t\tlinspace(extent[0], extent[1], n_bins+1)\n\t)\n\tchart.bins[i] = chart.histogram[i](this._data[i].values)\n\t// Delete the oath of the existing violin and redraw\n\tthis._graphics.violins[i].selectAll('*').remove()\n\tthis._render_violin(i)\n}\n\n/**\n * Set the curve for the violins\n *\n * Updates the chart accordingly\n * @param {string} curve_name name of the curve\n * @name boxvio_chart_wrapper#set_violin_curve\n */\nboxvio_chart_wrapper.prototype.set_violin_curve = function (curve_name) {\n\tthis._chart.violin_curve = CURVES[curve_name]\n\t// Remove the violin graphics, only leaving its root g tag (violins_g)\n\tthis._graphics.violins_g.selectAll('*').remove()\n\tthis._render_violins(true)\n}\n\n/**\n * Set the scale for the boxes\n * @function\n * @param {number} scale the scale [0, 1]\n * @name boxvio_chart_wrapper#set_box_scale\n */\nboxvio_chart_wrapper.prototype.set_box_scale = function (scale) {\n\tthis._chart.box_scale.value = scale\n\t// Remove the box graphics, only leaving its root g tag (boxes_g)\n\tthis._graphics.boxes_g.selectAll('*').remove()\n\tthis._render_boxes(true)\n}\n\n/**\n * Render the plot\n * @function\n * @protected\n * @name boxvio_chart_wrapper#render_plot\n */\nboxvio_chart_wrapper.prototype.render_plot = function () {\n\td3_chart_wrapper.prototype.render_plot.call(this)\n\n\tif (this._overflow) {\n\t\tthis.svg.attr('width', null)\n\t\tthis.svg.attr('height', '500px')\n\t\tthis.plot_container.style = \"overflow: auto;\"\n\t}\n\n\t// Set viewBox of svg\n\tthis.svg.attr('viewBox', `0 0 ${this._full_width} ${this._full_height}`)\n\n\t// Hide tooltip when clicking in SVG\n\tthis.svg.on('click', (e) => {\n\t\te.stopPropagation()\n\t\tthis._hide_tooltip()\n\t})\n\n\t// Root g tag\n\tthis._graphics.root_g = this.svg.append('g')\n\t\t.attr('transform', `translate(${this._chart.margin.left},${this._chart.margin.top})`)\n\n\tthis._render_axis()\n\tthis._render_ygrid()\n\tif (this._key_size > 1) {\n\t\tthis._render_key2_dividers()\n\t}\n\tthis._render_violins()\n\tthis._render_boxes()\n\tthis._render_tooltip()\n\n}\n\n/**\n * Render the axis\n * @function\n * @private\n * @name boxvio_chart_wrapper#_render_axis\n */\nboxvio_chart_wrapper.prototype._render_axis = function () {\n\tconst g = this._graphics.root_g\n\t// Render X axis\n\tthis._graphics.xaxwl_g = g.append('g')\n\t\t.attr('transform', `translate(0,${this._chart.height})`)\n\tconst xaxwl_g = this._graphics.xaxwl_g\n\tthis._graphics.xaxis_g = xaxwl_g.append('g')\n\t\t.call(this._chart.xaxis)\n\tthis.apply_xticklabel_angle()\n\t// Render X axis label\n\txaxwl_g.append('text')\n\t\t.attr('text-anchor', 'middle')\n\t\t.attr('y', 50)\n\t\t.attr('x', this._chart.width / 2)\n\t\t.text(this._key_titles[this._key_titles.length-1])\n\n\t// Render y axis\n\tthis._graphics.yaxwl_g = g.append('g')\n\tconst yaxwl_g = this._graphics.yaxwl_g\n\tthis._graphics.yaxis_g = yaxwl_g.append('g')\n\t\t.call(this._chart.yaxis)\n\t// Render Y axis label\n\tyaxwl_g.append('text')\n\t\t.attr('text-anchor', 'middle')\n\t\t.attr('transform', 'rotate(-90)')\n\t\t.attr('y', -this._chart.margin.left + 20)\n\t\t.attr('x', -this._chart.height / 2)\n\t\t.text(this._ylabel)\n\n}\n\n/**\n * Apply an angle to the xtick labels\n * @function\n * @name boxvio_chart_wrapper#apply_xticklabel_angle\n */\nboxvio_chart_wrapper.prototype.apply_xticklabel_angle = function () {\n\tconst angle = this._chart.xticklabel_angle\n\tconst xaxis_g = this._graphics.xaxis_g\n\tif (angle < 10) {\n\t\txaxis_g.selectAll('text')\n\t\t\t.attr('text-anchor', 'middle')\n\t\t\t.attr(\"dy\", \"0.8em\")\n\t\t\t.attr(\"dx\", \"0\")\n\t\t\t.attr('transform', `rotate(${-this._chart.xticklabel_angle})`)\n\t} else {\n\t\txaxis_g.selectAll('text')\n\t\t\t.attr('text-anchor', 'end')\n\t\t\t.attr(\"dy\", `${-angle*angle*0.00006172839}em`)\n\t\t\t.attr(\"dx\", \"-0.9em\")\n\t\t\t.attr('transform',\n\t\t\t\t`rotate(${-this._chart.xticklabel_angle})`\n\t\t\t)\n\t\tif (angle < 50) {\n\t\t\txaxis_g.selectAll('text')\n\t\t\t\t.attr('dx', '-0.7em')\n\t\t}\n\t}\n}\n\n/**\n * Render the grid for the y-axis\n * @function\n * @private\n * @name boxvio_chart_wrapper#_render_ygrid\n */\nboxvio_chart_wrapper.prototype._render_ygrid = function () {\n\tconst ticks = this._graphics.yaxis_g.selectAll('g.tick')\n\tticks.append('line')\n\t\t.attr('x1', 0)\n\t\t.attr('y1', 0)\n\t\t.attr('x2', this._chart.width)\n\t\t.attr('y2', 0)\n\t\t.attr('stroke', (_, i) => i % 2 ? '#E0E0E0' : '#D1D1D1')\n\t\t.attr('stroke-width', (_, i) => i % 2 ? 0.5 : 0.8)\n\t\t.attr('class', (_, i) => i % 2 ? 'minor' : 'major')\n\t\t.attr('opacity', 0)  // disabled by default\n}\n\n/**\n * Apply a grid mode to the y axis\n * @param {'None' | 'Major' | 'Major + Minor'} mode the mode\n * @function\n * @name boxvio_chart_wrapper#apply_ygrid_mode\n */\nboxvio_chart_wrapper.prototype.apply_ygrid_mode = function (mode) {\n\tconst major_lines = this._graphics.yaxis_g.selectAll('g.tick line.major')\n\tconst major_opacity = major_lines.attr('opacity')\n\tconst minor_lines = this._graphics.yaxis_g.selectAll('g.tick line.minor')\n\tconst minor_opacity = minor_lines.attr('opacity')\n\tswitch (mode) {\n\t\tcase 'None':\n\t\t\tif (major_opacity == 1) {\n\t\t\t\ttoggle_visibility(major_lines)\n\t\t\t}\n\t\t\tif (minor_opacity == 1) {\n\t\t\t\ttoggle_visibility(minor_lines)\n\t\t\t}\n\t\t\tbreak\n\t\tcase 'Major':\n\t\t\tif (major_opacity == 0) {\n\t\t\t\ttoggle_visibility(major_lines)\n\t\t\t}\n\t\t\tif (minor_opacity == 1) {\n\t\t\t\ttoggle_visibility(minor_lines)\n\t\t\t}\n\t\t\tbreak\n\t\tcase 'Major + Minor':\n\t\t\tif (major_opacity == 0) {\n\t\t\t\ttoggle_visibility(major_lines)\n\t\t\t}\n\t\t\tif (minor_opacity == 0) {\n\t\t\t\ttoggle_visibility(minor_lines)\n\t\t\t}\n\t\t\tbreak\n\t\tdefault:\n\t\t\tthrow new Error(`Grid mode '${mode}' is not supported?`)\n\t}\n}\n\n/**\n * Render the dividers for key2\n * @function\n * @private\n * @name boxvio_chart_wrapper#_render_key2_dividers\n */\nboxvio_chart_wrapper.prototype._render_key2_dividers = function () {\n\tthis._graphics.key2_dividers_g = this._graphics.root_g.append('g')\n\tconst dividers_g = this._graphics.key2_dividers_g\n\tconst color = 'gray'\n\tconst key_tpls = this._get_key_templates(2)\n\n\tlet i = 0;\n\tfor (const [index, key_tpl] of key_tpls.entries()) {\n\t\tconst queried_data = this._query_data(key_tpl)\n\t\tconst x = this._chart.xscale(this._key_strings[i])\n\t\tconst divider_g = dividers_g.append('g')\n\t\t\t.attr('transform', `translate(${x},0)`)\n\t\tif (index !== 0) {\n\t\t\tdivider_g.append('line')\n\t\t\t\t.attr('x1', 0)\n\t\t\t\t.attr('y1', 0)\n\t\t\t\t.attr('x2', 0)\n\t\t\t\t.attr('y2', this._chart.height)\n\t\t\t\t.attr('stroke', color)\n\t\t\t\t.attr('stroke-width', 0.9)\n\t\t\t\t.attr('stroke-dasharray', this._chart.height/35)\n\t\t}\n\t\tdivider_g.append('text')\n\t\t\t.attr('text-anchor', 'end')\n\t\t\t.attr('transform', 'rotate(-90)')\n\t\t\t.attr('y', '1.3em')  // This is the horizontal axis now\n\t\t\t.attr('x', '-0.6em')  // This is the vertical axis now\n\t\t\t.attr('font-size', '0.8em')\n\t\t\t.attr('fill', color)\n\t\t\t.text(key_tpl[key_tpl.length-2])\n\t\t// Increase the index by the number of groups in the class\n\t\ti += queried_data.length\n\t}\n}\n\n/**\n * Render the violins\n * @function\n * @private\n * @param {boolean} is_g_ready whether the g tag for violins is\n *        set up (default: `false`)\n * @name boxvio_chart_wrapper#_render_violins\n */\nboxvio_chart_wrapper.prototype._render_violins = function (is_g_ready=false) {\n\tconst chart = this._chart\n\tconst g = this._graphics.root_g\n\n\t// Render\n\tif (!is_g_ready) {\n\t\tthis._graphics.violins_g = g.append('g')\n\t}\n\tconst violins_g = this._graphics.violins_g\n\tfor (const [i, key_string] of this._key_strings.entries()) {\n\t\tthis._graphics.violins[i] = violins_g.append('g')\n\t\t\t.attr('transform', `translate(${chart.xscale(key_string)},0)`)\n\t\tthis._render_violin(i)\n\t}\n\n}\n\n/**\n * Render a violin\n * @function\n * @private\n * @param {boolean} i the index of the violin\n * @name boxvio_chart_wrapper#_render_violins\n */\nboxvio_chart_wrapper.prototype._render_violin = function (i) {\n\tconst bins = this._chart.bins[i]\n\tconst violin_scale = this._chart.violin_scale.value\n\tconst bandwidth = this._chart.xscale.bandwidth()\n\tconst yscale = this._chart.yscale\n\tconst violin_curve = this._chart.violin_curve\n\n\t// Get the largest count in a bin as it will be maximum width\n\tconst max_count = d3.max(bins, (bin) => bin.length)\n\t// Make a linear scale to map bin counts to bandwidth\n\tconst x_num = d3.scaleLinear()\n\t\t.range([0, bandwidth])\n\t\t.domain([-max_count, max_count])\n\n\t// Only render violin if there is more than 1 datapoint (otherwise there are NaNs around)\n\tif (this._data[i].values.length > 1) {\n\t\tthis._graphics.violins[i]\n\t\t\t.append('path')\n\t\t\t.datum(bins)\n\t\t\t\t.style('stroke', 'gray')\n\t\t\t\t.style('stroke-width', 0.4)\n\t\t\t\t.style('fill', '#d2d2d2')\n\t\t\t\t.attr('d', d3.area()\n\t\t\t\t\t.x0((d) => x_num(-d.length*violin_scale))\n\t\t\t\t\t.x1((d) => x_num(d.length*violin_scale))\n\t\t\t\t\t.y((d) => yscale(d.x0))\n\t\t\t\t\t.curve(violin_curve)\n\t\t\t\t)\n\t}\n}\n\n/**\n * TODO: refactor\n * Render the boxes (including whiskers and outliers)\n * @function\n * @private\n * @param {boolean} is_g_ready whether the g tag for boxes is\n *        set up (default: `false`)\n * @name boxvio_chart_wrapper#_render_boxes\n */\nboxvio_chart_wrapper.prototype._render_boxes = function (is_g_ready=false) {\n\n\tconst chart = this._chart\n\tconst g = this._graphics.root_g\n\n\t// Draw\n\tif (!is_g_ready) {\n\t\tthis._graphics.boxes_g = g.append('g')\n\t}\n\tconst boxes = this._graphics.boxes_g\n\tconst bandwidth = chart.xscale.bandwidth()\n\tconst box_width = this._chart.box_scale.value * bandwidth\n\n\tconst whiskers_lw = 2\n\tconst median_lw = 3\n\n\t// Iterate over the groups\n\tfor (const [i, ele] of this._data.entries()) {\n\n\t\tconst metrics = ele.metrics\n\t\tconst color = this._colors[i]\n\t\tconst key = ele.key\n\n\t\tconst group_box = boxes.append('g')\n\t\t\t.attr('transform', `translate(${chart.xscale(join_key(key)) + bandwidth / 2},0)`)\n\n\t\t// Draw outliers\n\t\tthis._graphics.outliers[i] = group_box.append('g')\n\t\tconst outliers = this._graphics.outliers[i]\n\t\tfor (const outlier of ele.outliers) {\n\t\t\toutliers.append('circle')\n\t\t\t\t.attr('cx', 0)\n\t\t\t\t.attr('cy', chart.yscale(outlier))\n\t\t\t\t.attr('r', 4)\n\t\t\t\t.style('fill', color)\n\t\t\t\t.style('opacity', 0.7)\n\t\t}\n\n\t\t// Draw whiskers\n\t\tconst whiskers = group_box.append('g')\n\t\twhiskers.append('line')  // vertical line\n\t\t\t.attr('x1', 0)\n\t\t\t.attr('y1', chart.yscale(metrics.lower_fence))\n\t\t\t.attr('x2', 0)\n\t\t\t.attr('y2', chart.yscale(metrics.upper_fence))\n\t\t\t.attr('stroke', color)\n\t\t\t.attr('stroke-width', whiskers_lw)\n\t\twhiskers.append('line') // lower horizontal\n\t\t\t.attr('x1', -box_width / 2)\n\t\t\t.attr('y1', chart.yscale(metrics.lower_fence))\n\t\t\t.attr('x2', box_width / 2)\n\t\t\t.attr('y2', chart.yscale(metrics.lower_fence))\n\t\t\t.attr('stroke', color)\n\t\t\t.attr('stroke-width', whiskers_lw)\n\t\twhiskers.append('line') // upper horizontal\n\t\t\t.attr('x1', -box_width / 2)\n\t\t\t.attr('y1', chart.yscale(metrics.upper_fence))\n\t\t\t.attr('x2', box_width / 2)\n\t\t\t.attr('y2', chart.yscale(metrics.upper_fence))\n\t\t\t.attr('stroke', color)\n\t\t\t.attr('stroke-width', whiskers_lw)\n\n\t\t// Draw IQR box\n\t\tconst iqr = group_box.append('g')\n\t\t// Only draw rectangle if there is more than 1 datapoint (otherwise NaNs appear)\n\t\tif (ele.values.length > 1) {\n\t\t\tiqr.append('rect')  // iqr rect\n\t\t\t.attr('x', -box_width / 2)\n\t\t\t.attr('y', chart.yscale(metrics.quartile3))\n\t\t\t.attr('width', box_width)\n\t\t\t.attr('height', chart.yscale(metrics.quartile1) - chart.yscale(metrics.quartile3))\n\t\t\t.attr('fill', color)\n\t\t}\n\t\tiqr.append('line')  // median line\n\t\t\t.attr('x1', -box_width / 2)\n\t\t\t.attr('y1', chart.yscale(metrics.median))\n\t\t\t.attr('x2', box_width / 2)\n\t\t\t.attr('y2', chart.yscale(metrics.median))\n\t\t\t.attr('stroke', 'black')\n\t\t\t.attr('stroke-width', median_lw)\n\t\tconst circle = iqr.append('circle')  // median dot\n\t\t\t.attr('cx', 0)\n\t\t\t.attr('cy', chart.yscale(metrics.median))\n\t\t\t.attr('r', 4.5)\n\t\t\t.style('fill', 'white')\n\t\t\t.attr('stroke', 'black')\n\t\t\t.attr('stroke-width', 2)\n\t\t// Circle events for tooltip\n\t\tthis.tooltip_active = null;\n\t\tcircle.on('click', (e) => {\n\t\t\te.stopPropagation()\n\n\t\t\t// already displayed. Hide\n\t\t\t\tif (this.tooltip_active==i) {\n\t\t\t\t\tthis._hide_tooltip()\n\t\t\t\t\treturn\n\t\t\t\t}\n\n\t\t\t// hover set and fix\n\t\t\t\tthis.tooltip_hover(i)\n\t\t\t\tthis._graphics.tooltip_div.style('display', null)\n\t\t\t\tthis.tooltip_active = i\n\n\t\t\t// old\n\t\t\t// this._graphics.tooltip_div.style('display', null)\n\t\t\t// this.tooltip_hover(i)\n\t\t})\n\t\t// .on('mouseout', () => {\n\t\t// \tthis._graphics.tooltip_div.style('display', 'none')\n\t\t// })\n\t}\n\n}\n\n/**\n * Hide the tooltip\n * @function\n * @private\n * @name boxvio_chart_wrapper#_hide_tooltip\n */\nboxvio_chart_wrapper.prototype._hide_tooltip = function () {\n\tthis._graphics.tooltip_div.style('display', 'none')\n\tthis.tooltip_active = null\n}\n\n/**\n * Add the tooltip to the DOM\n * @function\n * @private\n * @name boxvio_chart_wrapper#_render_tooltip\n */\nboxvio_chart_wrapper.prototype._render_tooltip = function () {\n\tconst tooltip_element = common.create_dom_element({\n\t\telement_type\t: 'div',\n\t\tid\t\t\t\t: `${this.id_string()}_tooltip_div`,\n\t\tclass_name\t\t: 'o-red tooltip_div'\n\t})\n\tinsert_after(tooltip_element, this.plot_container)\n\tthis._graphics.tooltip_div = d3.select(tooltip_element)\n\tconst tooltip_div = this._graphics.tooltip_div\n\tfor (const [k, v] of Object.entries(TOOLTIP_STYLE)) {\n\t\ttooltip_div.style(k, v)\n\t}\n}\n\n/**\n * Set the tooltip to visible when we hover over\n * @param {number} i index of data\n * @function\n * @name boxvio_chart_wrapper#tooltip_hover\n */\nboxvio_chart_wrapper.prototype.tooltip_hover = function (i) {\n\tconst decimals = 2\n\tconst key = this._data[i].key\n\tconst values = this._data[i].values\n\tconst metrics = this._data[i].metrics\n\tconst tooltip_text = `<b>${key.join(', ')}</b>`\n\t\t+ '<span style=\"font-size: smaller;\">'\n\t\t+ `<br>${tstring.datapoints || 'Datapoints'}: ${values.length}`\n\t\t+ `<br>${tstring.mean || 'Mean'}: ${metrics.mean.toFixed(decimals)}`\n\t\t+ `<br>${tstring.max || 'Maximum'}: ${metrics.max.toFixed(decimals)}`\n\t\t+ `<br>${tstring.quantile || 'Quantile'}-75: ${metrics.quartile3.toFixed(decimals)}`\n\t\t+ `<br>${tstring.median || 'Median'}: ${metrics.median.toFixed(decimals)}`\n\t\t+ `<br>${tstring.quantile || 'Quantile'}-25: ${metrics.quartile1.toFixed(decimals)}`\n\t\t+ `<br>${tstring.min || 'Minimum'}: ${metrics.min.toFixed(decimals)}`\n\t\t+ '</span>'\n\tthis._graphics.tooltip_div\n\t\t.html(tooltip_text)\n}\n\n/**\n * Render the control panel\n * @function\n * @protected\n * @name boxvio_chart_wrapper#render_control_panel\n */\nboxvio_chart_wrapper.prototype.render_control_panel = function () {\n\td3_chart_wrapper.prototype.render_control_panel.call(this)\n\n\t// TODO: refactor the first three (together)\n\tconst upper_container = common.create_dom_element({\n\t\telement_type\t: 'div',\n\t\tclass_name\t\t: 'control_panel_item control_panel',\n\t\tparent\t\t\t: this.controls_container\n\t\t// style\t\t\t: {\n\t\t// \t'display': 'flex',\n\t\t// \t'direction': 'flex-row',\n\t\t// \t'justify-content': 'space-between',\n\t\t// \t'align-items': 'center',\n\t\t// }\n\t})\n\tthis._render_grid_select(upper_container)\n\tthis._render_xticklabel_angle_slider(upper_container)\n\tthis._render_violin_curve_selector(upper_container)\n\tthis._render_checkboxes()\n\tthis._render_scale_sliders()\n\tthis._render_key_selects()\n\tthis._render_n_bins_control()\n\n}\n\n/**\n * Render the selector for grid mode\n * @function\n * @private\n * @param {Element} container the container element\n * @name boxvio_chart_wrapper#_render_grid_select\n */\nboxvio_chart_wrapper.prototype._render_grid_select = function (container) {\n\tconst select_container = common.create_dom_element({\n\t\telement_type: 'div',\n\t\tparent: container,\n\t\t// style: {\n\t\t// \t'display': 'flex',\n\t\t// \t'gap': DEFAULT_FLEX_GAP,\n\t\t// },\n\t})\n\tconst grid_select_id = `${this.id_string()}_grid_select`\n\tconst grid_select_label = common.create_dom_element({\n\t\telement_type: 'label',\n\t\ttext_content: tstring.grid || 'Grid',\n\t\tparent: select_container,\n\t\tstyle: {'margin-block': 'auto'},\n\t})\n\tgrid_select_label.setAttribute('for', grid_select_id)\n\tconst grid_select = common.create_dom_element({\n\t\telement_type: 'select',\n\t\tid: grid_select_id,\n\t\tparent: select_container,\n\t\t// TODO: add ARIA attributes?\n\t})\n\tcommon.create_dom_element({\n\t\telement_type: 'option',\n\t\tvalue: 'None',\n\t\ttext_content: tstring.none_f || 'None',\n\t\tparent: grid_select,\n\t})\n\tcommon.create_dom_element({\n\t\telement_type: 'option',\n\t\tvalue: 'Major',\n\t\ttext_content: tstring.major || 'Major',\n\t\tparent: grid_select,\n\t})\n\tcommon.create_dom_element({\n\t\telement_type: 'option',\n\t\tvalue: 'Major + Minor',\n\t\ttext_content: tstring.major_minor || 'Major + Minor',\n\t\tparent: grid_select,\n\t})\n\tgrid_select.addEventListener('change', () => {\n\t\tconst mode = grid_select.value\n\t\tthis.apply_ygrid_mode(mode)\n\t})\n}\n\n/**\n * Render the slider for the xticklabel angle\n * @function\n * @private\n * @param {Element} container the container element\n * @name boxvio_chart_wrapper#_render_xticklabel_angle_slider\n */\nboxvio_chart_wrapper.prototype._render_xticklabel_angle_slider = function (container) {\n\tconst slider_container = common.create_dom_element({\n\t\telement_type: 'div',\n\t\tparent: container,\n\t\t// style: {\n\t\t// \t'display': 'flex',\n\t\t// \t'gap': DEFAULT_FLEX_GAP,\n\t\t// },\n\t})\n\tconst xticklabel_angle_slider_id = `${this.id_string()}_xticklabel_angle_slider`\n\tconst xticklabel_angle_slider_label = common.create_dom_element({\n\t\telement_type: 'label',\n\t\ttext_content: tstring.xticklabel_angle || \"X-Tick label angle\",\n\t\tparent: slider_container,\n\t\t// style: {'margin-block': 'auto'},\n\t})\n\txticklabel_angle_slider_label.setAttribute('for', xticklabel_angle_slider_id)\n\t/** @type {Element} */\n\tconst xticklabel_angle_slider = common.create_dom_element({\n\t\telement_type: 'input',\n\t\ttype: 'range',\n\t\tid: xticklabel_angle_slider_id,\n\t\tparent: slider_container,\n\t})\n\txticklabel_angle_slider.setAttribute('min', 0)\n\txticklabel_angle_slider.setAttribute('max', 90)\n\txticklabel_angle_slider.value = this._chart.xticklabel_angle\n\txticklabel_angle_slider.addEventListener('input', () => {\n\t\tthis._chart.xticklabel_angle = Number(xticklabel_angle_slider.value)\n\t\tthis.apply_xticklabel_angle()\n\t})\n}\n\n/**\n * Render the selector for the violin curve\n * @function\n * @private\n * @param {Element} container the container element\n * @name boxvio_chart_wrapper#_render_violin_curve_selector\n */\nboxvio_chart_wrapper.prototype._render_violin_curve_selector = function (container) {\n\tconst select_container = common.create_dom_element({\n\t\telement_type: 'div',\n\t\tparent: container,\n\t\t// style: {\n\t\t// \t'display': 'flex',\n\t\t// \t'gap': DEFAULT_FLEX_GAP,\n\t\t// },\n\t})\n\tconst curve_select_id = `${this.id_string()}_curve_select`\n\tconst curve_select_label = common.create_dom_element({\n\t\telement_type: 'label',\n\t\ttext_content: tstring.violin_curve || 'Violin curve',\n\t\tparent: select_container,\n\t\t// style: {'margin-block': 'auto'},\n\t})\n\tcurve_select_label.setAttribute('for', curve_select_id)\n\tconst curve_select = common.create_dom_element({\n\t\telement_type: 'select',\n\t\tid: curve_select_id,\n\t\tparent: select_container,\n\t\t// TODO: add ARIA attributes?\n\t})\n\tfor (const curve_name of this._chart.supported_curves) {\n\t\tcommon.create_dom_element({\n\t\t\telement_type: 'option',\n\t\t\tvalue: curve_name,\n\t\t\ttext_content: curve_name,\n\t\t\tparent: curve_select,\n\t\t})\n\t}\n\tcurve_select.addEventListener('change', () => {\n\t\tthis.set_violin_curve(curve_select.value)\n\t})\n}\n\n/**\n * Render the checkboxes of the control panel\n * @function\n * @private\n * @name boxvio_chart_wrapper#_render_checkboxes\n */\nboxvio_chart_wrapper.prototype._render_checkboxes = function () {\n\t// Container div\n\tconst container_div = common.create_dom_element({\n\t\telement_type\t: 'div',\n\t\tclass_name\t\t: 'control_panel_item checkboxes',\n\t\tparent\t\t\t: this.controls_container\n\t\t// style: {\n\t\t// \t'display': 'flex',\n\t\t// \t'direction': 'flex-row',\n\t\t// \t'justify-content': 'space-between',\n\t\t// \t'align-items': 'center',\n\t\t// \t'margin-top': DEFAULT_MARGIN,\n\t\t// },\n\t})\n\n\t// Show key 2\n\tconst show_key2_div = common.create_dom_element({\n\t\telement_type: 'div',\n\t\tparent: container_div,\n\t})\n\tconst show_key2_checkbox_id = `${this.id_string()}_show_key2_checkbox`\n\t/** @type {Element} */\n\tconst show_key2_checkbox = common.create_dom_element({\n\t\telement_type: 'input',\n\t\ttype: 'checkbox',\n\t\tid: show_key2_checkbox_id,\n\t\tparent: show_key2_div,\n\t})\n\tshow_key2_checkbox.checked = true\n\t/** @type {Element} */\n\tconst show_key2_label = common.create_dom_element({\n\t\telement_type: 'label',\n\t\ttext_content: (tstring.show || 'Show')\n\t\t\t\t\t  + ' '\n\t\t\t\t\t  + this._key_titles[this._key_size-2].toLowerCase(),\n\t\tparent: show_key2_div,\n\t})\n\tshow_key2_label.setAttribute('for', show_key2_checkbox_id)\n\tshow_key2_checkbox.addEventListener('change', () => {\n\t\ttoggle_visibility(this._graphics.key2_dividers_g)\n\t})\n\n\t// Show violins\n\tconst show_violins_div = common.create_dom_element({\n\t\telement_type: 'div',\n\t\tparent: container_div,\n\t})\n\tconst show_violins_checkbox_id = `${this.id_string()}_show_violins_checkbox`\n\t/** @type {Element} */\n\tconst show_violins_checkbox = common.create_dom_element({\n\t\telement_type: 'input',\n\t\ttype: 'checkbox',\n\t\tid: show_violins_checkbox_id,\n\t\tparent: show_violins_div,\n\t})\n\tshow_violins_checkbox.checked = true\n\t/** @type {Element} */\n\tconst show_violins_label = common.create_dom_element({\n\t\telement_type: 'label',\n\t\ttext_content: tstring.show_violins || 'Show violins',\n\t\tparent: show_violins_div,\n\t})\n\tshow_violins_label.setAttribute('for', show_violins_checkbox_id)\n\tshow_violins_checkbox.addEventListener('change', () => {\n\t\ttoggle_visibility(this._graphics.violins_g)\n\t})\n\n\t// Show boxes\n\tconst show_boxes_div = common.create_dom_element({\n\t\telement_type: 'div',\n\t\tparent: container_div,\n\t})\n\tconst show_boxes_checkbox_id = `${this.id_string()}_show_boxes_checkbox`\n\t/** @type {Element} */\n\tconst show_boxes_checkbox = common.create_dom_element({\n\t\telement_type: 'input',\n\t\ttype: 'checkbox',\n\t\tid: show_boxes_checkbox_id,\n\t\tparent: show_boxes_div,\n\t})\n\tshow_boxes_checkbox.checked = true\n\t/** @type {Element} */\n\tconst show_boxes_label = common.create_dom_element({\n\t\telement_type: 'label',\n\t\ttext_content: tstring.show_boxes || 'Show boxes',\n\t\tparent: show_boxes_div,\n\t})\n\tshow_boxes_label.setAttribute('for', show_boxes_checkbox_id)\n\tshow_boxes_checkbox.addEventListener('change', () => {\n\t\ttoggle_visibility(this._graphics.boxes_g)\n\t\t// (DISABLED) Disable the checkbox for outliers (defined below)\n\t\t// show_outliers_checkbox.disabled = !show_boxes_checkbox.checked\n\t})\n\n\t// Show outliers\n\tconst show_outliers_div = common.create_dom_element({\n\t\telement_type: 'div',\n\t\tparent: container_div,\n\t})\n\tconst show_outliers_checkbox_id = `${this.id_string()}_show_outliers_checkbox`\n\t/** @type {Element} */\n\tconst show_outliers_checkbox = common.create_dom_element({\n\t\telement_type: 'input',\n\t\ttype: 'checkbox',\n\t\tid: show_outliers_checkbox_id,\n\t\tparent: show_outliers_div,\n\t})\n\tshow_outliers_checkbox.checked = true\n\t/** @type {Element} */\n\tconst show_outliers_label = common.create_dom_element({\n\t\telement_type: 'label',\n\t\ttext_content: tstring.show_outliers || 'Show outliers',\n\t\tparent: show_outliers_div,\n\t})\n\tshow_outliers_label.setAttribute('for', show_outliers_checkbox_id)\n\tshow_outliers_checkbox.addEventListener('change', () => {\n\t\tfor (const group of this._graphics.outliers) {\n\t\t\ttoggle_visibility(group)\n\t\t}\n\t})\n}\n\n/**\n * Render the sliders of the control panel that\n * control the scale of violins and boxes\n * @function\n * @private\n * @name boxvio_chart_wrapper#_render_scale_sliders\n */\nboxvio_chart_wrapper.prototype._render_scale_sliders = function () {\n\t// Container div\n\tconst container_div = common.create_dom_element({\n\t\telement_type\t: 'div',\n\t\tparent\t\t\t: this.controls_container,\n\t\tclass_name\t\t: 'control_panel_item scale_sliders',\n\t\t// style\t\t\t: {\n\t\t// \t'display': 'flex',\n\t\t// \t'direction': 'flex-row',\n\t\t// \t'justify-content': 'space-between',\n\t\t// \t'align-items': 'center',\n\t\t// },\n\t})\n\n\t// Violin scale\n\tconst violin_container_div = common.create_dom_element({\n\t\telement_type: 'div',\n\t\tparent: container_div,\n\t\t// style: {\n\t\t// \t'display': 'flex',\n\t\t// \t'gap': DEFAULT_FLEX_GAP,\n\t\t// },\n\t})\n\tconst violin_scale_slider_id = `${this.id_string()}_violin_scale_slider`\n\tconst violin_scale_slider_label = common.create_dom_element({\n\t\telement_type: 'label',\n\t\ttext_content: tstring.violin_width || 'Violin width',\n\t\tparent: violin_container_div,\n\t\t// style: {\n\t\t// \t'margin-block': 'auto',\n\t\t// },\n\t})\n\tviolin_scale_slider_label.setAttribute('for', violin_scale_slider_id)\n\t/** @type {Element} */\n\tconst violin_scale_slider = common.create_dom_element({\n\t\telement_type: 'input',\n\t\ttype: 'range',\n\t\tid: violin_scale_slider_id,\n\t\tparent: violin_container_div,\n\t})\n\tviolin_scale_slider.setAttribute('min', 0)\n\tviolin_scale_slider.setAttribute('max', 1)\n\tviolin_scale_slider.setAttribute('step', 0.05)\n\tviolin_scale_slider.value = this._chart.violin_scale.initial\n\tviolin_scale_slider.addEventListener('input', () => {\n\t\tthis.set_violin_scale(Number(violin_scale_slider.value))\n\t})\n\t/** @type {Element} */\n\tconst violin_scale_slider_reset = common.create_dom_element({\n\t\telement_type\t: 'button',\n\t\ttype\t\t\t: 'button',\n\t\tclass_name\t\t: 'small',\n\t\ttext_content\t: tstring.reset || 'Reset',\n\t\tparent\t\t\t: violin_container_div\n\t})\n\tviolin_scale_slider_reset.addEventListener('click', () => {\n\t\tviolin_scale_slider.value = this._chart.violin_scale.initial\n\t\tthis.set_violin_scale(Number(violin_scale_slider.value))\n\t})\n\n\t// Box scale\n\tconst box_container_div = common.create_dom_element({\n\t\telement_type: 'div',\n\t\tparent: container_div,\n\t\t// style: {\n\t\t// \t'display': 'flex',\n\t\t// \t'gap': DEFAULT_FLEX_GAP,\n\t\t// },\n\t})\n\tconst box_scale_slider_id = `${this.id_string()}_box_scale_slider`\n\tconst box_scale_slider_label = common.create_dom_element({\n\t\telement_type: 'label',\n\t\ttext_content: tstring.box_width || 'Box width',\n\t\tparent: box_container_div,\n\t\t// style: {\n\t\t// \t'margin-block': 'auto',\n\t\t// },\n\t})\n\tbox_scale_slider_label.setAttribute('for', box_scale_slider_id)\n\t/** @type {Element} */\n\tconst box_scale_slider = common.create_dom_element({\n\t\telement_type: 'input',\n\t\ttype: 'range',\n\t\tid: box_scale_slider_id,\n\t\tparent: box_container_div,\n\t})\n\tbox_scale_slider.setAttribute('min', 0)\n\tbox_scale_slider.setAttribute('max', 1)\n\tbox_scale_slider.setAttribute('step', 0.05)\n\tbox_scale_slider.value = this._chart.box_scale.initial\n\tbox_scale_slider.addEventListener('input', () => {\n\t\tthis.set_box_scale(Number(box_scale_slider.value))\n\t})\n\t/** @type {Element} */\n\tconst box_scale_slider_reset = common.create_dom_element({\n\t\telement_type\t: 'button',\n\t\ttype\t\t\t: 'button',\n\t\tclass_name\t\t: 'small',\n\t\ttext_content\t: tstring.reset || 'Reset',\n\t\tparent\t\t\t: box_container_div,\n\t})\n\tbox_scale_slider_reset.addEventListener('click', () => {\n\t\tbox_scale_slider.value = this._chart.box_scale.initial\n\t\tthis.set_box_scale(Number(box_scale_slider.value))\n\t})\n}\n\n/**\n * Render the key select elements\n * @function\n * @private\n * @name boxvio_chart_wrapper#_render_key_select\n */\nboxvio_chart_wrapper.prototype._render_key_selects = function () {\n\tconst container = common.create_dom_element({\n\t\telement_type\t: 'div',\n\t\tclass_name\t\t: 'control_panel_item key_selects',\n\t\tparent\t\t\t: this.controls_container\n\t\t// style\t\t\t: {\n\t\t// \t'display': 'flex',\n\t\t// \t'align-items': 'center',\n\t\t// \t'gap': DEFAULT_FLEX_GAP_BIG,\n\t\t// \t'margin-top': DEFAULT_MARGIN_BIG,\n\t\t// },\n\t})\n\t// Render selects for the different key components\n\tconst key_selects = []\n\t/**\n\t * Inner function for populating a key select tag\n\t * Previous key tags must be populated already\n\t * @param {number} i index of the key select\n\t */\n\tconst populate_key_select = (i) => {\n\t\tkey_selects[i].replaceChildren()  // Delete existing children\n\t\tconst pkey = key_selects.slice(0, i).map((key_select) => key_select.value)\n\t\tconst values = this._get_next_key_component_values(pkey)\n\t\tfor (const value of values) {\n\t\t\tcommon.create_dom_element({\n\t\t\t\telement_type: 'option',\n\t\t\t\tvalue: value,\n\t\t\t\ttext_content: value,\n\t\t\t\tparent: key_selects[i],\n\t\t\t})\n\t\t}\n\t}\n\tfor (let i = 0; i < this._key_size; i++) {\n\t\tconst select_container = common.create_dom_element({\n\t\t\telement_type: 'div',\n\t\t\tparent: container,\n\t\t\t// style: {\n\t\t\t// \t'display': 'flex',\n\t\t\t// \t'gap': DEFAULT_FLEX_GAP,\n\t\t\t// },\n\t\t})\n\t\tconst select_id = `${this.id_string()}_key${this._key_size-i}_select`\n\t\tconst label = common.create_dom_element({\n\t\t\telement_type: 'label',\n\t\t\ttext_content: this._key_titles[i],\n\t\t\tparent: select_container,\n\t\t\t// style: {'margin-block': 'auto'},\n\t\t})\n\t\tlabel.setAttribute('for', select_id)\n\t\tconst key_select = common.create_dom_element({\n\t\t\telement_type: 'select',\n\t\t\tid: select_id,\n\t\t\tparent: select_container,\n\t\t})\n\t\tkey_selects.push(key_select)\n\t\tpopulate_key_select(i)\n\t\tkey_select.addEventListener('change', () => {\n\t\t\t// Repopulate the next key selects\n\t\t\tfor (let j = i+1; j < key_selects.length; j++) {\n\t\t\t\tpopulate_key_select(j)\n\t\t\t}\n\t\t\t// Update the selected index\n\t\t\tthis._controls.selected_index = this.get_index_of_key(\n\t\t\t\tkey_selects.map((ks) => ks.value)\n\t\t\t)\n\n\t\t\t// Dispatch key change event to all listeners\n\t\t\tconst listeners\n\t\t\t\t= this.controls_container.getElementsByClassName(KEY_CHANGE_LISTENER_CLASS_NAME)\n\t\t\tfor (const ele of listeners) {\n\t\t\t\tele.dispatchEvent(KEY_CHANGE_EVENT)\n\t\t\t}\n\n\t\t})\n\t}\n}\n\n/**\n * Render the control elements to change the number of bins\n * @function\n * @private\n * @name boxvio_chart_wrapper#_render_n_bins_control\n */\nboxvio_chart_wrapper.prototype._render_n_bins_control = function () {\n\tconst container = common.create_dom_element({\n\t\telement_type\t: 'div',\n\t\tparent\t\t\t: this.controls_container,\n\t\tclass_name\t\t: 'control_panel_item n_bins_control'\n\t\t// style\t\t\t: {\n\t\t// \t'display': 'flex',\n\t\t// \t'align-items': 'center',\n\t\t// \t'gap': DEFAULT_FLEX_GAP,\n\t\t// \t'margin-top': DEFAULT_MARGIN,\n\t\t// },\n\t})\n\t// Slider for n bins\n\tconst violin_n_bins_slider_id = `${this.id_string()}_violin_n_bins_slider`\n\tconst violin_n_bins_label = common.create_dom_element({\n\t\telement_type\t: 'label',\n\t\ttext_content\t: tstring.violin_resolution || 'Violin resolution',\n\t\tparent\t\t\t: container\n\t\t// style: {'margin-block': 'auto'},\n\t})\n\tviolin_n_bins_label.setAttribute('for', violin_n_bins_slider_id)\n\tconst violin_n_bins_slider = common.create_dom_element({\n\t\telement_type\t: 'input',\n\t\ttype\t\t\t: 'range',\n\t\tclass_name\t\t: KEY_CHANGE_LISTENER_CLASS_NAME,\n\t\tid\t\t\t\t: violin_n_bins_slider_id,\n\t\tparent\t\t\t: container\n\t})\n\tviolin_n_bins_slider.setAttribute('min', 2)\n\tconst reset = () => {\n\t\tviolin_n_bins_slider.setAttribute(\n\t\t\t'max',\n\t\t\tthis._controls.max_bins_multiplier\n\t\t\t\t* this._chart.n_bins[this._controls.selected_index].initial\n\t\t)\n\t\tviolin_n_bins_slider.value = this._chart.n_bins[this._controls.selected_index].value\n\t}\n\treset()\n\tviolin_n_bins_slider.addEventListener('input', () => {\n\t\tthis.set_n_bins(this._controls.selected_index, Number(violin_n_bins_slider.value))\n\t})\n\tviolin_n_bins_slider.addEventListener(KEY_CHANGE_EVENT_NAME, () => {\n\t\treset()\n\t})\n\n\t// Reset n bins\n\tconst violin_n_bins_slider_reset = common.create_dom_element({\n\t\telement_type\t: 'button',\n\t\ttype\t\t\t: 'button',\n\t\tclass_name\t\t: 'small',\n\t\ttext_content\t: tstring.reset || 'Reset',\n\t\tparent\t\t\t: container\n\t})\n\tviolin_n_bins_slider_reset.addEventListener('click', () => {\n\t\tviolin_n_bins_slider.value = this._chart.n_bins[this._controls.selected_index].initial\n\t\tthis.set_n_bins(this._controls.selected_index, Number(violin_n_bins_slider.value))\n\t})\n\n\t// Reset all n bins\n\tconst violin_all_n_bins_slider_reset = common.create_dom_element({\n\t\telement_type\t: 'button',\n\t\ttype\t\t\t: 'button',\n\t\tclass_name\t\t: 'small',\n\t\ttext_content\t: tstring.reset_all_violins || 'Reset all violins',\n\t\tparent\t\t\t: container\n\t})\n\tviolin_all_n_bins_slider_reset.addEventListener('click', () => {\n\t\t// Update the value of the slider\n\t\tviolin_n_bins_slider.value = this._chart.n_bins[this._controls.selected_index].initial\n\t\tfor (const [i, n_bins] of this._chart.n_bins.entries()) {\n\t\t\tthis.set_n_bins(i, n_bins.initial)\n\t\t}\n\t})\n}\n\n\n// HELPER FUNCTIONS\n\n/**\n * Compute (boxplot) metrics for the data\n * @param {number[]} values the data values\n * @returns {{\n *  max: number,\n *  upper_fence: number,\n *  quartile3: number,\n *  median: number,\n *  mean: number,\n *  iqr: number,\n *  quartile1: number,\n *  lower_fence: number,\n *  min: number,\n * }}\n */\nfunction calc_metrics(values) {\n\tconst metrics = {\n\t\tmax: null,\n\t\tupper_fence: null,\n\t\tquartile3: null,\n\t\tmedian: null,\n\t\tmean: null,\n\t\tiqr: null,\n\t\tquartile1: null,\n\t\tlower_fence: null,\n\t\tmin: null,\n\t}\n\n\tmetrics.min = d3.min(values)\n\tmetrics.quartile1 = d3.quantile(values, 0.25)\n\tmetrics.median = d3.median(values)\n\tmetrics.mean = d3.mean(values)\n\tmetrics.quartile3 = d3.quantile(values, 0.75)\n\tmetrics.max = d3.max(values)\n\tmetrics.iqr = metrics.quartile3 - metrics.quartile1\n\tmetrics.lower_fence = metrics.quartile1 - 1.5 * metrics.iqr\n\tmetrics.upper_fence = metrics.quartile3 + 1.5 * metrics.iqr\n\n\treturn metrics\n}\n\n/**\n * Splitter string\n * @type {string}\n */\nconst SPLITTER = '_^PoT3sRanaCantora_'\n\n/**\n * Join key array into a string\n * @param {string[]} key the key\n * @returns {string} the join\n */\nfunction join_key(key) {\n\treturn key.join(SPLITTER)\n}\n\n/**\n * Split key string into array\n * @param {string} key the key join\n * @returns {string[]} the split key\n */\nfunction split_key(key) {\n\treturn key.split(SPLITTER)\n}","\"use strict\";\n\nimport { chart_wrapper } from \"../chart-wrapper.js\";\n\n/**\n * Chart.js chart wrapper class\n * @class\n * @abstract\n * @param {Element} div_wrapper the div conatining the chart\n * @param {Object} options configuration options\n * @param {boolean} options.display_download whether to display the download panel (default `false`)\n * @param {boolean} options.display_control_panel whether to display the control panel (default `false`)\n * @extends chart_wrapper\n */\nexport function chartjs_chart_wrapper(div_wrapper, options) {\n\tif (this.constructor === chartjs_chart_wrapper) {\n\t\tthrow new Error(\"Abstract class 'chartjs_chart_wrapper' cannot be instantiated\")\n\t}\n\tchart_wrapper.call(this, div_wrapper, options)\n\t/**\n\t * Canvas instance, will be created during\n\t * render\n\t * @type {HTMLCanvasElement}\n\t * @protected\n\t */\n\tthis.canvas = undefined\n\t/**\n\t * Chart instance (chart.js)\n\t * @protected\n\t */\n\tthis.chart = undefined\n}\n// Set prototype chain\nObject.setPrototypeOf(chartjs_chart_wrapper.prototype, chart_wrapper.prototype)\n\n/**\n * Render the plot\n * \n * Subclasses must call this method at the top\n * of their own implementation. Then, they can make\n * use of the canvas and the chartjs chart instance\n * @name chartjs_chart_wrapper#render_plot\n * @function\n * @protected\n */\nchartjs_chart_wrapper.prototype.render_plot = function () {\n\tchart_wrapper.prototype.render_plot.call(this)\n\t// Create canvas\n\tthis.canvas = common.create_dom_element({\n\t\telement_type: 'canvas',\n\t\tid: 'result_graph',\n\t\tclass_name: 'o-blue',\n\t\tparent: this.plot_container,\n\t})\n\t// Set chart instance to undefined\n\tthis.chart = undefined\n}\n\n/**\n * Get the supported chart export formats\n * @function\n * @returns {string[]} the supported formats\n * @name chartjs_chart_wrapper#get_supported_export_formats\n */\nchartjs_chart_wrapper.prototype.get_supported_export_formats = function () {\n\treturn ['png']\n}\n\n/**\n * Download the chart as png\n * @param {string} filename the name of the file\n * @function\n * @name chartjs_chart_wrapper#_download_chart_as_png\n */\nchartjs_chart_wrapper.prototype.download_chart_as_png = function (filename) {\n\t/**\n\t * Temporary link\n\t * @type {Element}\n\t */\n\tconst tmpLink = common.create_dom_element({\n\t\telement_type: 'a',\n\t\thref: this.chart.toBase64Image(),\n\t})\n\ttmpLink.setAttribute('download', filename)\n\ttmpLink.click()\n\ttmpLink.remove()\n}\n\n/**\n * FIXME: this is not working...\n * Download the chart as svg\n * @param {string} filename the name of the file\n * @function\n * @name chartjs_chart_wrapper#_download_chart_as_svg\n */\nchartjs_chart_wrapper.prototype.download_chart_as_svg = function (filename) {\n\t// Tweak C2S library\n\tthis._tweak_c2s()\n\t// Get original width and height\n\tconst width = this.canvas.offsetWidth\n\tconst height = this.canvas.offsetHeight\n\t// TODO: Turn off responsiveness and animations\n\tthis.chart.options.animation = false\n\tthis.chart.options.reponsive = false\n\t// Replicate chart in C2S space\n\tconst svgContext = C2S(width, height)\n\tconst svgChart = new Chart(svgContext, this.chart.config._config)\n\t// Download\n\t/**\n\t * Temporary link\n\t * @type {Element}\n\t */\n\tconst tmpLink = common.create_dom_element({\n\t\telement_type: 'a',\n\t\thref: 'data:image/svg+xml;utf8,'\n\t\t\t+ encodeURIComponent(svgContext.getSerializedSvg()),\n\t})\n\ttmpLink.setAttribute('download', filename)\n\ttmpLink.click()\n\ttmpLink.remove()\n\t// TODO: Turn on responsiveness and animations\n\tthis.chart.options.animation = true\n\tthis.chart.options.reponsive = true\n}\n\n/**\n * Some tweaks to the canvas2svg library are required for svg export to work\n * \n * Via: https://stackoverflow.com/questions/62249315/export-canvas-to-svg-file\n * @function\n * @private\n * @name chartjs_chart_wrapper#_tweak_c2s\n */\nchartjs_chart_wrapper.prototype._tweak_c2s = function () {\n\tC2S.prototype.getContext = function (contextId) {\n\t\tif (contextId === '2d' || contextId === '2D') {\n\t\t\treturn this;\n\t\t}\n\t\treturn null;\n\t}\n\tC2S.prototype.style = function () {\n\t\treturn this.__canvas.style;\n\t}\n\tC2S.prototype.getAttribute = function (name) {\n\t\treturn this[name];\n\t}\n\tC2S.prototype.addEventListener = function (type, listener, eventListenerOptions) {\n\t\t// nothing to do here, but we need this function :)\n\t}\n}","\"use strict\";\n\nimport { chartjs_chart_wrapper } from \"./chartjs-chart-wrapper.js\";\nimport { COLOR_PICKER_WIDTH, COLOR_PALETTE } from \"../chart-wrapper.js\";\nimport { compute_n_bins } from \"../compute-n-bins.js\";\n\n/**\n * Histogram wrapper\n * @param {Element}  div_wrapper the div to work in\n * @param {number[]} data the data\n * @param {Object} options configuration options\n * @param {boolean} options.display_download whether to display the download panel (default `false`)\n * @param {boolean} options.display_control_panel whether to display the control panel (default `false`)\n * @param {string} options.xlabel the label for the x-axis (default `null` )\n * @class\n * @extends chartjs_chart_wrapper\n */\nexport function histogram_wrapper(div_wrapper, data, options) {\n\t/*\n\t * <Function>.call is a method that executes the defined function,\n\t * but with the \"this\" variable pointing to the first argument,\n\t * and the rest of the arguments being arguments of the function\n\t * that is being \"called\". This essentially performs all of\n\t * chart_wrapper's constructor logic on histogram_wrapper's \"this\".\n\t */\n\tchartjs_chart_wrapper.call(this, div_wrapper, options)\n\n\t/**\n\t * Data values\n\t * @type {number[]}\n\t * @private\n\t */\n\tthis._data = data\n\t/**\n\t * Whether to perform a density plot\n\t * @type {boolean}\n\t * @private\n\t */\n\tthis._density = false\n\t/**\n\t * Default number of bins\n\t * @type {number}\n\t * @private\n\t */\n\tthis._n_bins_default = compute_n_bins.sqrt(this._data)\n\t/**\n\t * Number of bins in the histogram\n\t * \n\t * Defined as the square root of the\n\t * amount of datapoints, computed\n\t * during render\n\t * @type {number}\n\t * @private\n\t */\n\tthis._n_bins = undefined\n\t/** Label for the xaxis\n\t * @type {string}\n\t * @private\n\t*/\n\tthis._xlabel = options.xlabel || null\n\t/**\n\t * Number of decimals to display\n\t * @type {number}\n\t * @private\n\t */\n\tthis._n_decimals = 3\n\t/**\n\t * Maximum number of bins as mutiplier of default\n\t * @type {number}\n\t * @private\n\t */\n\tthis._max_bins_multiplier = 3\n\t/**\n\t * Default color for the bars in rgba\n\t * @type {string}\n\t * @private\n\t */\n\tthis._bar_color = COLOR_PALETTE[0]\n}\n// Set prototype chain\nObject.setPrototypeOf(histogram_wrapper.prototype, chartjs_chart_wrapper.prototype)\n\n/**\n * Check whether we are doing a density plot\n * @returns {boolean} `true` if density plot,\n * \t\t\t`false` otherwise\n * @name histogram_wrapper#get_density\n * @function\n */\nhistogram_wrapper.prototype.get_density = function () {\n\treturn this._density\n}\n\n/**\n * Change the density plot attribute\n * @param density {boolean} `true` if density, `false` otherwise\n * @function\n * @name histogram_wrapper#set_density\n */\nhistogram_wrapper.prototype.set_density = function (density) {\n\tthis._density = density\n\tif (!this.chart) {\n\t\treturn\n\t}\n\t// Update chart\n\tconst [\n\t\tbin_centers, plot_data, half_bin_width, data_min, data_max\n\t] = this._get_plotting_data()\n\tthis.chart.data.datasets[0].label = this._get_density_string()\n\tthis.chart.data.datasets[0].data = plot_data\n\tthis.chart.options.scales.y.title.text = this._get_density_string()\n\tthis.chart.update()\n}\n\n/**\n * Get a string representing the plot mode\n * @returns {string} `'Density'` if we are in density\n * \t\t\tmode, `'Frequency'` otherwise\n * @function\n * @private\n * @name histogram_wrapper#_get_density_string\n */\nhistogram_wrapper.prototype._get_density_string = function () {\n\treturn this._density ? 'Density' : 'Frequency'\n}\n\n/**\n * Get the amount of bins in the histogram\n * @returns {number} the amount of bins\n * @function\n * @name histogram_wrapper#get_n_bins\n */\nhistogram_wrapper.prototype.get_n_bins = function () {\n\treturn this._n_bins\n}\n\n/**\n * Set a new number of bins for the histogram\n * \n * Updates chart instance accordingly\n * @param {number} n_bins amount of bins\n * @function\n * @name histogram_wrapper#set_n_bins\n */\nhistogram_wrapper.prototype.set_n_bins = function (n_bins) {\n\tthis._n_bins = n_bins\n\tif (!this.chart) {\n\t\treturn\n\t}\n\t// Update chart\n\tconst [\n\t\tbin_centers, plot_data, half_bin_width, data_min, data_max\n\t] = this._get_plotting_data()\n\tthis.chart.data.datasets[0].data = plot_data\n\tthis.chart.options.scales.x.min = data_min\n\tthis.chart.options.scales.x.max = data_max\n\tthis.chart.options.scales.x.ticks.stepSize = 2 * half_bin_width\n\tthis.chart.options.plugins.tooltip.callbacks.title =\n\t\tthis._get_tooltip_title_callback(bin_centers, half_bin_width)\n\tthis.chart.update()\n}\n\n/**\n * Get the color of the bars in the histogram\n * @returns {string} the bar color as an rgba string\n * @function\n * @name histogram_wrapper#get_bar_color\n */\nhistogram_wrapper.prototype.get_bar_color = function () {\n\treturn this._bar_color\n}\n\n/**\n * Set a new color for the bars in the histogram\n * \n * Updates the chart instance accordingly\n * @param {string} bar_color the new bar color for the histogram\n * @function\n * @name histogram_wrapper#set_bar_color\n */\nhistogram_wrapper.prototype.set_bar_color = function (bar_color) {\n\tthis._bar_color = bar_color\n\tif (!this.chart) {\n\t\treturn\n\t}\n\tthis.chart.data.datasets[0].backgroundColor = this._bar_color\n\tthis.chart.update()\n}\n\n/**\n * Get data needed to generate the chart\n * TODO: there is no need to recompute bin_centers unless the number of bins\n* \t\t has changed\n* @function\n* @name histogram_wrapper#_get_plotting_data\n* @private\n* \n* @returns {[number[], {x: number, y: number}[], number, number, number]}\n* \t\t\tthe bin centers, {bin centers, count per bin}, half of the bin width,\n* \t\t\tthe minimum and maximum of input data\n */\nhistogram_wrapper.prototype._get_plotting_data = function () {\n\tconst data_max = Math.max(...this._data)\n\tconst data_min = Math.min(...this._data)\n\tconst bin_width = (data_max - data_min) / this._n_bins\n\tconst half_bin_width = 0.5 * bin_width\n\t/**\n\t * Center of each bin\n\t * @type {number[]}\n\t */\n\tconst bin_centers = Array.apply(null, Array(this._n_bins)).map(\n\t\t(value, index) => data_min + (2 * index + 1) * half_bin_width\n\t)\n\t// We bin with right-open intervals\n\t/**\n\t * Count per bin\n\t * @type {number[]}\n\t */\n\tlet entries = Array.apply(null, Array(this._n_bins)).map(() => 0)\n\tfor (let i = 0; i < this._data.length; i++) {\n\t\t// If value is max, add it to last bin\n\t\tif (this._data[i] === data_max) {\n\t\t\tentries[this._n_bins - 1]++\n\t\t\tcontinue\n\t\t}\n\t\t// Proceed as usual\n\t\tfor (let j = 0; j < this._n_bins; j++) {\n\t\t\tif (this._data[i] >= bin_centers[j] - half_bin_width\n\t\t\t\t&& this._data[i] < bin_centers[j] + half_bin_width) {\n\t\t\t\tentries[j]++\n\t\t\t\tbreak\n\t\t\t}\n\t\t}\n\t}\n\t// Normalize if density\n\tif (this._density) {\n\t\tconst sum = entries.reduce((partialSum, val) => partialSum + val, 0)\n\t\tfor (let j = 0; j < this._n_bins; j++) {\n\t\t\tentries[j] /= (sum * bin_width);\n\t\t}\n\t}\n\treturn [\n\t\tbin_centers,\n\t\tbin_centers.map((val, i) => ({ x: val, y: entries[i] })),\n\t\thalf_bin_width,\n\t\tdata_min,\n\t\tdata_max,\n\t]\n}\n\n/**\n * Get callback function for tooltip title\n * @param {number[]} bin_centers the bin centers\n * @param {number} half_bin_width half of the bin width\n * @returns the callback function\n * @function\n * @private\n * @name histogram_wrapper#_get_tooltip_title_callback\n */\nhistogram_wrapper.prototype._get_tooltip_title_callback = function (bin_centers, half_bin_width) {\n\t// Cannot use `this` inside inner function!!!\n\tconst xlabel = this._xlabel\n\tconst n_decimals = this._n_decimals\n\t/**\n\t * Callback function for the tooltip title\n\t * @param {TooltipItem[]} items the tooltip item contexts\n\t * @returns {string} the title of the tooltip\n\t * @function\n\t * @name histogram_wrapper#_get_tooltip_title_callback~inner\n\t */\n\tconst callback = function (items) {\n\t\tif (!items.length) {\n\t\t\treturn ''\n\t\t}\n\t\tconst item = items[0]\n\t\tconst index = item.dataIndex\n\t\tconst min = bin_centers[index] - half_bin_width\n\t\tconst max = bin_centers[index] + half_bin_width\n\t\treturn `${xlabel}: ${min.toFixed(n_decimals)} `\n\t\t\t+ `- ${max.toFixed(n_decimals)}`\n\t}\n\treturn callback\n}\n\n/**\n * Render the plot\n * @function\n * @protected\n * @name histogram_wrapper#render_plot\n */\nhistogram_wrapper.prototype.render_plot = function () {\n\tchartjs_chart_wrapper.prototype.render_plot.call(this)\n\n\tthis._n_bins = this._n_bins_default\n\tconst [\n\t\tbin_centers, plot_data, half_bin_width, data_min, data_max\n\t] = this._get_plotting_data()\n\n\t// Split chart options\n\tconst chart_data = {\n\t\tdatasets: [{\n\t\t\tlabel: this._get_density_string(),\n\t\t\tdata: plot_data,\n\t\t\tcategoryPercentage: 1,\n\t\t\tbarPercentage: 1,\n\t\t\tbackgroundColor: this._bar_color,\n\t\t}],\n\t}\n\tconst scales_options = {\n\t\tx: {\n\t\t\ttype: 'linear',  // otherwise it goes to a category axis...\n\t\t\tmin: data_min,\n\t\t\tmax: data_max,\n\t\t\toffset: false,\n\t\t\tgrid: {\n\t\t\t\toffset: false,\n\t\t\t},\n\t\t\tticks: {\n\t\t\t\tstepSize: 2 * half_bin_width,\n\t\t\t\tcallback: (label, index, labels) => {\n\t\t\t\t\treturn Number(label).toFixed(this._n_decimals)\n\t\t\t\t}\n\t\t\t},\n\t\t\ttitle: {\n\t\t\t\tdisplay: Boolean(this._xlabel),  // Only display if there is a label\n\t\t\t\ttext: this._xlabel,\n\t\t\t\tfont: {\n\t\t\t\t\tsize: 14\n\t\t\t\t},\n\t\t\t}\n\t\t},\n\t\ty: {\n\t\t\ttitle: {\n\t\t\t\tdisplay: true,\n\t\t\t\ttext: this._get_density_string(),\n\t\t\t\tfont: {\n\t\t\t\t\tsize: 14,\n\t\t\t\t},\n\t\t\t},\n\t\t},\n\t}\n\tconst plugins_options = {\n\t\tlegend: {\n\t\t\tdisplay: false,\n\t\t},\n\t\ttooltip: {\n\t\t\tcallbacks: {\n\t\t\t\ttitle: this._get_tooltip_title_callback(bin_centers, half_bin_width),\n\t\t\t},\n\t\t},\n\t}\n\n\t// Render the graph\n\tthis.chart = new Chart(this.canvas, {\n\t\ttype: 'bar',\n\t\tdata: chart_data,\n\t\toptions: {\n\t\t\tscales: scales_options,\n\t\t\tplugins: plugins_options,\n\t\t\tparsing: false,\n\t\t\tnormalized: true,\n\t\t},\n\t})\n}\n\n\n/**\n * Render the control panel\n * @function\n * @protected\n * @name histogram_wrapper#render_control_panel\n */\nhistogram_wrapper.prototype.render_control_panel = function () {\n\tchartjs_chart_wrapper.prototype.render_control_panel.call(this)\n\n\t// Save this histogram wrapper instance, because when we change scope\n\t// we may still need to refer to it\n\t/**\n\t * This histogram_wrapper instance\n\t * @type {histogram_wrapper}\n\t */\n\tconst self = this\n\t/**\n\t * Slider for number of bins\n\t * @type {Element}\n\t */\n\tconst slider = common.create_dom_element({\n\t\telement_type: 'input',\n\t\ttype: 'range',\n\t\tvalue: this._n_bins_default,\n\t\tparent: this.controls_container,\n\t})\n\tslider.setAttribute('min', 1)\n\tslider.setAttribute('max', this._max_bins_multiplier * this._n_bins_default)\n\tslider.addEventListener('input', () => {\n\t\tthis.set_n_bins(Number(slider.value))\n\t})\n\t/**\n\t * Reset button for the slider\n\t * @type {Element}\n\t */\n\tconst slider_reset = common.create_dom_element({\n\t\telement_type: 'button',\n\t\ttype: 'button',\n\t\ttext_content: 'Reset',\n\t\tparent: this.controls_container,\n\t})\n\tslider_reset.addEventListener('click', () => {\n\t\tslider.value = this._n_bins_default\n\t\tthis.set_n_bins(Number(slider.value))\n\t})\n\n\tconst density_checkbox_id = `${this.id_string()}_density_checkbox`\n\t/**\n\t * Checkbox for density plot\n\t * @type {Element}\n\t */\n\tconst density_checkbox = common.create_dom_element({\n\t\telement_type: 'input',\n\t\ttype: 'checkbox',\n\t\tid: density_checkbox_id,\n\t\tparent: this.controls_container,\n\t})\n\t/**\n\t * Checkbox label for density plot\n\t * @type {Element}\n\t */\n\tconst density_checkbox_label = common.create_dom_element({\n\t\telement_type: 'label',\n\t\ttext_content: 'Density',\n\t\tparent: this.controls_container,\n\t})\n\tdensity_checkbox_label.setAttribute('for', density_checkbox_id)\n\tdensity_checkbox.addEventListener('change', () => {\n\t\tthis.set_density(Boolean(density_checkbox.checked))\n\t})\n\t/** iro.js color picker */\n\tconst color_picker_container = common.create_dom_element({\n\t\telement_type: 'div',\n\t\tid: `${this.id_string()}_color_picker_container`,\n\t\tparent: this.controls_container\n\t})\n\tconst color_picker = new window.iro.ColorPicker(color_picker_container, {\n\t\tcolor: this._bar_color,\n\t\twidth: COLOR_PICKER_WIDTH,\n\t\tlayoutDirection: 'horizontal',\n\t\tlayout: [\n\t\t\t{\n\t\t\t\tcomponent: window.iro.ui.Wheel,\n\t\t\t},\n\t\t\t{\n\t\t\t\tcomponent: window.iro.ui.Slider,\n\t\t\t},\n\t\t\t{\n\t\t\t\tcomponent: window.iro.ui.Slider,\n\t\t\t\toptions: {\n\t\t\t\t\tsliderType: 'alpha',\n\t\t\t\t}\n\t\t\t},\n\t\t],\n\t})\n\tcolor_picker.on('color:change', function (color) {\n\t\tself.set_bar_color(color.rgbaString)\n\t})\n}","/*global tstring, page_globals, Promise, data_manager, common, event_manager */\n/*eslint no-undef: \"error\"*/\n\n\"use strict\";\n\n\nimport { chart_wrapper } from \"../../lib/charts/chart-wrapper.js\";\nimport { boxvio_chart_wrapper } from \"../../lib/charts/d3/boxvio-chart-wrapper.js\";\nimport { histogram_wrapper } from \"../../lib/charts/chartjs/histogram-wrapper.js\";\n\n\nexport const analysis =  {\n\n\t// Form factory instance\n\tform: null,\n\n\tarea_name\t\t\t\t: null,\n\trow\t\t\t\t\t\t: null,\n\n\t// DOM containers\n\texport_data_container\t\t: null,\n\tform_items_container\t\t: null,\n\tdiameter_chart_container\t: null,\n\tweight_chart_container\t\t: null,\n\n\t/**\n\t * Chart wrapper instance for diameter\n\t * @type {chart_wrapper}\n\t */\n\tdiameter_chart_wrapper: null,\n\t/**\n\t * Chart wrapper instance for weight\n\t * @type {chart_wrapper}\n\t */\n\tweight_chart_wrapper: null,\n\n\n\tset_up : function(options) {\n\n\t\tconst self = this\n\n\t\t// options\n\t\t\tself.area_name\t\t\t\t\t= options.area_name\n\t\t\tself.export_data_container\t\t= options.export_data_container\n\t\t\tself.row\t\t\t\t\t\t= options.row\n\t\t\tself.form_items_container\t\t= options.form_items_container\n\t\t\tself.diameter_chart_container\t= options.diameter_chart_container\n\t\t\tself.weight_chart_container\t\t= options.weight_chart_container\n\n\t\t// form\n\t\tconst form_node = self.render_form()\n\t\tself.form_items_container.appendChild(form_node)\n\n\t\treturn true\n\t},//end set_up\n\n\t/**\n\t * RENDER FORM\n\t */\n\trender_form : function() {\n\n\t\tconst self = this\n\n\t\t// DocumentFragment is like a virtual DOM\n\t\tconst fragment = new DocumentFragment()\n\n\t\t// form_factory instance\n\t\t\tself.form = self.form || new form_factory()\n\n\t\tconst form_row = common.create_dom_element({\n\t\t\telement_type\t: \"div\",\n\t\t\tclass_name\t\t: \"form-row fields\",\n\t\t\tparent\t\t\t: fragment\n\t\t})\n\n\t\t// mint\n\t\t\tself.form.item_factory({\n\t\t\t\tid\t\t\t\t: \"mint\",\n\t\t\t\tname\t\t\t: \"mint\",\n\t\t\t\tlabel\t\t\t: tstring.mint || \"mint\",\n\t\t\t\tq_column\t\t: \"p_mint\",\n\t\t\t\tvalue_wrapper\t: ['[\"', '\"]'], // to obtain [\"value\"] in selected value only\n\t\t\t\teq\t\t\t\t: \"LIKE\",\n\t\t\t\teq_in\t\t\t: \"%\",\n\t\t\t\teq_out\t\t\t: \"%\",\n\t\t\t\tis_term\t\t\t: true,\n\t\t\t\tparent\t\t\t: form_row,\n\t\t\t\tcallback\t\t: function(form_item) {\n\t\t\t\t\tself.form.activate_autocomplete({\n\t\t\t\t\t\tform_item\t: form_item,\n\t\t\t\t\t\ttable\t\t: 'catalog'\n\t\t\t\t\t})\n\t\t\t\t}\n\t\t\t})\n\n\t\t// number\n\t\t\tself.form.item_factory({\n\t\t\t\tid \t\t\t: \"number\",\n\t\t\t\tname \t\t: \"number\",\n\t\t\t\tq_column \t: \"term\",\n\t\t\t\tq_table \t: \"types\",\n\t\t\t\tlabel\t\t: tstring.number_key || \"Number & Key\",\n\t\t\t\tis_term \t: false,\n\t\t\t\tparent\t\t: form_row,\n\t\t\t\tgroup_op \t: '$or',\n\t\t\t\tcallback\t: function(form_item) {\n\t\t\t\t\tself.form.activate_autocomplete({\n\t\t\t\t\t\tform_item\t: form_item,\n\t\t\t\t\t\ttable\t\t: 'catalog'\n\t\t\t\t\t})\n\t\t\t\t}\n\t\t\t})\n\n\t\t// material\n\t\t\tself.form.item_factory({\n\t\t\t\tid \t\t\t: \"material\",\n\t\t\t\tname \t\t: \"material\",\n\t\t\t\tq_column \t: \"ref_type_material\",\n\t\t\t\tq_table \t: \"any\",\n\t\t\t\tlabel\t\t: tstring.material || \"material\",\n\t\t\t\tis_term \t: false,\n\t\t\t\tparent\t\t: form_row,\n\t\t\t\tcallback\t: function(form_item) {\n\t\t\t\t\tself.form.activate_autocomplete({\n\t\t\t\t\t\tform_item\t: form_item,\n\t\t\t\t\t\ttable\t\t: 'catalog'\n\t\t\t\t\t})\n\t\t\t\t}\n\t\t\t})\n\n\t\t// denomination\n\t\t\tself.form.item_factory({\n\t\t\t\tid \t\t\t: \"denomination\",\n\t\t\t\tname \t\t: \"denomination\",\n\t\t\t\tq_column \t: \"ref_type_denomination\",\n\t\t\t\tq_table \t: \"any\",\n\t\t\t\tlabel\t\t: tstring.denomination || \"denomination\",\n\t\t\t\tis_term \t: false,\n\t\t\t\tparent\t\t: form_row,\n\t\t\t\tcallback\t: function(form_item) {\n\t\t\t\t\tself.form.activate_autocomplete({\n\t\t\t\t\t\tform_item\t: form_item,\n\t\t\t\t\t\ttable\t\t: 'catalog'\n\t\t\t\t\t})\n\t\t\t\t}\n\t\t\t})\n\n\t\t// culture\n\t\t\tself.form.item_factory({\n\t\t\t\tid\t\t\t\t: \"culture\",\n\t\t\t\tname\t\t\t: \"culture\",\n\t\t\t\tlabel\t\t\t: tstring.culture || \"culture\",\n\t\t\t\tq_column\t\t: \"p_culture\",\n\t\t\t\tvalue_wrapper\t: ['[\"','\"]'], // to obtain [\"value\"] in selected value only\n\t\t\t\teq_in\t\t\t: \"%\",\n\t\t\t\teq_out\t\t\t: \"%\",\n\t\t\t\tis_term\t\t\t: true,\n\t\t\t\tparent\t\t\t: form_row,\n\t\t\t\tcallback\t\t: function(form_item) {\n\t\t\t\t\tself.form.activate_autocomplete({\n\t\t\t\t\t\tform_item\t: form_item,\n\t\t\t\t\t\ttable\t\t: 'catalog'\n\t\t\t\t\t})\n\t\t\t\t}\n\t\t\t})\n\t\n\t\t// iconography_obverse\n\t\t\tself.form.item_factory({\n\t\t\t\tid\t\t\t\t: \"iconography_obverse\",\n\t\t\t\tname\t\t\t: \"iconography_obverse\",\n\t\t\t\tlabel\t\t\t: tstring.iconography_obverse || \"iconography obverse\",\n\t\t\t\tq_column\t\t: \"ref_type_design_obverse_iconography\",\n\t\t\t\tvalue_split\t\t: ' | ',\n\t\t\t\tq_splittable\t: true,\n\t\t\t\tq_selected_eq\t: 'LIKE',\n\t\t\t\teq_in\t\t\t: \"%\",\n\t\t\t\teq_out\t\t\t: \"%\",\n\t\t\t\t// q_table\t\t: \"ts_period\",\n\t\t\t\tis_term\t\t\t: false,\n\t\t\t\tparent\t\t\t: form_row,\n\t\t\t\tcallback\t: function(form_item) {\n\t\t\t\t\tself.form.activate_autocomplete({\n\t\t\t\t\t\tform_item\t: form_item,\n\t\t\t\t\t\ttable\t\t: 'catalog'\n\t\t\t\t\t})\n\t\t\t\t}\n\t\t\t})\n\t\t\n\t\t// iconography_reverse\n\t\t\tself.form.item_factory({\n\t\t\t\tid\t\t\t\t: \"iconography_reverse\",\n\t\t\t\tname\t\t\t: \"iconography_reverse\",\n\t\t\t\tlabel\t\t\t: tstring.iconography_reverse || \"iconography reverse\",\n\t\t\t\tq_column\t\t: \"ref_type_design_reverse_iconography\",\n\t\t\t\tvalue_split\t\t: ' | ',\n\t\t\t\tq_splittable\t: true,\n\t\t\t\tq_selected_eq\t: 'LIKE',\n\t\t\t\teq_in\t\t\t: \"%\",\n\t\t\t\teq_out\t\t\t: \"%\",\n\t\t\t\t// q_table\t\t: \"ts_period\",\n\t\t\t\tis_term\t\t\t: false,\n\t\t\t\tparent\t\t\t: form_row,\n\t\t\t\tcallback\t\t: function(form_item) {\n\t\t\t\t\tself.form.activate_autocomplete({\n\t\t\t\t\t\tform_item\t: form_item,\n\t\t\t\t\t\ttable\t\t: 'catalog'\n\t\t\t\t\t})\n\t\t\t\t}\n\t\t\t})\n\t\t\n\t\t// range slider date (range_slider) (!) WORKING HERE\n\t\t\tself.form.item_factory({\n\t\t\t\tid\t\t\t: \"range_slider\",\n\t\t\t\tname\t\t: \"range_slider\",\n\t\t\t\tinput_type\t: 'range_slider',\n\t\t\t\tlabel\t\t: tstring.period || \"Period\",\n\t\t\t\tclass_name\t: 'range_slider',\n\t\t\t\tq_column\t: \"ref_date_in,ref_date_end\",\n\t\t\t\t// eq\t\t: \"LIKE\",\n\t\t\t\t// eq_in\t: \"\",\n\t\t\t\t// eq_out\t: \"%\",\n\t\t\t\t// q_table\t: \"catalog\",\n\t\t\t\tsql_filter\t: null,\n\t\t\t\tparent\t\t: form_row,\n\t\t\t\tcallback\t: function(form_item) {\n\n\t\t\t\t\t// const form_item\t\t\t\t= this\n\t\t\t\t\tconst node_input\t\t\t\t= form_item.node_input\n\t\t\t\t\tconst range_slider_value_in\t\t= node_input.parentNode.querySelector('#range_slider_in')\n\t\t\t\t\tconst range_slider_value_out\t= node_input.parentNode.querySelector('#range_slider_out')\n\n\t\t\t\t\tfunction set_up_slider() {\n\n\t\t\t\t\t\t// compute range years\n\t\t\t\t\t\tself.get_catalog_range_years()\n\t\t\t\t\t\t.then(function(range_data){\n\t\t\t\t\t\t\t// console.log(\"range_data:\",range_data);\n\n\t\t\t\t\t\t\t// destroy current slider instance if already exists\n\t\t\t\t\t\t\t\tif ($(node_input).slider(\"instance\")) {\n\t\t\t\t\t\t\t\t\t$(node_input).slider(\"destroy\")\n\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t// reset filter\n\t\t\t\t\t\t\t\tform_item.sql_filter = null\n\n\t\t\t\t\t\t\t// set inputs values from database\n\t\t\t\t\t\t\t\trange_slider_value_in.value\t= range_data.min\n\t\t\t\t\t\t\t\trange_slider_value_in.addEventListener(\"change\",function(e){\n\t\t\t\t\t\t\t\t\tconst value = (e.target.value>=range_data.min)\n\t\t\t\t\t\t\t\t\t\t? e.target.value\n\t\t\t\t\t\t\t\t\t\t: range_data.min\n\t\t\t\t\t\t\t\t\t$(node_input).slider( \"values\", 0, value );\n\t\t\t\t\t\t\t\t\te.target.value = value\n\t\t\t\t\t\t\t\t})\n\t\t\t\t\t\t\t\trange_slider_value_out.value = range_data.max\n\t\t\t\t\t\t\t\trange_slider_value_out.addEventListener(\"change\",function(e){\n\t\t\t\t\t\t\t\t\tconst value = (e.target.value<=range_data.max)\n\t\t\t\t\t\t\t\t\t\t? e.target.value\n\t\t\t\t\t\t\t\t\t\t: range_data.max\n\t\t\t\t\t\t\t\t\t$(node_input).slider( \"values\", 1, e.target.value );\n\t\t\t\t\t\t\t\t\te.target.value = value\n\t\t\t\t\t\t\t\t})\n\n\t\t\t\t\t\t\t// active jquery slider\n\t\t\t\t\t\t\t\t$(node_input).slider({\n\t\t\t\t\t\t\t\t\trange\t: true,\n\t\t\t\t\t\t\t\t\tmin\t\t: range_data.min,\n\t\t\t\t\t\t\t\t\tmax\t\t: range_data.max,\n\t\t\t\t\t\t\t\t\tstep\t: 1,\n\t\t\t\t\t\t\t\t\tvalues\t: [ range_data.min, range_data.max ],\n\t\t\t\t\t\t\t\t\tslide\t: function( event, ui ) {\n\t\t\t\t\t\t\t\t\t\t// update input values on user drag slide points\n\t\t\t\t\t\t\t\t\t\trange_slider_value_in.value\t = ui.values[0]\n\t\t\t\t\t\t\t\t\t\trange_slider_value_out.value = ui.values[1]\n\t\t\t\t\t\t\t\t\t\t// console.warn(\"-----> slide range form_item.sql_filter:\",form_item.sql_filter);\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\tchange: function( event, ui ) {\n\t\t\t\t\t\t\t\t\t\t// update form_item sql_filter value on every slider change\n\t\t\t\t\t\t\t\t\t\tform_item.sql_filter = \"(ref_date_in >= \" + ui.values[0] + \" AND ref_date_in <= \"+ui.values[1]+\")\"; // AND (ref_date_end <= \" + ui.values[1] + \" OR ref_date_end IS NULL)\n\t\t\t\t\t\t\t\t\t\tform_item.q = ui.value\n\t\t\t\t\t\t\t\t\t\t// console.warn(\"-----> change range form_item.sql_filter:\", form_item.sql_filter);\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t})\n\t\t\t\t\t}\n\n\t\t\t\t\t// initial_map_loaded event (triggered on initial map data is ready)\n\t\t\t\t\t// event_manager.subscribe('initial_map_loaded', set_up_slider)\n\t\t\t\t\tset_up_slider()\n\t\t\t\t}\n\t\t\t})\n\n\t\t// submit button\n\t\t\tconst submit_group = common.create_dom_element({\n\t\t\t\telement_type\t: \"div\",\n\t\t\t\tclass_name\t\t: \"form-group field button_submit\",\n\t\t\t\tparent\t\t\t: fragment\n\t\t\t})\n\t\t\tconst submit_button = common.create_dom_element({\n\t\t\t\telement_type\t: \"input\",\n\t\t\t\ttype\t\t\t: \"submit\",\n\t\t\t\tid\t\t\t\t: \"submit\",\n\t\t\t\tvalue\t\t\t: tstring.search || \"Search\",\n\t\t\t\tclass_name\t\t: \"btn btn-light btn-block primary\",\n\t\t\t\tparent\t\t\t: submit_group\n\t\t\t})\n\t\t\tsubmit_button.addEventListener(\"click\", function (e) {\n\t\t\t\te.preventDefault()\n\t\t\t\tself.form_submit(form)\n\t\t\t})\n\n\t\t// reset button\n\t\t\tconst reset_button = common.create_dom_element({\n\t\t\t\telement_type\t: \"input\",\n\t\t\t\ttype\t\t\t: \"button\",\n\t\t\t\tid\t\t\t\t: \"button_reset\",\n\t\t\t\tvalue\t\t\t: tstring.reset || 'Reset',\n\t\t\t\tclass_name\t\t: \"btn btn-light btn-block secondary button_reset\",\n\t\t\t\tparent\t\t\t: submit_group\n\t\t\t})\n\t\t\treset_button.addEventListener(\"click\", function (e) {\n\t\t\t\te.preventDefault()\n\t\t\t\twindow.location.replace(window.location.pathname);\n\t\t\t})\n\n\t\t// operators\n\t\t\t// fragment.appendChild( forms.build_operators_node() )\n\t\t\tconst operators_node = self.form.build_operators_node()\n\t\t\tfragment.appendChild( operators_node )\n\n\t\t// the form element itself!\n\t\t\tconst form = common.create_dom_element({\n\t\t\t\telement_type\t: \"form\",\n\t\t\t\tid\t\t\t\t: \"search_form\",\n\t\t\t\tclass_name\t\t: \"form-inline\"\n\t\t\t})\n\t\t\tform.appendChild(fragment)\n\n\n\t\treturn form\n\t},//end render_form\n\n\t/**\n\t * FORM SUBMIT\n\t * Form submit launch search\n\t */\n\tform_submit : function(form_obj, options={}) {\n\n\t\tconst self = this\n\n\t\t// options\n\t\t\tconst scroll_result\t= typeof options.scroll_result===\"boolean\" ? options.scroll_result : true\n\t\t\tconst form_items\t= options.form_items || self.form.form_items\n\n\t\t// build filter\n\t\t\tconst filter = self.form.build_filter({\n\t\t\t\tform_items: form_items\n\t\t\t})\n\n\t\t// empty filter case\n\t\t\tif (!filter || filter.length<1) {\n\t\t\t\treturn false\n\t\t\t}\n\n\t\t// loading\n\t\t\t// cleanup html\n\t\t\t\tconst info_lines = document.querySelectorAll('.info_line')\n\t\t\t\tconst info_lines_length\t= info_lines.length\n\t\t\t\tfor (let i = 0; i < info_lines_length; i++) {\n\t\t\t\t\tinfo_lines[i].classList.add('hide')\n\t\t\t\t}\n\t\t\t\twhile (self.diameter_chart_container.hasChildNodes()) {\n\t\t\t\t\tself.diameter_chart_container.removeChild(self.diameter_chart_container.lastChild);\n\t\t\t\t}\n\t\t\t\twhile (self.weight_chart_container.hasChildNodes()) {\n\t\t\t\t\tself.weight_chart_container.removeChild(self.weight_chart_container.lastChild);\n\t\t\t\t}\n\t\t\t// spinner\n\t\t\t\tconst result = document.getElementById('result')\n\t\t\t\tconst spinner = common.create_dom_element({\n\t\t\t\t\telement_type\t: 'div',\n\t\t\t\t\tclass_name\t\t: 'spinner',\n\t\t\t\t\tparent\t\t\t: result\n\t\t\t\t})\n\n\t\t// scroll to head result\n\t\t\t// if (scroll_result) {\n\t\t\t\t// result.scrollIntoView(\n\t\t\t\t// \t{behavior: \"smooth\", block: \"start\", inline: \"nearest\"}\n\t\t\t\t// );\n\t\t\t// }\n\n\t\t// search rows exec against API\n\t\t\tconst js_promise = self.search_rows({\n\t\t\t\tfilter\t\t\t: filter,\n\t\t\t\tlimit\t\t\t: 0,\n\t\t\t\tprocess_result\t: {\n\t\t\t\t\tfn\t\t: 'process_result::add_parents_and_children_recursive',\n\t\t\t\t\tcolumns\t: [{name : \"parents\"}]\n\t\t\t\t}\n\t\t\t})\n\t\t\t.then((parsed_data)=>{\n\t\t\t\t// console.log(parsed_data)\n\n\t\t\t\tevent_manager.publish('form_submit', parsed_data)\n\n\t\t\t\t// const diameters = parsed_data\n\t\t\t\t// \t.map((ele) => ele.full_coins_reference_diameter_max)\n\t\t\t\t// \t.flat()\n\t\t\t\t// \t.filter((v) => v)\n\t\t\t\t// console.log(diameters)\n\n\t\t\t\t// this.diameter_chart_wrapper = new histogram_wrapper(\n\t\t\t\t// \tthis.diameter_chart_container,\n\t\t\t\t// \tdiameters,\n\t\t\t\t// \t{\n\t\t\t\t// \t\txlabel: 'Diameter',\n\t\t\t\t// \t}\n\t\t\t\t// )\n\t\t\t\t// this.diameter_chart_wrapper.render()\n\n\t\t\t\t// data\n\t\t\t\t\tconst data = []\n\t\t\t\t\tfor (const [i, ele] of parsed_data.entries()) {\n\t\t\t\t\t\tconst number_key = ele.ref_type_number ? ele.ref_type_number : `Missing Number & Key (${i})`\n\t\t\t\t\t\tconst mint = ele.p_mint ? ele.p_mint[0] : `Missing mint (${i})`\n\t\t\t\t\t\tconst material = ele.ref_type_material ? ele.ref_type_material : `Missing material (${i})`\n\t\t\t\t\t\tconst denomination = ele.ref_type_denomination ? ele.ref_type_denomination : `Missing denomination ${i}`\n\t\t\t\t\t\t// if (!['12', '59', '62', '18','11a','14'].includes(name)) continue\n\t\t\t\t\t\t// if (!['59', '62'].includes(name)) continue\n\t\t\t\t\t\tconst tmp_data = {}\n\t\t\t\t\t\tconst calculable = ele.full_coins_reference_calculable\n\t\t\t\t\t\tconst diameter_max = ele.full_coins_reference_diameter_max\n\t\t\t\t\t\tconst diameter_min = ele.full_coins_reference_diameter_min\n\t\t\t\t\t\tconst weight = ele.full_coins_reference_weight\n\t\t\t\t\t\tif (diameter_max && diameter_max.length) {\n\t\t\t\t\t\t\tconst tmp_diameter_max = diameter_max.filter((v, i) => v && calculable[i])\n\t\t\t\t\t\t\tif (tmp_diameter_max.length) {\n\t\t\t\t\t\t\t\ttmp_data.diameter_max = tmp_diameter_max\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t\tif (diameter_min && diameter_min.length) {\n\t\t\t\t\t\t\tconst tmp_diameter_min = diameter_min.filter((v, i) => v && calculable[i])\n\t\t\t\t\t\t\tif (tmp_diameter_min.length) {\n\t\t\t\t\t\t\t\ttmp_data.diameter_min = tmp_diameter_min\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t\tif (weight && weight.length) {\n\t\t\t\t\t\t\tconst tmp_weight = weight.filter((v, i) => v && calculable[i])\n\t\t\t\t\t\t\tif (tmp_weight.length) {\n\t\t\t\t\t\t\t\ttmp_data.weight = tmp_weight\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t\tif (Object.keys(tmp_data).length) {\n\t\t\t\t\t\t\ttmp_data.number_key = number_key\n\t\t\t\t\t\t\ttmp_data.mint = mint\n\t\t\t\t\t\t\ttmp_data.material = material\n\t\t\t\t\t\t\ttmp_data.denomination = denomination\n\t\t\t\t\t\t\tdata.push(tmp_data)\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\t// console.log(data)\n\n\t\t\t\t// Weights\n\t\t\t\tconst weights = data.filter(\n\t\t\t\t\t(ele) => ele.weight\n\t\t\t\t).map(\n\t\t\t\t\t(ele) => {return {key: [ele.mint, ele.number_key], values: ele.weight}}\n\t\t\t\t)\n\t\t\t\t// console.log('Weights:')\n\t\t\t\t// console.log(weights)\n\n\t\t\t\tspinner.remove()\n\n\t\t\t\tthis.weight_chart_wrapper = new boxvio_chart_wrapper(\n\t\t\t\t\tthis.weight_chart_container,\n\t\t\t\t\tweights,\n\t\t\t\t\t[tstring.mint || 'Mint', tstring.number || 'Number'],\n\t\t\t\t\t{\n\t\t\t\t\t\tylabel: tstring.weight || 'Weight',\n\t\t\t\t\t\toverflow: true,\n\t\t\t\t\t\tdisplay_control_panel: true,\n\t\t\t\t\t\tdisplay_download: true,\n\t\t\t\t\t\tsort_xaxis: true,\n\t\t\t\t\t}\n\t\t\t\t)\n\t\t\t\tthis.weight_chart_wrapper.render()\n\n\t\t\t\t// Diameters\n\t\t\t\tconst diameters = data.filter(\n\t\t\t\t\t(ele) => ele.diameter_max\n\t\t\t\t).map(\n\t\t\t\t\t(ele) => {return {key: [ele.mint, ele.number_key], values: ele.diameter_max}}\n\t\t\t\t)\n\t\t\t\t// console.log('Diameters:')\n\t\t\t\t// console.log(diameters)\n\t\t\t\tthis.diameter_chart_wrapper = new boxvio_chart_wrapper(\n\t\t\t\t\tthis.diameter_chart_container,\n\t\t\t\t\tdiameters,\n\t\t\t\t [tstring.mint || 'Mint', tstring.number || 'Number'],\n\t\t\t\t\t{\n\t\t\t\t\t\tylabel: tstring.diameter || 'Diameter',\n\t\t\t\t\t\toverflow: true,\n\t\t\t\t\t\tdisplay_control_panel: true,\n\t\t\t\t\t\tdisplay_download: true,\n\t\t\t\t\t\tsort_xaxis: true,\n\t\t\t\t\t}\n\t\t\t\t)\n\t\t\t\tthis.diameter_chart_wrapper.render()\n\n\t\t\t\t// show Weights and Diameters block labels\n\t\t\t\t\tfor (let i = 0; i < info_lines_length; i++) {\n\t\t\t\t\t\tinfo_lines[i].classList.remove('hide')\n\t\t\t\t\t}\n\t\t\t})\n\n\n\t\treturn js_promise\n\t},\n\n\t/**\n\t * SEARCH_ROWS\n\t * Call to API and load JSON data results of search\n\t */\n\tsearch_rows : function(options) {\n\n\t\tconst self = this\n\n\t\t// sort vars\n\t\t\tconst filter\t\t\t= options.filter || null\n\t\t\tconst ar_fields\t\t\t= options.ar_fields || [\"*\"]\n\t\t\tconst order\t\t\t\t= options.order || \"norder ASC\"\n\t\t\tconst lang\t\t\t\t= page_globals.WEB_CURRENT_LANG_CODE\n\t\t\tconst process_result\t= options.process_result || null\n\t\t\tconst limit\t\t\t\t= options.limit != undefined\n\t\t\t\t\t\t\t\t\t\t? options.limit\n\t\t\t\t\t\t\t\t\t\t: 100\n\n\t\treturn new Promise(function(resolve){\n\t\t\t// parse_sql_filter\n\t\t\t\tconst group = []\n\t\t\t// parsed filters\n\t\t\t\tconst sql_filter = self.form.parse_sql_filter(filter)\n\t\t\t// request\n\t\t\t\tconst request_body = {\n\t\t\t\t\tdedalo_get\t\t: 'records',\n\t\t\t\t\ttable\t\t\t: 'catalog',\n\t\t\t\t\tar_fields\t\t: ar_fields,\n\t\t\t\t\tlang\t\t\t: lang,\n\t\t\t\t\tsql_filter\t\t: sql_filter,\n\t\t\t\t\tlimit\t\t\t: limit,\n\t\t\t\t\tgroup\t\t\t: (group.length>0) ? group.join(\",\") : null,\n\t\t\t\t\tcount\t\t\t: false,\n\t\t\t\t\torder\t\t\t: order,\n\t\t\t\t\tprocess_result\t: process_result\n\t\t\t\t}\n\t\t\t\tdata_manager.request({\n\t\t\t\t\tbody : request_body\n\t\t\t\t})\n\t\t\t\t.then((response)=>{\n\n\t\t\t\t\t// data parsed\n\t\t\t\t\tconst data = page.parse_catalog_data(response.result)\n\n\t\t\t\t\tresolve(data)\n\t\t\t\t})\n\t\t})\n\t},\n\n\t/**\n\t* GET_CATALOG_RANGE_YEARS\n\t* @return\n\t*/\n\tget_catalog_range_years : function() {\n\n\t\treturn new Promise(function(resolve){\n\n\t\t\tconst ar_fields = ['id','section_id','MIN(ref_date_in + 0) AS min','MAX(ref_date_in + 0) AS max']\n\n\t\t\tconst request_body = {\n\t\t\t\tdedalo_get\t\t: 'records',\n\t\t\t\tdb_name\t\t\t: page_globals.WEB_DB,\n\t\t\t\tlang\t\t\t: page_globals.WEB_CURRENT_LANG_CODE,\n\t\t\t\ttable\t\t\t: 'catalog',\n\t\t\t\tar_fields\t\t: ar_fields,\n\t\t\t\tlimit\t\t\t: 0,\n\t\t\t\tcount\t\t\t: false,\n\t\t\t\toffset\t\t\t: 0,\n\t\t\t\torder\t\t\t: 'id ASC'\n\t\t\t}\n\t\t\tdata_manager.request({\n\t\t\t\tbody : request_body\n\t\t\t})\n\t\t\t.then(function(api_response){\n\t\t\t\t// console.log(\"-> get_catalog_range_years api_response:\",api_response);\n\n\t\t\t\tlet min = 0\n\t\t\t\tlet max = 0\n\t\t\t\tif (api_response.result) {\n\t\t\t\t\tfor (let i = 0; i < api_response.result.length; i++) {\n\t\t\t\t\t\tconst row = api_response.result[i]\n\t\t\t\t\t\tconst current_min = parseInt(row.min)\n\t\t\t\t\t\tif (min===0 || current_min<min) {\n\t\t\t\t\t\t\tmin = current_min\n\t\t\t\t\t\t}\n\t\t\t\t\t\tconst current_max = parseInt(row.max)\n\t\t\t\t\t\t// if (current_max>min) {\n\t\t\t\t\t\t\tmax = current_max\n\t\t\t\t\t\t// }\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tconst data = {\n\t\t\t\t\tmin : min,\n\t\t\t\t\tmax : max\n\t\t\t\t}\n\n\t\t\t\tresolve(data)\n\t\t\t})\n\t\t})\n\t}//end get_catalog_range_years\n\n}//end analysis\n\n"],"mappings":"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"}