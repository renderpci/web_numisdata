"use strict";var catalog={trigger_url:page_globals.__WEB_TEMPLATE_WEB__+"/catalog/trigger.catalog.php",search_options:{},selected_term_table:null,set_up:function(e){const t=this;return t.load_mint_list().then((function(e){const o=t.draw_select({data:e.result,term_table:"mints",default:[{section_id:"0",name:"Select mint"}]});document.getElementById("items_container").appendChild(o)})),!0},load_mint_list:function(){return page.request({body:{dedalo_get:"records",table:"catalog",ar_fields:["section_id","term AS name","parents"],lang:page_globals.WEB_CURRENT_LANG_CODE,limit:0,count:!1,order:"term ASC",sql_filter:"term_table='mints'"}})},draw_select:function(e){const t=this,o=e.data,n=e.term_table,a=e.default||[{section_id:"0",name:"Select option"}],r=new DocumentFragment,s=a.concat(o),l=s.length;for(let e=0;e<l;e++){const t=s[e],o={OR:[]},n=t.parents?JSON.parse(t.parents):null;if(n)for(let e=0;e<n.length;e++)o.OR.push({field:"section_id",value:""+n[e],op:"="});o.OR.push({field:"section_id",value:""+t.section_id,op:"="}),o.OR.push({field:"parents",value:`'%"${t.section_id}"%'`,op:"LIKE"}),common.create_dom_element({element_type:"option",value:JSON.stringify(o),text_content:t.name,parent:r})}const c=common.create_dom_element({element_type:"select",class_name:"select_"+n});return c.addEventListener("change",(function(e){const o=e.target.value;if(!o)return!1;t.selected_term_table=n;const a=document.querySelector("#rows_list");for(;a.hasChildNodes();)a.removeChild(a.lastChild);page.add_spinner(a);const r=JSON.parse(o);t.search_rows({filter:r,limit:0}).then((function(e){setTimeout(()=>{t.draw_rows({target:"rows_list",ar_rows:e.result})},200)}))})),c.appendChild(r),c},set_value:function(e,t,o){const n=document.getElementById(e.id+"_values"),a=n.querySelectorAll(".input_values");for(var r=a.length-1;r>=0;r--)if(t===a[r].value)return!1;const s=common.create_dom_element({element_type:"div",class_name:"line_value",parent:n});return common.create_dom_element({element_type:"i",class_name:"icon fa-trash",parent:s}).addEventListener("click",(function(){this.parentNode.remove()})),common.create_dom_element({element_type:"input",class_name:"input_values",parent:s,data_set:e.dataset}).value=t,!0},activate_autocomplete:function(e){const t=this;return $(e).autocomplete({delay:150,minLength:0,source:function(o,n){const a=o.term,r=t.trigger_url,s={q:a,mode:e.dataset.mode,q_name:e.dataset.q_name||null,q_search:e.dataset.q_search||e.dataset.q_name,q_table:e.dataset.q_table||null,dd_relations:e.dataset.dd_relations||null};!0===SHOW_DEBUG&&console.log("[catalog.activate_autocomplete] trigger_vars:",s),common.get_json_data(r,s).then((function(t){console.log("[catalog.activate_autocomplete] response_data",t);const o="fecha_publicacion"===e.id?t.result.map(e=>(e.label=e.label.substring(0,4),e)):t.result;n(o)}),(function(e){console.error("[activate_autocomplete] Failed get_json!",e)}))},select:function(e,o){return e.preventDefault(),t.set_value(this,o.item.label,o.item.value),this.value="",!1},focus:function(){return!1},close:function(e,t){},change:function(e,t){},response:function(e,t){}}).on("keydown",(function(e){e.keyCode===$.ui.keyCode.ENTER&&$(this).autocomplete("close")})).focus((function(){$(this).autocomplete("search",null)})).blur((function(){})),!0},search:function(e,t){t&&t.preventDefault();const o=this;var n=[],a=e.querySelectorAll("input.input_values, input.form-control"),r=a.length;for(let e=0;e<r;e++){const t=a[e];if(t.value.length>0){let e=t.value,o=t.dataset.q_name;if(-1!==t.dataset.q_name.indexOf(" AS ")){if(o=t.dataset.q_name.split(" AS ")[1],"authors"===o){const t=/\,/gi;e=e.replace(t,"")}}const a={name:o,value:e,search_mode:t.dataset.search,table:t.dataset.q_table};n.push(a)}}!0===SHOW_DEBUG&&console.log("search.ar_query:",n);const s=e.querySelector('input[name="operators"]:checked').value,l=o.search_rows({ar_query:n,operator:s}).then((function(e){o.draw_rows({target:"rows_list",ar_rows:e.result})})),c=document.querySelector(".result");return c&&c.scrollIntoView({behavior:"smooth",block:"start",inline:"nearest"}),l},search_rows:function(e){this.search_options=e;const t=function(){if(e.filter){const t=Object.keys(e.filter)[0],o=e.filter[t],n=[],a=o.length;for(let e=0;e<a;e++){const t=o[e],a="`"+t.field+"` "+t.op+" "+t.value;n.push(a)}return n.join(" "+t+" ")}return null}(),o=page.request({body:{dedalo_get:"records",table:"catalog",ar_fields:["*"],lang:page_globals.WEB_CURRENT_LANG_CODE,sql_filter:t,limit:0,count:!1,order:"norder ASC"}});return o.then(e=>{console.log("API response:",e)}),o},search_rows_SERVER:function(e){const t=this;t.search_options=e;const o=t.trigger_url,n={mode:"search_rows",ar_query:void 0!==e.ar_query?e.ar_query:null,limit:e.limit||10,offset:e.offset||0,total:e.total||!1,order:e.order||"section_id ASC",operator:e.operator||"OR"};return!0===SHOW_DEBUG&&console.log("[catalog.search_rows] trigger_vars:",n),common.get_json_data(o,n).then((function(e){return!0===SHOW_DEBUG&&console.log("[catalog.search_rows] get_json_data response:",e),e?(t.search_options.total=e.result.total&&e.result.total>0?e.result.total:t.search_options.total,t.search_options.limit=n.limit,t.search_options.offset=n.offset,e.result):(console.warn("[catalog.search_rows] Error. Received response data is null"),!1)}))},draw_rows:function(e){const t=e.target,o=e.ar_rows||[],n=o.length;console.log("ar_rows:",o);this.search_options.total,this.search_options.limit,this.search_options.offset;const a=document.getElementById(t);for(;a.hasChildNodes();)a.removeChild(a.lastChild);const r=new DocumentFragment;row_fields.ar_rows=o;for(let e=0;e<n;e++){const t=o[e];SHOW_DEBUG;const n=common.create_dom_element({element_type:"div",class_name:"row_wrapper",data_set:{section_id:t.section_id},parent:r}),a=row_fields.draw_item(t);n.appendChild(a)}return a.appendChild(r),!0},draw_paginator:function(e){const t=this,o=e.total,n=e.limit,a=e.offset,r=e.count,s=new DocumentFragment,l=paginator.get_full_paginator({total:o,limit:n,offset:a,n_nodes:10,callback:e=>{t.search_options.offset=e.offset,t.search_options.total=e.total;const o=t.search_rows(t.search_options);return o.then((function(e){const o=document.querySelector(".result");o&&o.scrollIntoView({behavior:"smooth",block:"start",inline:"nearest"}),t.draw_rows({target:"rows_list",ar_rows:e.result})})),o}});s.appendChild(l),common.create_dom_element({element_type:"div",class_name:"spacer",parent:s});const c=paginator.get_totals_node({total:o,limit:n,offset:a,count:r});return s.appendChild(c),s}};