"use strict";var analysis={form:null,area_name:null,row:null,export_data_container:null,form_items_container:null,chart_wrapper_container:null,chart_wrapper:null,set_up:function(t){const e=this;e.area_name=t.area_name,e.export_data_container=t.export_data_container,e.row=t.row,e.form_items_container=t.form_items_container,e.chart_wrapper_container=t.chart_wrapper_container;const r=e.render_form();return e.form_items_container.appendChild(r),!0},render_form:function(){const t=this,e=new DocumentFragment;t.form=t.form||new form_factory;const r=common.create_dom_element({element_type:"div",class_name:"form-row fields",parent:e});t.form.item_factory({id:"mint",name:"mint",label:tstring.mint||"mint",q_column:"p_mint",value_wrapper:['["','"]'],eq:"LIKE",eq_in:"%",eq_out:"%",is_term:!0,parent:r,callback:function(e){t.form.activate_autocomplete({form_item:e,table:"catalog"})}});const n=common.create_dom_element({element_type:"div",class_name:"form-group field button_submit",parent:e});common.create_dom_element({element_type:"input",type:"submit",id:"submit",value:tstring.search||"Search",class_name:"btn btn-light btn-block primary",parent:n}).addEventListener("click",(function(e){e.preventDefault(),t.form_submit(a)}));common.create_dom_element({element_type:"input",type:"button",id:"button_reset",value:tstring.reset||"Reset",class_name:"btn btn-light btn-block secondary button_reset",parent:n}).addEventListener("click",(function(t){t.preventDefault(),window.location.replace(window.location.pathname)}));const o=t.form.build_operators_node();e.appendChild(o);const a=common.create_dom_element({element_type:"form",id:"search_form",class_name:"form-inline"});return a.appendChild(e),a},form_submit:function(t,e={}){const r=this,n=("boolean"!=typeof e.scroll_result||e.scroll_result,e.form_items||r.form.form_items),o=r.form.build_filter({form_items:n});if(!o||o.length<1)return!1;r.search_rows({filter:o,limit:0}).then((t=>{event_manager.publish("form_submit",t);const e=t.map((t=>t.ref_type_averages_diameter)).filter((t=>null!=t));this.chart_wrapper=new histogram_wrapper(this.chart_wrapper_container,e,"Diameter"),this.chart_wrapper.render()}))},search_rows:function(t){const e=this,r=t.filter||null,n=t.ar_fields||["*"],o=t.order||"norder ASC",a=page_globals.WEB_CURRENT_LANG_CODE,i=t.process_result||null,s=null!=t.limit?t.limit:30;return new Promise((function(t){const _=[],c=e.form.parse_sql_filter(r),p={dedalo_get:"records",table:"catalog",ar_fields:n,lang:a,sql_filter:c,limit:s,group:_.length>0?_.join(","):null,count:!1,order:o,process_result:i};data_manager.request({body:p}).then((e=>{const r=page.parse_catalog_data(e.result);t(r)}))}))}};const COLOR_PICKER_WIDTH=200,DEFAULT_CHART_NAME="chart";function chart_wrapper(t){if(this.constructor===chart_wrapper)throw new Error("Abstract class 'chart_wrapper' cannot be instantiated");this.div_wrapper=t,this.download_chart_container=void 0,this.controls_container=void 0}function chartjs_chart_wrapper(t){if(this.constructor===chartjs_chart_wrapper)throw new Error("Abstract class 'chartjs_chart_wrapper' cannot be instantiated");chart_wrapper.call(this,t),this.canvas=void 0,this.chart=void 0}function histogram_wrapper(t,e,r){chartjs_chart_wrapper.call(this,t),this._data=e,this._density=!1,this._n_bins_default=Math.ceil(Math.sqrt(this._data.length)),this._n_bins=void 0,this._xlabel=r,this._n_decimals=3,this._max_bins_multiplier=3,this._bar_color="rgba(255,190,92,0.5)"}chart_wrapper.prototype.render=function(){const t=this;this.div_wrapper.replaceChildren(),this.controls_container=void 0,this.download_chart_container=common.create_dom_element({element_type:"div",id:"download_chart_container",class_name:"o-purple",parent:this.div_wrapper});const e=common.create_dom_element({element_type:"select",id:"chart_export_format",parent:this.download_chart_container});for(const t of this.get_supported_export_formats())common.create_dom_element({element_type:"option",value:t,text_content:t.toUpperCase(),parent:e});common.create_dom_element({element_type:"button",text_content:"Download",parent:this.download_chart_container}).addEventListener("click",(()=>{t.download_chart(e.value)}))},chart_wrapper.prototype.download_chart=function(t){const e=`chart.${t}`,r=`download_chart_as_${t}`;if(console.log(r),void 0===this[r])throw new Error(`${r} is not implemented!`);this[r](e)},chart_wrapper.prototype.get_supported_export_formats=function(){throw new Error("Abstract method 'chart_wrapper.download_chart' cannot be called")},Object.setPrototypeOf(chartjs_chart_wrapper.prototype,chart_wrapper.prototype),chartjs_chart_wrapper.prototype.render=function(){chart_wrapper.prototype.render.call(this),this.canvas=common.create_dom_element({element_type:"canvas",id:"result_graph",class_name:"o-blue",parent:this.div_wrapper}),this.chart=void 0},chartjs_chart_wrapper.prototype.get_supported_export_formats=function(){return["png"]},chartjs_chart_wrapper.prototype.download_chart_as_png=function(t){let e=common.create_dom_element({element_type:"a",href:this.chart.toBase64Image()});e.setAttribute("download",t),e.click(),e.remove()},chartjs_chart_wrapper.prototype.download_chart_as_svg=function(t){this._tweak_c2s();const e=this.canvas.offsetWidth,r=this.canvas.offsetHeight;this.chart.options.animation=!1,this.chart.options.reponsive=!1;const n=C2S(e,r);new Chart(n,this.chart.config._config);let o=common.create_dom_element({element_type:"a",href:"data:image/svg+xml;utf8,"+encodeURIComponent(n.getSerializedSvg())});o.setAttribute("download",t),o.click(),o.remove(),this.chart.options.animation=!0,this.chart.options.reponsive=!0},chartjs_chart_wrapper.prototype._tweak_c2s=function(){C2S.prototype.getContext=function(t){return"2d"===t||"2D"===t?this:null},C2S.prototype.style=function(){return this.__canvas.style},C2S.prototype.getAttribute=function(t){return this[t]},C2S.prototype.addEventListener=function(t,e,r){}},Object.setPrototypeOf(histogram_wrapper.prototype,chartjs_chart_wrapper.prototype),histogram_wrapper.prototype.get_density=function(){return this._density},histogram_wrapper.prototype.set_density=function(t){if(this._density=t,!this.chart)return;const[e,r,n,o,a]=this._get_plotting_data();this.chart.data.datasets[0].label=this._get_density_string(),this.chart.data.datasets[0].data=r,this.chart.options.scales.y.title.text=this._get_density_string(),this.chart.update()},histogram_wrapper.prototype._get_density_string=function(){return this._density?"Density":"Frequency"},histogram_wrapper.prototype.get_n_bins=function(){return this._n_bins},histogram_wrapper.prototype.set_n_bins=function(t){if(this._n_bins=t,!this.chart)return;const[e,r,n,o,a]=this._get_plotting_data();this.chart.data.datasets[0].data=r,this.chart.options.scales.x.min=o,this.chart.options.scales.x.max=a,this.chart.options.scales.x.ticks.stepSize=2*n,this.chart.options.plugins.tooltip.callbacks.title=this._get_tooltip_title_callback(e,n),this.chart.update()},histogram_wrapper.prototype.get_bar_color=function(){return this._bar_color},histogram_wrapper.prototype.set_bar_color=function(t){this._bar_color=t,this.chart&&(this.chart.data.datasets[0].backgroundColor=this._bar_color,this.chart.update())},histogram_wrapper.prototype._get_plotting_data=function(){const t=Math.max(...this._data),e=Math.min(...this._data),r=(t-e)/this._n_bins,n=.5*r,o=Array.apply(null,Array(this._n_bins)).map(((t,r)=>e+(2*r+1)*n));let a=Array.apply(null,Array(this._n_bins)).map((()=>0));for(let e=0;e<this._data.length;e++)if(this._data[e]!==t){for(let t=0;t<this._n_bins;t++)if(this._data[e]>=o[t]-n&&this._data[e]<o[t]+n){a[t]++;break}}else a[this._n_bins-1]++;if(this._density){const t=a.reduce(((t,e)=>t+e),0);for(let e=0;e<this._n_bins;e++)a[e]/=t*r}return[o,o.map(((t,e)=>({x:t,y:a[e]}))),n,e,t]},histogram_wrapper.prototype._get_tooltip_title_callback=function(t,e){const r=this._xlabel,n=this._n_decimals;return function(o){if(!o.length)return"";const a=o[0].dataIndex,i=t[a]-e,s=t[a]+e;return`${r}: ${i.toFixed(n)} - ${s.toFixed(n)}`}},histogram_wrapper.prototype.render=function(){chartjs_chart_wrapper.prototype.render.call(this),this._render_chart(),this._render_control_panel()},histogram_wrapper.prototype._render_chart=function(){this._n_bins=this._n_bins_default;const[t,e,r,n,o]=this._get_plotting_data(),a={datasets:[{label:this._get_density_string(),data:e,categoryPercentage:1,barPercentage:1,backgroundColor:this._bar_color}]},i={x:{type:"linear",min:n,max:o,offset:!1,grid:{offset:!1},ticks:{stepSize:2*r,callback:(t,e,r)=>Number(t).toFixed(this._n_decimals)},title:{display:!0,text:this._xlabel,font:{size:14}}},y:{title:{display:!0,text:this._get_density_string(),font:{size:14}}}},s={legend:{display:!1},tooltip:{callbacks:{title:this._get_tooltip_title_callback(t,r)}}};this.chart=new Chart(this.canvas,{type:"bar",data:a,options:{scales:i,plugins:s,parsing:!1,normalized:!0}})},histogram_wrapper.prototype._render_control_panel=function(){const t=this;this.controls_container=common.create_dom_element({element_type:"div",id:"controls",class_name:"o-green",parent:this.div_wrapper});const e=common.create_dom_element({element_type:"input",type:"range",value:this._n_bins_default,parent:this.controls_container});e.setAttribute("min",1),e.setAttribute("max",this._max_bins_multiplier*this._n_bins_default),e.addEventListener("input",(()=>{this.set_n_bins(Number(e.value))}));common.create_dom_element({element_type:"button",type:"button",text_content:"Reset",parent:this.controls_container}).addEventListener("click",(()=>{e.value=this._n_bins_default,this.set_n_bins(Number(e.value))}));const r=common.create_dom_element({element_type:"input",type:"checkbox",id:"density_checkbox",parent:this.controls_container});common.create_dom_element({element_type:"label",text_content:"Density",parent:this.controls_container}).setAttribute("for","density_checkbox"),r.addEventListener("change",(()=>{this.set_density(Boolean(r.checked))}));const n=common.create_dom_element({element_type:"div",id:"color_picker_container",parent:this.controls_container});new window.iro.ColorPicker(n,{color:this._bar_color,width:200,layoutDirection:"horizontal",layout:[{component:window.iro.ui.Wheel},{component:window.iro.ui.Slider},{component:window.iro.ui.Slider,options:{sliderType:"alpha"}}]}).on("color:change",(function(e){t.set_bar_color(e.rgbaString)}))};
//# sourceMappingURL=analysis-min.js.map