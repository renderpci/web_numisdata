"use strict";var catalog={trigger_url:page_globals.__WEB_TEMPLATE_WEB__+"/catalog/trigger.catalog.php",search_options:{},selected_term_table:null,filters:{},filter_op:"AND",draw_delay:10,form_items:[],set_up:function(e){const t=this,n=document.getElementById("items_container"),r=t.build_form();if(n.appendChild(r),e.global_search&&e.global_search.length>1){const n=document.getElementById("global_search");n&&(n.value=e.global_search,event_manager.fire_event(n,"change"),t.form_submit(r))}return!0},create_form_item:function(e){const t=forms.build_form_item(e);return forms.build_form_node(t,e.parent),e.callback&&e.callback(t.node_input),this.form_items[e.id]=t,t},build_form:function(){const e=this,t=new DocumentFragment,n=common.create_dom_element({element_type:"div",class_name:"form-row fields",parent:t});e.create_form_item({id:"global_search",name:"global_search",label:tstring.global_search||"global_search",q_column:"global_search",eq:"LIKE",eq_in:"%",eq_out:"%",parent:n,callback:function(e){}}),e.create_form_item({id:"mint",name:"mint",label:tstring.mint||"mint",q_column:"p_mint",eq:"LIKE",eq_in:"%",is_term:!0,parent:n,callback:function(t){e.activate_autocomplete(t)}}),e.create_form_item({id:"period",name:"period",label:tstring.period||"period",q_column:"p_period",eq_in:"%",is_term:!0,parent:n,callback:function(t){e.activate_autocomplete(t)}}),e.create_form_item({id:"culture",name:"culture",label:tstring.culture||"culture",q_column:"p_culture",eq_in:"%",is_term:!0,parent:n,callback:function(t){e.activate_autocomplete(t)}}),e.create_form_item({id:"creator",name:"creator",label:tstring.creator||"creator",q_column:"p_creator",eq_in:"%",is_term:!0,parent:n,callback:function(t){e.activate_autocomplete(t)}}),e.create_form_item({id:"design_obverse",name:"design_obverse",label:tstring.design_obverse||"design obverse",q_column:"ref_type_design_obverse",eq_in:"%",is_term:!1,parent:n,callback:function(t){e.activate_autocomplete(t)}}),e.create_form_item({id:"design_reverse",name:"design_reverse",label:tstring.design_reverse||"design reverse",q_column:"ref_type_design_reverse",eq_in:"%",is_term:!1,parent:n,callback:function(t){e.activate_autocomplete(t)}}),e.create_form_item({id:"symbol_obverse",name:"symbol_obverse",label:tstring.symbol_obverse||"symbol obverse",q_column:"ref_type_symbol_obverse",eq_in:"%",is_term:!1,parent:n,callback:function(t){e.activate_autocomplete(t)}}),e.create_form_item({id:"symbol_reverse",name:"symbol_reverse",label:tstring.symbol_reverse||"symbol reverse",q_column:"ref_type_symbol_reverse",eq_in:"%",is_term:!1,parent:n,callback:function(t){e.activate_autocomplete(t)}}),e.create_form_item({id:"legend_obverse",name:"legend_obverse",label:tstring.legend_obverse||"legend obverse",q_column:"ref_type_legend_obverse",eq_in:"%",is_term:!1,parent:n,callback:function(t){e.activate_autocomplete(t)}}),e.create_form_item({id:"legend_reverse",name:"legend_reverse",label:tstring.legend_reverse||"legend reverse",q_column:"ref_type_legend_reverse",eq_in:"%",is_term:!1,parent:n,callback:function(t){e.activate_autocomplete(t)}}),e.create_form_item({id:"territory",name:"territory",label:tstring.territory||"territory",q_column:"p_territory",eq_in:"%",is_term:!0,parent:n,callback:function(t){e.activate_autocomplete(t)}}),e.create_form_item({id:"group",name:"group",label:tstring.group||"group",q_column:"p_group",eq_in:"%",is_term:!0,parent:n,callback:function(t){e.activate_autocomplete(t)}}),e.create_form_item({id:"material",name:"material",q_column:"ref_type_material",q_table:"any",label:tstring.material||"material",is_term:!1,parent:n,callback:function(t){e.activate_autocomplete(t)}}),e.create_form_item({id:"collection",name:"collection",q_column:"ref_coins_collection",q_table:"any",label:tstring.collection||"collection",is_term:!1,parent:n,callback:function(t){e.activate_autocomplete(t)}}),e.create_form_item({id:"denomination",name:"denomination",q_column:"ref_type_denomination",q_table:"any",label:tstring.denomination||"denomination",is_term:!1,parent:n,callback:function(t){e.activate_autocomplete(t)}}),n.appendChild(forms.build_operators_node());const r=common.create_dom_element({element_type:"div",class_name:"form-group field",parent:t});common.create_dom_element({element_type:"input",type:"submit",id:"submit",value:tstring.buscar||"Search",class_name:"btn btn-light btn-block primary",parent:r}).addEventListener("click",(function(t){t.preventDefault(),e.form_submit(o)}));const o=common.create_dom_element({element_type:"form",id:"search_form",class_name:"form-inline"});return o.appendChild(t),o},add_selected_value:function(e,t,n){const r=e.node_values,o=r.querySelectorAll(".input_values");for(let e=o.length-1;e>=0;e--)if(n===o[e].value)return!1;const l=common.create_dom_element({element_type:"div",class_name:"line_value",parent:r});common.create_dom_element({element_type:"i",class_name:"icon fa-trash",parent:l}).addEventListener("click",(function(){const t=e.q_selected.indexOf(n);t>-1&&(e.q_selected.splice(t,1),this.parentNode.remove(),!0===SHOW_DEBUG&&console.log("form_item.q_selected removed value:",n,e.q_selected))}));common.create_dom_element({element_type:"span",class_name:"value_label",inner_html:t,parent:l});return common.create_dom_element({element_type:"input",class_name:"input_values",parent:l}).value=n,e.q_selected.push(n),e.node_input.value="",e.q="",!0},activate_autocomplete:function(e){const t=this;let n;!function(e){var t=e.ui.autocomplete.prototype,n=t._initSource;e.extend(t,{_initSource:function(){this.options.html&&e.isArray(this.options.source)?this.source=function(t,n){var r,o,l;n((r=this.options.source,o=t.term,l=new RegExp(e.ui.autocomplete.escapeRegex(o),"i"),e.grep(r,(function(t){return l.test(e("<div>").html(t.label||t.value||t).text())}))))}:n.call(this)},_renderItem:function(t,n){for(var r=n.label,o=r.split(" | "),l=[],i=0;i<o.length;i++){var a=o[i];a.length>1&&"<i>.</i>"!==a&&l.push(a)}return r=l.join(" | "),e("<li></li>").data("item.autocomplete",n).append(e("<div></div>")[this.options.html?"html":"text"](r)).appendTo(t)}})}(jQuery);const r={};return $(e).autocomplete({delay:150,minLength:0,html:!0,source:function(o,l){const i=o.term;n=t.form_items[e.id];n.q_name;const a=n.q_column,c={AND:[]},s=(n.eq_in||"")+i+(n.eq_out||"%");c.AND.push({field:a,value:`'${s}'`,op:n.eq,group:a});const _={OR:[]};for(let[e,r]of Object.entries(t.form_items))if(r.id!==n.id){if(r.q.length>0){const e=r.q;_.OR.push({field:r.q_column,value:`'%${e}%'`,op:"LIKE"})}if(r.q_selected.length>0)for(let e=0;e<r.q_selected.length;e++){const t=r.q_selected[e];_.OR.push({field:r.q_column,value:!0===r.is_term?`'%"${t}"%'`:`'${t}'`,op:!0===r.is_term?"LIKE":"="})}}if(_.OR.length>0&&c.AND.push(_),1===c.AND.length&&i in r)return!0===SHOW_DEBUG&&console.warn("Returning values from cache:",r[i]),void l(r[i]);t.search_rows({filter:c,ar_fields:[a+" AS name"],limit:30,order:a+" ASC"}).then(e=>{const t=[],n=e.result.length;for(let r=0;r<n;r++){const n=e.result[r],o=0===n.name.indexOf('["')?JSON.parse(n.name):[n.name];for(let e=0;e<o.length;e++){const n=o[e];t.find(e=>e.value===n)||t.push({label:n,value:n})}}1===c.AND.length&&(r[i]=t),SHOW_DEBUG,l(t)})},select:function(e,r){return e.preventDefault(),t.add_selected_value(n,r.item.label,r.item.value),this.value="",!1},focus:function(){return!1},close:function(e,t){},change:function(e,t){},response:function(e,t){}}).on("keydown",(function(e){e.keyCode===$.ui.keyCode.ENTER&&$(this).autocomplete("close")})).focus((function(){$(this).autocomplete("search",null)})).blur((function(){})),!0},form_submit:function(e){const t=this,n=t.form_items;console.log("form_items:",n);const r=[];for(let[e,t]of Object.entries(n))!0===t.is_term&&r.push(t);const o=[];for(let[e,t]of Object.entries(n)){const e=!0===t.is_term?"OR":"AND",n={};if(n[e]=[],t.q.length>0){const r="AND",o={};o[r]=[];const l={field:t.q_column,value:`'%${t.q}%'`,op:t.eq};o[r].push(l),n[e].push(o)}if(t.q_selected.length>0)for(let r=0;r<t.q_selected.length;r++){const o=t.q_selected[r].replace(/(')/g,"''"),l="AND",i={};i[l]=[];const a={field:t.q_column,value:!0===t.is_term?`'%"${o}"%'`:`'${o}'`,op:!0===t.is_term?"LIKE":"="};i[l].push(a),n[e].push(i)}n[e].length>0&&o.push(n)}if(SHOW_DEBUG,o.length<1)return!1;const l={};l[e.querySelector('input[name="operators"]:checked').value]=o;return t.search_rows({filter:l,limit:0,process_result:{fn:"process_result::add_parents_and_children_recursive",columns:[{name:"parents"}]}}).then(e=>{console.log("--- form_submit response:",e);page.parse_catalog_data(e.result);const n=document.querySelector("#rows_list");for(;n.hasChildNodes();)n.removeChild(n.lastChild);if(page.add_spinner(n),setTimeout(()=>{t.draw_rows({target:"rows_list",ar_rows:e.result})},t.draw_delay),e.result.length>0){const e=document.querySelector(".result");e&&e.scrollIntoView({behavior:"smooth",block:"start",inline:"nearest"})}})},search_rows:function(e){const t=e.filter||null,n=e.ar_fields||["*"],r=e.order||"norder ASC",o=null!=e.limit?e.limit:30,l=page_globals.WEB_CURRENT_LANG_CODE,i=e.process_result||null,a=[],c=function(e){if(e){const t=Object.keys(e)[0],n=e[t],r=[],o=n.length;for(let e=0;e<o;e++){const t=n[e],o=Object.keys(t)[0];if("AND"===o||"OR"===o){const e="("+c(t)+")";r.push(e);continue}const l=t.value,i=-1!==t.field.indexOf("AS")?t.field+" "+t.op+" "+l:"`"+t.field+"` "+t.op+" "+l;r.push(i),t.group&&a.push(t.group)}return r.join(" "+t+" ")}return null},s=c(t);!0===SHOW_DEBUG&&(console.log("--- search_rows parsed sql_filter:"),console.log(s));return data_manager.request({body:{dedalo_get:"records",table:"catalog",ar_fields:n,lang:l,sql_filter:s,limit:o,group:a.length>0?a.join(","):null,count:!1,order:r,process_result:i}})},draw_rows:function(e){const t=this;return new Promise((function(n){const r=e.target,o=e.ar_rows||[],l=(o.length,t.search_options.total,t.search_options.limit,t.search_options.offset,document.getElementById(r));return async function(){const e=new DocumentFragment,n=o.filter(e=>"mints"===e.term_table),r=[];for(let e=0;e<n.length;e++){const t=JSON.parse(n[e].parent)[0],l=o.find(e=>e.section_id===t);if(!l){console.error("mint don't have public parent:",n[e]);continue}void 0===r.find(e=>e.section_id===t)&&r.push(l)}for(let n=0;n<r.length;n++){t.get_children(o,r[n],e)}return e}().then(e=>{for(;l.hasChildNodes();)l.removeChild(l.lastChild);l.appendChild(e);const t=l;page.activate_images_gallery(t,!0),n(l)}),!0}))},get_children:function(e,t,n){const r=this,o=JSON.parse(t.children),l=common.create_dom_element({element_type:"div",class_name:"children_contanier"});if(n.appendChild(l),o)for(let t=0;t<o.length;t++)r.get_child(e,o[t],l)},get_child:function(e,t,n){const r=this,o=e.find(e=>e.section_id===t);if(o){const t=r.render_rows(o);n.appendChild(t),o.children&&(r.get_children(e,o,t),t.addEventListener("mouseup",e=>{e.preventDefault();if(("SPAN"===e.target.tagName?e.target.parentNode:e.target)===t.firstChild){t.querySelector(".children_contanier").classList.toggle("hide")}},!1))}},render_rows:function(e){SHOW_DEBUG;return catalog_row_fields.draw_item(e)}};