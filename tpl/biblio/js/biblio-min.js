"use strict";var biblio={trigger_url:page_globals.__WEB_TEMPLATE_WEB__+"/biblio/trigger.biblio.php",search_options:null,set_up:function(e){const t=this,o=document.getElementById("search_form");if(o){const e=o.querySelectorAll("input.form-control"),a=e.length;for(var n=0;n<a;n++)t.activate_autocomplete(e[n]);t.search_rows({ar_query:[],limit:10})}else if("undefined"!=typeof biblio_section_id){var a=[],i={name:"section_id",value:biblio_section_id,search_mode:"string",table:"publicaciones"};a.push(i),t.search_rows({ar_query:a,limit:10})}return!0},set_value:function(e,t){const o=document.getElementById(e.id+"_values"),n=o.querySelectorAll(".input_values");for(var a=n.length-1;a>=0;a--)if(t===n[a].value)return!1;const i=common.create_dom_element({element_type:"div",class_name:"line_value",parent:o});return common.create_dom_element({element_type:"i",class_name:"icon fa-trash",parent:i}).addEventListener("click",(function(){this.parentNode.remove()})),common.create_dom_element({element_type:"input",class_name:"input_values",parent:i,data_set:e.dataset}).value=t,!0},activate_autocomplete:function(e){const t=this;return $(e).autocomplete({delay:150,minLength:0,source:function(o,n){const a=o.term,i=t.trigger_url,l={q:a,mode:e.dataset.mode,q_name:e.dataset.q_name||null,q_table:e.dataset.q_table||null};!0===SHOW_DEBUG&&console.log("[biblio.activate_autocomplete] trigger_vars:",l),common.get_json_data(i,l).then((function(t){console.log("[biblio.activate_autocomplete] response_data",t);const o="fecha_publicacion"===e.id?t.result.map(e=>(e.label=e.label.substring(0,4),e)):t.result;n(o)}),(function(e){console.error("[activate_autocomplete] Failed get_json!",e)}))},select:function(e,o){return e.preventDefault(),t.set_value(this,o.item.label),this.value="",!1},focus:function(){return!1},close:function(e,t){},change:function(e,t){},response:function(e,t){}}).on("keydown",(function(e){e.keyCode,$.ui.keyCode.ENTER})).focus((function(){$(this).autocomplete("search",null)})),!0},search:function(e,t){t&&t.preventDefault();for(var o=[],n=e.querySelectorAll("input.input_values, input.form-control"),a=n.length,i=0;i<a;i++){var l=n[i];if(l.value.length>0){var r={name:l.dataset.q_name,value:l.value,search_mode:l.dataset.search,table:l.dataset.q_table};o.push(r)}}!0===SHOW_DEBUG&&console.log("search.ar_query:",o);const s=e.querySelector('input[name="operators"]:checked').value;return this.search_rows({ar_query:o,operator:s})},search_rows:function(e){this.search_options=e;const t=document.getElementById("biblio_rows_list");t.style.opacity="0.4";const o=this.trigger_url,n={mode:"search_rows",ar_query:void 0!==e.ar_query?e.ar_query:null,limit:e.limit||10,offset:e.offset||0,count:e.count||!1,total:e.total||!1,order:e.order||"section_id ASC",operator:e.operator||"OR"};return!0===SHOW_DEBUG&&console.log("[biblio.search_rows] trigger_vars:",n),common.get_json_data(o,n).then((function(e){!0===SHOW_DEBUG&&console.log("[biblio.search_rows] get_json_data response:",e),e?biblio.draw_rows({target:"biblio_rows_list",ar_rows:e.result.result,total:e.result.total,limit:n.limit,offset:n.offset}):console.warn("[biblio.search_rows] Error. Received response data is null"),t.style.opacity="1"}))},draw_rows:function(e){const t=e.ar_rows,o=t.length,n=document.getElementById(e.target);for(;n.hasChildNodes();)n.removeChild(n.lastChild);const a=new DocumentFragment,i=common.create_dom_element({element_type:"div",class_name:"pagination top"});i.appendChild(this.draw_paginator({total:e.total,limit:e.limit,offset:e.offset,count:o})),a.appendChild(i);let l=new Intl.Collator("es",{sensitivity:"base",ignorePunctuation:!0});t.sort((e,t)=>{let o=e.autoria+" "+e.fecha_publicacion,n=t.autoria+" "+t.fecha_publicacion;return l.compare(o,n)});for(var r=0;r<o;r++){const e=t[r],o=common.create_dom_element({element_type:"div",class_name:"biblio_row_wrapper",parent:a,data_set:{section_id:e.section_id}});var s=common.create_dom_element({element_type:"div",parent:o,class_name:"row_title"});if(e.autoria&&e.autoria.length>0){for(var c=e.autoria_dato,_=c.length,m=[],u=0;u<_;u++){let e=c[u].apellidos+", "+c[u].nombre;m.push(e)}let t=m.join("; ");var p=common.create_dom_element({element_type:"div",parent:s,class_name:"autoria info_line"});common.create_dom_element({element_type:"div",parent:p,class_name:"info_value",text_content:t})}if(e.fecha_publicacion){var d=e.fecha_publicacion.split("-"),f=parseInt(d[0]);d[1],parseInt(d[1])>0&&(f=f+"-"+parseInt(d[1])),d[2],parseInt(d[2])>0&&(f=f+"-"+parseInt(d[2]));p=common.create_dom_element({element_type:"div",class_name:"fecha_publicacion info_line",parent:o});common.create_dom_element({element_type:"div",parent:p,class_name:"info_value",text_content:f})}const n=common.create_dom_element({element_type:"div",parent:o,class_name:"row_body"}),i=e.titulo||"";if(common.create_dom_element({element_type:"h1",parent:n,text_content:i}),e.series_colecciones||e.numero_serie){var h=[];e.series_colecciones&&h.push(e.series_colecciones),e.numero_serie&&h.push(e.numero_serie),common.create_dom_element({element_type:"em",parent:n,class_name:"series_colecciones",text_content:h.join(" ")})}if(e.lugar_publicacion){p=common.create_dom_element({element_type:"div",parent:n,class_name:"lugar_publicacion info_line"});common.create_dom_element({element_type:"div",parent:p,class_name:"info_value",text_content:e.lugar_publicacion})}if(e.description_fisica){p=common.create_dom_element({element_type:"div",parent:n,class_name:"description_fisica info_line"});var v=", ";0==e.lugar_publicacion&&(v=""),common.create_dom_element({element_type:"div",parent:p,class_name:"info_value",text_content:v+e.description_fisica})}}const g=common.create_dom_element({element_type:"div",class_name:"pagination bottom"});return g.appendChild(this.draw_paginator({total:e.total,limit:e.limit,offset:e.offset,count:o})),a.appendChild(g),n.appendChild(a),!0},draw_paginator:function(e){const t=this,o=new DocumentFragment,n=paginator.get_full_paginator({total:e.total,limit:e.limit,offset:e.offset,n_nodes:10,callback:e=>{const o=e.offset,n=e.total;return t.search_options.offset=o,t.search_options.total=n,t.search_rows(t.search_options)}});o.appendChild(n),common.create_dom_element({element_type:"div",class_name:"spacer",parent:o});const a=paginator.get_totals_node({total:e.total,limit:e.limit,offset:e.offset,count:e.count});return o.appendChild(a),o}};