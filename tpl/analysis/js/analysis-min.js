var analysis_min=function(exports){"use strict";const t=["#1f77b4","#ff7f0e","#2ca02c","#d62728","#9467bd","#8c564b","#e377c2","#7f7f7f","#bcbd22","#17becf"];function e(t){if(this.constructor===e)throw new Error("Abstract class 'chart_wrapper' cannot be instantiated");e._n_charts_created++,this.id=e._n_charts_created,this.div_wrapper=t,this.download_chart_container=void 0,this.controls_container=void 0}function r(t){if(this.constructor===r)throw new Error("Abstract class 'd3_chart_wrapper' cannot be instantiated");e.call(this,t),this.svg=void 0}function n(t){0==t.attr("opacity")?t.transition().attr("opacity",1):t.transition().attr("opacity",0)}function a(t,e,r){const n=(e-t)/(r-1);return d3.range(r).map((e=>t+e*n))}function o(){}function i(t,e,n){r.call(this,t),this._data=e,this._ylabel=n,this._metrics={};for(const[t,r]of Object.entries(e))this._metrics[t]=s(r);this._outliers={};for(const[t,r]of Object.entries(e))this._outliers[t]=r.filter((e=>e<this._metrics[t].lower_fence||e>this._metrics[t].upper_fence));this._data_extent=d3.extent(Object.values(e).flat()),this._full_width=960,this._full_height=420,this._chart={},this._chart.margin={top:15,right:3,bottom:23,left:50},this._chart.width=this._full_width-this._chart.margin.left-this._chart.margin.right,this._chart.height=this._full_height-this._chart.margin.top-this._chart.margin.bottom,this._chart.yscale=d3.scaleLinear().range([this._chart.height,0]).domain(this._data_extent).clamp(!0),this._chart.yaxis=d3.axisLeft(this._chart.yscale),this._chart.violin_scale_default=.8,this._chart.violin_scale=this._chart.violin_scale_default,this._chart.box_scale_default=.3,this._chart.box_scale=this._chart.box_scale_default,this._chart.xscale=d3.scaleBand().domain(Object.keys(this._data)).range([0,this._chart.width]),this._chart.xaxis=d3.axisBottom(this._chart.xscale),this._chart.histogram={};for(const[t,r]of Object.entries(e)){const e=d3.extent(r);this._chart.histogram[t]=d3.bin().domain(e).thresholds(a(e[0],e[1],o.sturges(r))).value((t=>t))}this._chart.bins=Object.entries(e).map((([t,e])=>({key:t,value:this._chart.histogram[t](e)}))),this._graphics={root_g:null,violins_g:null,boxes_g:null,outliers:{}}}function s(t){const e={max:null,upper_fence:null,quartile3:null,median:null,mean:null,iqr:null,quartile1:null,lower_fence:null,min:null};return e.min=d3.min(t),e.quartile1=d3.quantile(t,.25),e.median=d3.median(t),e.mean=d3.mean(t),e.quartile3=d3.quantile(t,.75),e.max=d3.max(t),e.iqr=e.quartile3-e.quartile1,e.lower_fence=e.quartile1-1.5*e.iqr,e.upper_fence=e.quartile3+1.5*e.iqr,e}e._n_charts_created=0,e.prototype.id_string=function(){return`chart${this.id}`},e.prototype.render=function(){const t=this;this.div_wrapper.replaceChildren(),this.controls_container=void 0,this.download_chart_container=common.create_dom_element({element_type:"div",id:"download_chart_container",class_name:"o-purple",style:{display:"flex","flex-direction":"row","justify-content":"center"},parent:this.div_wrapper});const e=common.create_dom_element({element_type:"select",id:"chart_export_format",style:{width:"80%"},parent:this.download_chart_container});for(const t of this.get_supported_export_formats())common.create_dom_element({element_type:"option",value:t,text_content:t.toUpperCase(),parent:e});common.create_dom_element({element_type:"button",text_content:"Download",style:{width:"20%"},parent:this.download_chart_container}).addEventListener("click",(()=>{t.download_chart(e.value)}))},e.prototype.download_chart=function(t){const e=`chart.${t}`,r=`download_chart_as_${t}`;if(void 0===this[r])throw new Error(`${r} is not implemented!`);this[r](e)},e.prototype.get_supported_export_formats=function(){throw new Error("Abstract method 'chart_wrapper.download_chart' cannot be called")},Object.setPrototypeOf(r.prototype,e.prototype),r.prototype.render=function(){e.prototype.render.call(this),this.svg=d3.select(this.div_wrapper).append("svg").attr("version","1.1").attr("xmlns","http://www.w3.org/2000/svg").attr("width","100%")},r.prototype.get_supported_export_formats=function(){return["svg"]},r.prototype.download_chart_as_svg=function(t){const e=this.svg.node().outerHTML,r=new Blob([e],{type:"image/svg+xml;charset=utf-8"}),n=URL.createObjectURL(r),a=common.create_dom_element({element_type:"a",href:n});a.setAttribute("download",t),a.click(),a.remove(),URL.revokeObjectURL(n)},o.sqrt=function(t){return Math.ceil(Math.sqrt(t.length))},o.sturges=function(t){return Math.ceil(Math.log2(t.length))+1},o.rice=function(t){return Math.ceil(2*Math.pow(t.length,1/3))},o.doane=function(t){const e=t.length;if(e<2)throw new Error("Doane's rule needs at least 2 datapoints");const r=Math.sqrt(6*(e-2)/((e+1)*(e+3))),n=d3.deviation(t),a=d3.mean(t),o=d3.sum(t),i=Math.sqrt(e*(e+1))/(e-2)*((o-e*a)/(e*Math.pow(n,3)));return 1+Math.ceil(Math.log2(e))+Math.ceil(Math.log2(1+Math.abs(i)/r))},o.scott=function(t){if(t.length<2)throw new Error("Cannot compute standard deviation of an array with less than 2 values");return Math.ceil((d3.max(t)-d3.min(t))*Math.pow(t.length,1/3)/(3.49*d3.deviation(t)))},o.freedman_diaconis=function(t){const e=d3.quantile(t,.75),r=d3.quantile(t,.25),n=e-r;if(r===e)throw new Error("IQR is 0!");return Math.ceil((d3.max(t)-d3.min(t))*Math.pow(t.length,1/3)/(2*n))},Object.setPrototypeOf(i.prototype,r.prototype),i.prototype.set_violin_scale=function(t){this._chart.violin_scale=t,this._graphics.violins_g.selectAll("*").remove(),this._render_violins(!0)},i.prototype.set_box_scale=function(t){this._chart.box_scale=t,this._graphics.boxes_g.selectAll("*").remove(),this._render_boxes(!0)},i.prototype.render=function(){r.prototype.render.call(this),this._render_chart(),this._render_control_panel()},i.prototype._render_chart=function(){this.svg.attr("viewBox",`0 0 ${this._full_width} ${this._full_height}`),this._graphics.root_g=this.svg.append("g").attr("transform",`translate(${this._chart.margin.left},${this._chart.margin.top})`),this._render_axis(),this._render_violins(),this._render_boxes()},i.prototype._render_axis=function(){const t=this._graphics.root_g;t.append("g").attr("transform",`translate(0,${this._chart.height})`).call(this._chart.xaxis),t.append("g").call(this._chart.yaxis),t.append("text").attr("text-anchor","middle").attr("transform","rotate(-90)").attr("y",20-this._chart.margin.left).attr("x",-this._chart.height/2).text(this._ylabel)},i.prototype._render_violins=function(t=!1){const e=this._chart,r=this._graphics.root_g,n=e.bins.map((t=>d3.max(t.value,(t=>t.length)))).map((t=>d3.scaleLinear().range([0,e.xscale.bandwidth()]).domain([-t,t])));t||(this._graphics.violins_g=r.append("g"));const a=this._graphics.violins_g;for(const[t,r]of Object.entries(e.bins))a.append("g").attr("transform",`translate(${e.xscale(r.key)},0)`).append("path").datum(r.value).style("stroke","gray").style("stroke-width",.4).style("fill","ghostwhite").attr("d",d3.area().x0((r=>n[t](-r.length*e.violin_scale))).x1((r=>n[t](r.length*e.violin_scale))).y((t=>e.yscale(t.x0))).curve(d3.curveCatmullRom))},i.prototype._render_boxes=function(e=!1){const r=this._chart,n=this._graphics.root_g;e||(this._graphics.boxes_g=n.append("g"));const a=this._graphics.boxes_g,o=r.xscale.bandwidth(),i=this._chart.box_scale*o;for(const[e,n]of Object.entries(Object.keys(this._data))){const s=this._metrics[n],c=t[e%t.length],l=a.append("g").attr("transform",`translate(${r.xscale(n)+o/2},0)`);this._graphics.outliers[n]=l.append("g");const _=this._graphics.outliers[n];for(const t of this._outliers[n])_.append("circle").attr("cx",0).attr("cy",r.yscale(t)).attr("r",4).style("fill",c).style("opacity",.7);const h=l.append("g");h.append("line").attr("x1",0).attr("y1",r.yscale(s.lower_fence)).attr("x2",0).attr("y2",r.yscale(s.upper_fence)).attr("stroke",c).attr("stroke-width",2),h.append("line").attr("x1",-i/2).attr("y1",r.yscale(s.lower_fence)).attr("x2",i/2).attr("y2",r.yscale(s.lower_fence)).attr("stroke",c).attr("stroke-width",2),h.append("line").attr("x1",-i/2).attr("y1",r.yscale(s.upper_fence)).attr("x2",i/2).attr("y2",r.yscale(s.upper_fence)).attr("stroke",c).attr("stroke-width",2);const m=l.append("g");m.append("rect").attr("x",-i/2).attr("y",r.yscale(s.quartile3)).attr("width",i).attr("height",r.yscale(s.quartile1)-r.yscale(s.quartile3)).attr("fill",c),m.append("line").attr("x1",-i/2).attr("y1",r.yscale(s.median)).attr("x2",i/2).attr("y2",r.yscale(s.median)).attr("stroke","black").attr("stroke-width",3),m.append("circle").attr("cx",0).attr("cy",r.yscale(s.median)).attr("r",4.5).style("fill","white").attr("stroke","black").attr("stroke-width",2)}},i.prototype._render_control_panel=function(){const t=`${this.id_string()}_controls`;this.controls_container=common.create_dom_element({element_type:"div",id:t,class_name:"o-green",parent:this.div_wrapper});const e=`${this.id_string()}_show_violins_checkbox`,r=common.create_dom_element({element_type:"input",type:"checkbox",id:e,parent:this.controls_container});r.checked=!0;common.create_dom_element({element_type:"label",text_content:"Show violins",parent:this.controls_container}).setAttribute("for",e),r.addEventListener("change",(()=>{n(this._graphics.violins_g)}));const a=`${this.id_string()}_show_boxes_checkbox`,o=common.create_dom_element({element_type:"input",type:"checkbox",id:a,parent:this.controls_container});o.checked=!0;common.create_dom_element({element_type:"label",text_content:"Show boxes",parent:this.controls_container}).setAttribute("for",a),o.addEventListener("change",(()=>{n(this._graphics.boxes_g)}));const i=`${this.id_string()}_show_outliers_checkbox`,s=common.create_dom_element({element_type:"input",type:"checkbox",id:i,parent:this.controls_container});s.checked=!0;common.create_dom_element({element_type:"label",text_content:"Show outliers",parent:this.controls_container}).setAttribute("for",i),s.addEventListener("change",(()=>{for(const t of Object.values(this._graphics.outliers))n(t)}));const c=common.create_dom_element({element_type:"input",type:"range",parent:this.controls_container});c.setAttribute("min",0),c.setAttribute("max",1),c.setAttribute("step",.05),c.value=this._chart.violin_scale_default,c.addEventListener("input",(()=>{this.set_violin_scale(Number(c.value))}));common.create_dom_element({element_type:"button",type:"button",text_content:"Reset",parent:this.controls_container}).addEventListener("click",(()=>{c.value=this._chart.violin_scale_default,this.set_violin_scale(Number(c.value))}));const l=common.create_dom_element({element_type:"input",type:"range",parent:this.controls_container});l.setAttribute("min",0),l.setAttribute("max",1),l.setAttribute("step",.05),l.value=this._chart.box_scale_default,l.addEventListener("input",(()=>{this.set_box_scale(Number(l.value))}));common.create_dom_element({element_type:"button",type:"button",text_content:"Reset",parent:this.controls_container}).addEventListener("click",(()=>{l.value=this._chart.box_scale_default,this.set_box_scale(Number(l.value))}))};const c={form:null,area_name:null,row:null,export_data_container:null,form_items_container:null,diameter_chart_container:null,weight_chart_container:null,diameter_chart_wrapper:null,weight_chart_wrapper:null,set_up:function(t){const e=this;e.area_name=t.area_name,e.export_data_container=t.export_data_container,e.row=t.row,e.form_items_container=t.form_items_container,e.diameter_chart_container=t.diameter_chart_container,e.weight_chart_container=t.weight_chart_container;const r=e.render_form();return e.form_items_container.appendChild(r),!0},render_form:function(){const t=this,e=new DocumentFragment;t.form=t.form||new form_factory;const r=common.create_dom_element({element_type:"div",class_name:"form-row fields",parent:e});t.form.item_factory({id:"mint",name:"mint",label:tstring.mint||"mint",q_column:"p_mint",value_wrapper:['["','"]'],eq:"LIKE",eq_in:"%",eq_out:"%",is_term:!0,parent:r,callback:function(e){t.form.activate_autocomplete({form_item:e,table:"catalog"})}}),t.form.item_factory({id:"number",name:"number",q_column:"term",q_table:"types",label:tstring.number_key||"Number & Key",is_term:!1,parent:r,group_op:"$or",callback:function(e){t.form.activate_autocomplete({form_item:e,table:"catalog"})}}),t.form.item_factory({id:"denomination",name:"denomination",q_column:"ref_type_denomination",q_table:"any",label:tstring.denomination||"denomination",is_term:!1,parent:r,callback:function(e){t.form.activate_autocomplete({form_item:e,table:"catalog"})}});const n=common.create_dom_element({element_type:"div",class_name:"form-group field button_submit",parent:e});common.create_dom_element({element_type:"input",type:"submit",id:"submit",value:tstring.search||"Search",class_name:"btn btn-light btn-block primary",parent:n}).addEventListener("click",(function(e){e.preventDefault(),t.form_submit(o)}));common.create_dom_element({element_type:"input",type:"button",id:"button_reset",value:tstring.reset||"Reset",class_name:"btn btn-light btn-block secondary button_reset",parent:n}).addEventListener("click",(function(t){t.preventDefault(),window.location.replace(window.location.pathname)}));const a=t.form.build_operators_node();e.appendChild(a);const o=common.create_dom_element({element_type:"form",id:"search_form",class_name:"form-inline"});return o.appendChild(e),o},form_submit:function(t,e={}){const r=this,n="boolean"!=typeof e.scroll_result||e.scroll_result,a=e.form_items||r.form.form_items,o=r.form.build_filter({form_items:a});if(!o||o.length<1)return!1;n&&this.diameter_chart_container.scrollIntoView({behavior:"smooth",block:"start",inline:"nearest"}),r.search_rows({filter:o,limit:0,process_result:{fn:"process_result::add_parents_and_children_recursive",columns:[{name:"parents"}]}}).then((t=>{event_manager.publish("form_submit",t),console.log(t);const e={};for(const r of t){const t=r.ref_type_number;if(!["12","59","62","18","11a","14"].includes(t))continue;const n={},a=r.full_coins_reference_calculable,o=r.full_coins_reference_diameter_max,i=r.full_coins_reference_diameter_min,s=r.full_coins_reference_weight;o&&o.length&&(n.diameter_max=o.filter(((t,e)=>t&&a[e]))),i&&i.length&&(n.diameter_min=i.filter(((t,e)=>t&&a[e]))),s&&s.length&&(n.weight=s.filter(((t,e)=>t&&a[e]))),Object.keys(n).length&&(e[t]=n)}console.log(e);const r={};for(const[t,n]of Object.entries(e))r[t]=n.diameter_max;this.diameter_chart_wrapper=new i(this.diameter_chart_container,r,"Diameter"),this.diameter_chart_wrapper.render();const n={};for(const[t,r]of Object.entries(e))n[t]=r.weight;this.weight_chart_wrapper=new i(this.weight_chart_container,n,"Weight"),this.weight_chart_wrapper.render()}))},search_rows:function(t){const e=this,r=t.filter||null,n=t.ar_fields||["*"],a=t.order||"norder ASC",o=page_globals.WEB_CURRENT_LANG_CODE,i=t.process_result||null,s=null!=t.limit?t.limit:30;return new Promise((function(t){const c=[],l=e.form.parse_sql_filter(r),_={dedalo_get:"records",table:"catalog",ar_fields:n,lang:o,sql_filter:l,limit:s,group:c.length>0?c.join(","):null,count:!1,order:a,process_result:i};data_manager.request({body:_}).then((e=>{const r=page.parse_catalog_data(e.result);t(r)}))}))}};return exports.analysis=c,Object.defineProperty(exports,"__esModule",{value:!0}),exports}({});
//# sourceMappingURL=analysis-min.js.map