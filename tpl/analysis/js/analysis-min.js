var analysis_min=function(exports){"use strict";const t="rgba(255,190,92,0.5)";function e(t){if(this.constructor===e)throw new Error("Abstract class 'chart_wrapper' cannot be instantiated");this.div_wrapper=t,this.download_chart_container=void 0,this.controls_container=void 0}function r(t){if(this.constructor===r)throw new Error("Abstract class 'chartjs_chart_wrapper' cannot be instantiated");e.call(this,t),this.canvas=void 0,this.chart=void 0}function n(e,n,o){r.call(this,e),this._data=n,this._density=!1,this._n_bins_default=Math.ceil(Math.sqrt(this._data.length)),this._n_bins=void 0,this._xlabel=o,this._n_decimals=3,this._max_bins_multiplier=3,this._bar_color=t}function o(e,n,o){r.call(this,e),this._data=void 0,Array.isArray(n)?(this._check_array_valid(n),this._data=this._parse_array(n)):(this._check_object_valid(n),this._data=this._parse_object(n)),this._ylabel=o,this._bar_colors=Array(this._data.labels.length).fill(t)}function a(t){if(this.constructor===a)throw new Error("Abstract class 'd3_chart_wrapper' cannot be instantiated");e.call(this,t),this.svg=void 0}e.prototype.render=function(){const t=this;this.div_wrapper.replaceChildren(),this.controls_container=void 0,this.download_chart_container=common.create_dom_element({element_type:"div",id:"download_chart_container",class_name:"o-purple",style:{display:"flex","flex-direction":"row","justify-content":"center"},parent:this.div_wrapper});const e=common.create_dom_element({element_type:"select",id:"chart_export_format",style:{width:"80%"},parent:this.download_chart_container});for(const t of this.get_supported_export_formats())common.create_dom_element({element_type:"option",value:t,text_content:t.toUpperCase(),parent:e});common.create_dom_element({element_type:"button",text_content:"Download",style:{width:"20%"},parent:this.download_chart_container}).addEventListener("click",(()=>{t.download_chart(e.value)}))},e.prototype.download_chart=function(t){const e=`chart.${t}`,r=`download_chart_as_${t}`;if(void 0===this[r])throw new Error(`${r} is not implemented!`);this[r](e)},e.prototype.get_supported_export_formats=function(){throw new Error("Abstract method 'chart_wrapper.download_chart' cannot be called")},Object.setPrototypeOf(r.prototype,e.prototype),r.prototype.render=function(){e.prototype.render.call(this),this.canvas=common.create_dom_element({element_type:"canvas",id:"result_graph",class_name:"o-blue",parent:this.div_wrapper}),this.chart=void 0},r.prototype.get_supported_export_formats=function(){return["png"]},r.prototype.download_chart_as_png=function(t){const e=common.create_dom_element({element_type:"a",href:this.chart.toBase64Image()});e.setAttribute("download",t),e.click(),e.remove()},r.prototype.download_chart_as_svg=function(t){this._tweak_c2s();const e=this.canvas.offsetWidth,r=this.canvas.offsetHeight;this.chart.options.animation=!1,this.chart.options.reponsive=!1;const n=C2S(e,r);new Chart(n,this.chart.config._config);const o=common.create_dom_element({element_type:"a",href:"data:image/svg+xml;utf8,"+encodeURIComponent(n.getSerializedSvg())});o.setAttribute("download",t),o.click(),o.remove(),this.chart.options.animation=!0,this.chart.options.reponsive=!0},r.prototype._tweak_c2s=function(){C2S.prototype.getContext=function(t){return"2d"===t||"2D"===t?this:null},C2S.prototype.style=function(){return this.__canvas.style},C2S.prototype.getAttribute=function(t){return this[t]},C2S.prototype.addEventListener=function(t,e,r){}},Object.setPrototypeOf(n.prototype,r.prototype),n.prototype.get_density=function(){return this._density},n.prototype.set_density=function(t){if(this._density=t,!this.chart)return;const[e,r,n,o,a]=this._get_plotting_data();this.chart.data.datasets[0].label=this._get_density_string(),this.chart.data.datasets[0].data=r,this.chart.options.scales.y.title.text=this._get_density_string(),this.chart.update()},n.prototype._get_density_string=function(){return this._density?"Density":"Frequency"},n.prototype.get_n_bins=function(){return this._n_bins},n.prototype.set_n_bins=function(t){if(this._n_bins=t,!this.chart)return;const[e,r,n,o,a]=this._get_plotting_data();this.chart.data.datasets[0].data=r,this.chart.options.scales.x.min=o,this.chart.options.scales.x.max=a,this.chart.options.scales.x.ticks.stepSize=2*n,this.chart.options.plugins.tooltip.callbacks.title=this._get_tooltip_title_callback(e,n),this.chart.update()},n.prototype.get_bar_color=function(){return this._bar_color},n.prototype.set_bar_color=function(t){this._bar_color=t,this.chart&&(this.chart.data.datasets[0].backgroundColor=this._bar_color,this.chart.update())},n.prototype._get_plotting_data=function(){const t=Math.max(...this._data),e=Math.min(...this._data),r=(t-e)/this._n_bins,n=.5*r,o=Array.apply(null,Array(this._n_bins)).map(((t,r)=>e+(2*r+1)*n));let a=Array.apply(null,Array(this._n_bins)).map((()=>0));for(let e=0;e<this._data.length;e++)if(this._data[e]!==t){for(let t=0;t<this._n_bins;t++)if(this._data[e]>=o[t]-n&&this._data[e]<o[t]+n){a[t]++;break}}else a[this._n_bins-1]++;if(this._density){const t=a.reduce(((t,e)=>t+e),0);for(let e=0;e<this._n_bins;e++)a[e]/=t*r}return[o,o.map(((t,e)=>({x:t,y:a[e]}))),n,e,t]},n.prototype._get_tooltip_title_callback=function(t,e){const r=this._xlabel,n=this._n_decimals;return function(o){if(!o.length)return"";const a=o[0].dataIndex,i=t[a]-e,s=t[a]+e;return`${r}: ${i.toFixed(n)} - ${s.toFixed(n)}`}},n.prototype.render=function(){r.prototype.render.call(this),this._render_chart(),this._render_control_panel()},n.prototype._render_chart=function(){this._n_bins=this._n_bins_default;const[t,e,r,n,o]=this._get_plotting_data(),a={datasets:[{label:this._get_density_string(),data:e,categoryPercentage:1,barPercentage:1,backgroundColor:this._bar_color}]},i={x:{type:"linear",min:n,max:o,offset:!1,grid:{offset:!1},ticks:{stepSize:2*r,callback:(t,e,r)=>Number(t).toFixed(this._n_decimals)},title:{display:!0,text:this._xlabel,font:{size:14}}},y:{title:{display:!0,text:this._get_density_string(),font:{size:14}}}},s={legend:{display:!1},tooltip:{callbacks:{title:this._get_tooltip_title_callback(t,r)}}};this.chart=new Chart(this.canvas,{type:"bar",data:a,options:{scales:i,plugins:s,parsing:!1,normalized:!0}})},n.prototype._render_control_panel=function(){const t=this;this.controls_container=common.create_dom_element({element_type:"div",id:"controls",class_name:"o-green",parent:this.div_wrapper});const e=common.create_dom_element({element_type:"input",type:"range",value:this._n_bins_default,parent:this.controls_container});e.setAttribute("min",1),e.setAttribute("max",this._max_bins_multiplier*this._n_bins_default),e.addEventListener("input",(()=>{this.set_n_bins(Number(e.value))}));common.create_dom_element({element_type:"button",type:"button",text_content:"Reset",parent:this.controls_container}).addEventListener("click",(()=>{e.value=this._n_bins_default,this.set_n_bins(Number(e.value))}));const r=common.create_dom_element({element_type:"input",type:"checkbox",id:"density_checkbox",parent:this.controls_container});common.create_dom_element({element_type:"label",text_content:"Density",parent:this.controls_container}).setAttribute("for","density_checkbox"),r.addEventListener("change",(()=>{this.set_density(Boolean(r.checked))}));const n=common.create_dom_element({element_type:"div",id:"color_picker_container",parent:this.controls_container});new window.iro.ColorPicker(n,{color:this._bar_color,width:200,layoutDirection:"horizontal",layout:[{component:window.iro.ui.Wheel},{component:window.iro.ui.Slider},{component:window.iro.ui.Slider,options:{sliderType:"alpha"}}]}).on("color:change",(function(e){t.set_bar_color(e.rgbaString)}))},Object.setPrototypeOf(o.prototype,r.prototype),o.prototype._check_array_valid=function(t){if(!t.length)throw new Error("Input array is empty!");const e=typeof t[0];if("number"!==e&&"string"!==e)throw new Error("Input array is not made of numbers or strings");for(const r of t.slice(1))if(typeof r!==e)throw new Error("Input array combines multiple types")},o.prototype._parse_array=function(t){const e=t.filter(((t,e,r)=>r.indexOf(t)===e)),r=e.map((e=>t.filter((t=>t===e)).length));return{labels:e,values:r}},o.prototype._check_object_valid=function(t){if(!t)throw new Error("Input data object is null or undefined");if(!Object.keys(t).length)throw new Error("Input data object is empty");const e=Object.values(t);for(const t of e)if("number"!=typeof t)throw new Error("A value in the input data object is not a number")},o.prototype._parse_object=function(t){return{labels:Object.keys(t),values:Object.values(t)}},o.prototype.get_bar_colors=function(){return this._bar_colors},o.prototype.set_bar_colors=function(t){this._bar_colors=t,this.chart.data.datasets[0].backgroundColor=t,this.chart.update()},o.prototype.set_bar_color=function(t,e){if("number"!=typeof t)throw new Error("Index is not a number");if(!Number.isInteger(t))throw new Error("Index is not an integer");if(t<0||t>=this._data.labels.length)throw new Error("Index is out of bounds");this._bar_colors[t]=e,this.chart.data.datasets[0].backgroundColor[t]=e,this.chart.update()},o.prototype.render=function(){r.prototype.render.call(this),this._render_chart(),this._render_control_panel()},o.prototype._render_chart=function(){const t={labels:this._data.labels,datasets:[{label:this._ylabel,data:this._data.values,backgroundColor:this._bar_colors}]},e={y:{title:{display:!0,text:this._ylabel,font:{size:14}}}};this.chart=new Chart(this.canvas,{type:"bar",data:t,options:{scales:e,plugins:{legend:{display:!1}},normalized:!0}})},o.prototype._render_control_panel=function(){const t=this;this.controls_container=common.create_dom_element({element_type:"div",id:"controls",class_name:"o-green",parent:this.div_wrapper});const e=common.create_dom_element({element_type:"select",id:"bar_selection",parent:this.controls_container});for(const[t,r]of this._data.labels.entries())common.create_dom_element({element_type:"option",value:String(t),text_content:r,parent:e});const r=common.create_dom_element({element_type:"div",id:"color_picker_container",parent:this.controls_container}),n=new window.iro.ColorPicker(r,{color:this._bar_colors[0],width:200,layoutDirection:"horizontal",layout:[{component:window.iro.ui.Wheel},{component:window.iro.ui.Slider},{component:window.iro.ui.Slider,options:{sliderType:"alpha"}}]});e.addEventListener("change",(()=>{const r=Number(e.value);n.color.set(t._bar_colors[r])})),n.on("color:change",(function(r){const n=Number(e.value);t.set_bar_color(n,r.rgbaString)}))},Object.setPrototypeOf(a.prototype,e.prototype),a.prototype.render=function(){e.prototype.render.call(this),this.svg=d3.select(this.div_wrapper).append("svg").attr("version","1.1").attr("xmlns","http://www.w3.org/2000/svg").attr("width","100%")},a.prototype.get_supported_export_formats=function(){return["svg"]},a.prototype.download_chart_as_svg=function(t){const e=this.svg.node().outerHTML,r=new Blob([e],{type:"image/svg+xml;charset=utf-8"}),n=URL.createObjectURL(r),o=common.create_dom_element({element_type:"a",href:n});o.setAttribute("download",t),o.click(),o.remove(),URL.revokeObjectURL(n)};const i=["#1f77b4","#ff7f0e","#2ca02c","#d62728","#9467bd","#8c564b","#e377c2","#7f7f7f","#bcbd22","#17becf"];function s(t,e,r){a.call(this,t),this._data=e,this._ylabel=r,this._metrics={};for(const[t,r]of Object.entries(e))this._metrics[t]=c(r);this._data_extent=d3.extent(Object.values(this._data).flat()),this._full_width=960,this._full_height=420,this._chart={},this._chart.margin={top:15,right:3,bottom:23,left:50},this._chart.width=this._full_width-this._chart.margin.left-this._chart.margin.right,this._chart.height=this._full_height-this._chart.margin.top-this._chart.margin.bottom,this._chart.yscale=d3.scaleLinear().range([this._chart.height,0]).domain(this._data_extent).clamp(!0),this._chart.yaxis=d3.axisLeft(this._chart.yscale),this._chart.xscale=d3.scaleBand().domain(Object.keys(this._data)).range([0,this._chart.width]).padding(.1),this._chart.xaxis=d3.axisBottom(this._chart.xscale),this._chart.histogram=d3.bin().domain(this._chart.yscale.domain()).thresholds(this._chart.yscale.ticks(10)).value((t=>t)),this._chart.bins=[];for(const[t,e]of Object.entries(this._data))this._chart.bins.push({key:t,value:this._chart.histogram(e)});this._chart.root_g=null}function c(t){const e={max:null,upper_fence:null,quartile3:null,median:null,mean:null,iqr:null,quartile1:null,lower_fence:null,min:null};return e.min=d3.min(t),e.quartile1=d3.quantile(t,.25),e.median=d3.median(t),e.mean=d3.mean(t),e.quartile3=d3.quantile(t,.75),e.max=d3.max(t),e.iqr=e.quartile3-e.quartile1,e.lower_fence=e.quartile1-1.5*e.iqr,e.upper_fence=e.quartile3+1.5*e.iqr,e}Object.setPrototypeOf(s.prototype,a.prototype),s.prototype.render=function(){a.prototype.render.call(this),this._render_chart(),this._render_control_panel()},s.prototype._render_chart=function(){this.svg.attr("viewBox",`0 0 ${this._full_width} ${this._full_height}`),this._chart.root_g=this.svg.append("g").attr("transform",`translate(${this._chart.margin.left},${this._chart.margin.top})`),this._render_axis(),this._render_violins(),this._render_boxes()},s.prototype._render_axis=function(){this._chart.root_g.append("g").attr("transform",`translate(0,${this._chart.height})`).call(this._chart.xaxis),this._chart.root_g.append("g").call(this._chart.yaxis),this._chart.root_g.append("text").attr("text-anchor","middle").attr("transform","rotate(-90)").attr("y",20-this._chart.margin.left).attr("x",-this._chart.height/2).text(this._ylabel)},s.prototype._render_violins=function(){const t=this._chart;let e=0;for(const r of t.bins){const t=d3.max(r.value.map((t=>t.length)));t>e&&(e=t)}const r=d3.scaleLinear().range([0,t.xscale.bandwidth()]).domain([-e,e]);t.root_g.append("g").selectAll("violin").data(t.bins).enter().append("g").attr("transform",(e=>`translate(${t.xscale(e.key)},0)`)).append("path").datum((t=>t.value)).style("stroke","black").style("stroke-width",.5).style("fill","ghostwhite").attr("d",d3.area().x0((t=>r(-t.length))).x1((t=>r(t.length))).y((e=>t.yscale(e.x0))).curve(d3.curveCatmullRom))},s.prototype._render_boxes=function(){const t=this._chart,e={};for(const[t,r]of Object.entries(this._data))e[t]=r.filter((e=>e<this._metrics[t].lower_fence||e>this._metrics[t].upper_fence));const r=t.root_g.append("g"),n=t.xscale.bandwidth(),o=.6*n;for(const[a,s]of Object.entries(Object.keys(this._data))){const c=this._metrics[s],l=r.append("g").attr("transform",`translate(${t.xscale(s)+n/2},0)`);for(const r of e[s])l.append("circle").attr("cx",0).attr("cy",t.yscale(r)).attr("r",4).style("fill",i[a]).style("opacity",.6);const _=l.append("g");_.append("line").attr("x1",0).attr("y1",t.yscale(c.lower_fence)).attr("x2",0).attr("y2",t.yscale(c.upper_fence)).attr("stroke",i[a]).attr("stroke-width",2),_.append("line").attr("x1",-o/2).attr("y1",t.yscale(c.lower_fence)).attr("x2",o/2).attr("y2",t.yscale(c.lower_fence)).attr("stroke",i[a]).attr("stroke-width",2),_.append("line").attr("x1",-o/2).attr("y1",t.yscale(c.upper_fence)).attr("x2",o/2).attr("y2",t.yscale(c.upper_fence)).attr("stroke",i[a]).attr("stroke-width",2);const h=l.append("g");h.append("rect").attr("x",-o/2).attr("y",t.yscale(c.quartile3)).attr("width",o).attr("height",t.yscale(c.quartile1)-t.yscale(c.quartile3)).attr("fill",i[a]),h.append("line").attr("x1",-o/2).attr("y1",t.yscale(c.median)).attr("x2",o/2).attr("y2",t.yscale(c.median)).attr("stroke","black").attr("stroke-width",3),h.append("circle").attr("cx",0).attr("cy",t.yscale(c.median)).attr("r",5).style("fill","white").attr("stroke","black").attr("stroke-width",2)}},s.prototype._render_control_panel=function(){};const l={form:null,area_name:null,row:null,export_data_container:null,form_items_container:null,chart_wrapper_container:null,chart_wrapper:null,set_up:function(t){const e=this;e.area_name=t.area_name,e.export_data_container=t.export_data_container,e.row=t.row,e.form_items_container=t.form_items_container,e.chart_wrapper_container=t.chart_wrapper_container;const r=e.render_form();return e.form_items_container.appendChild(r),!0},render_form:function(){const t=this,e=new DocumentFragment;t.form=t.form||new form_factory;const r=common.create_dom_element({element_type:"div",class_name:"form-row fields",parent:e});t.form.item_factory({id:"mint",name:"mint",label:tstring.mint||"mint",q_column:"p_mint",value_wrapper:['["','"]'],eq:"LIKE",eq_in:"%",eq_out:"%",is_term:!0,parent:r,callback:function(e){t.form.activate_autocomplete({form_item:e,table:"catalog"})}}),t.form.item_factory({id:"number",name:"number",q_column:"term",q_table:"types",label:tstring.number_key||"Number & Key",is_term:!1,parent:r,callback:function(e){t.form.activate_autocomplete({form_item:e,table:"catalog"})}}),t.form.item_factory({id:"denomination",name:"denomination",q_column:"ref_type_denomination",q_table:"any",label:tstring.denomination||"denomination",is_term:!1,parent:r,callback:function(e){t.form.activate_autocomplete({form_item:e,table:"catalog"})}});const n=common.create_dom_element({element_type:"div",class_name:"form-group field button_submit",parent:e});common.create_dom_element({element_type:"input",type:"submit",id:"submit",value:tstring.search||"Search",class_name:"btn btn-light btn-block primary",parent:n}).addEventListener("click",(function(e){e.preventDefault(),t.form_submit(a)}));common.create_dom_element({element_type:"input",type:"button",id:"button_reset",value:tstring.reset||"Reset",class_name:"btn btn-light btn-block secondary button_reset",parent:n}).addEventListener("click",(function(t){t.preventDefault(),window.location.replace(window.location.pathname)}));const o=t.form.build_operators_node();e.appendChild(o);const a=common.create_dom_element({element_type:"form",id:"search_form",class_name:"form-inline"});return a.appendChild(e),a},form_submit:function(t,e={}){const r=this;"boolean"!=typeof e.scroll_result||e.scroll_result;const n=e.form_items||r.form.form_items,o=r.form.build_filter({form_items:n});if(!o||o.length<1)return!1;r.search_rows({filter:o,limit:0}).then((t=>{event_manager.publish("form_submit",t),console.log(t);const e={};for(const r of t){const t=r.term.split(" ")[0].slice(0,-1);if(!["59","62"].includes(t))continue;const n={},o=r.full_coins_reference_calculable,a=r.full_coins_reference_diameter_max,i=r.full_coins_reference_diameter_min,s=r.full_coins_reference_weight;a&&a.length&&(n.diameter_max=a.filter(((t,e)=>t&&o[e]))),i&&i.length&&(n.diameter_min=i.filter(((t,e)=>t&&o[e]))),s&&s.length&&(n.weight=s.filter(((t,e)=>t&&o[e]))),Object.keys(n).length&&(e[t]=n)}console.log(e);const r={};for(const[t,n]of Object.entries(e))r[t]=n.diameter_max;console.log(r),this.chart_wrapper=new s(this.chart_wrapper_container,r,"Diameter"),this.chart_wrapper.render()}))},search_rows:function(t){const e=this,r=t.filter||null,n=t.ar_fields||["*"],o=t.order||"norder ASC",a=page_globals.WEB_CURRENT_LANG_CODE,i=t.process_result||null,s=null!=t.limit?t.limit:30;return new Promise((function(t){const c=[],l=e.form.parse_sql_filter(r),_={dedalo_get:"records",table:"catalog",ar_fields:n,lang:a,sql_filter:l,limit:s,group:c.length>0?c.join(","):null,count:!1,order:o,process_result:i};data_manager.request({body:_}).then((e=>{const r=page.parse_catalog_data(e.result);t(r)}))}))}};return exports.analysis=l,Object.defineProperty(exports,"__esModule",{value:!0}),exports}({});