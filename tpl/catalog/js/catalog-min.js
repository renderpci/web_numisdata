"use strict";var catalog={trigger_url:page_globals.__WEB_TEMPLATE_WEB__+"/catalog/trigger.catalog.php",search_options:{},selected_term_table:null,filters:{},filter_op:"AND",draw_delay:1,form:null,rows_list_container:null,export_data_container:null,set_up:function(e){const t=this,n=e.global_search,r=e.item_type,o=e.label,a=e.value,l=e.rows_list_container,i=e.export_data_container,c=e.form_items_container;t.rows_list_container=l,t.export_data_container=i,t.form_items_container=c;const _=t.render_form();if(t.form_items_container.appendChild(_),n&&n.length>1){const e=decodeURI(n);t.form.set_input_value(t.form.form_items.global_search,e),t.form_submit(_)}else r.length>1&&(t.form.add_selected_value(t.form.form_items[r],o,a),t.form_submit(_));return!0},render_form:function(){const e=this,t=new DocumentFragment;e.form=e.form||new form_factory;const n=common.create_dom_element({element_type:"div",class_name:"form-row fields",parent:t});e.form.item_factory({id:"global_search",name:"global_search",label:tstring.global_search||"global_search",q_column:"global_search",eq:"MATCH",eq_in:"",eq_out:"",class_name:"global_search",parent:n,callback:function(t){const n=t.node_input;let r;common.create_dom_element({element_type:"div",class_name:"search_operators_info",parent:n.parentNode}).addEventListener("click",(function(t){if(t.stopPropagation(),r)return r.remove(),void(r=null);r=e.form.full_text_search_operators_info(),n.parentNode.appendChild(r)})),window.addEventListener("click",(function(e){r&&!n.contains(e.target)&&(r.remove(),r=null)}))}});e.form.item_factory({id:"mint",name:"mint",label:tstring.mint||"mint",q_column:"p_mint",eq:"LIKE",eq_in:"%",is_term:!0,parent:n,callback:function(t){e.activate_autocomplete(t)}}),e.form.item_factory({id:"period",name:"period",label:tstring.period||"period",q_column:"p_period",eq_in:"%",is_term:!0,parent:n,callback:function(t){e.activate_autocomplete(t)}}),e.form.item_factory({id:"culture",name:"culture",label:tstring.culture||"culture",q_column:"p_culture",eq_in:"%",is_term:!0,parent:n,callback:function(t){e.activate_autocomplete(t)}}),e.form.item_factory({id:"creator",name:"creator",label:tstring.creator||"creator",q_column:"p_creator",eq_in:"%",is_term:!0,parent:n,callback:function(t){e.activate_autocomplete(t)}}),e.form.item_factory({id:"design_obverse",name:"design_obverse",label:tstring.design_obverse||"design obverse",q_column:"ref_type_design_obverse",eq_in:"%",is_term:!1,parent:n,callback:function(t){e.activate_autocomplete(t)}}),e.form.item_factory({id:"design_reverse",name:"design_reverse",label:tstring.design_reverse||"design reverse",q_column:"ref_type_design_reverse",eq_in:"%",is_term:!1,parent:n,callback:function(t){e.activate_autocomplete(t)}}),e.form.item_factory({id:"symbol_obverse",name:"symbol_obverse",label:tstring.symbol_obverse||"symbol obverse",q_column:"ref_type_symbol_obverse",eq_in:"%",is_term:!1,parent:n,callback:function(t){e.activate_autocomplete(t)}}),e.form.item_factory({id:"symbol_reverse",name:"symbol_reverse",label:tstring.symbol_reverse||"symbol reverse",q_column:"ref_type_symbol_reverse",eq_in:"%",is_term:!1,parent:n,callback:function(t){e.activate_autocomplete(t)}}),e.form.item_factory({id:"legend_obverse",name:"legend_obverse",label:tstring.legend_obverse||"legend obverse",q_column:"ref_type_legend_obverse",eq_in:"%",is_term:!1,parent:n,callback:function(t){e.activate_autocomplete(t)}}),e.form.item_factory({id:"legend_reverse",name:"legend_reverse",label:tstring.legend_reverse||"legend reverse",q_column:"ref_type_legend_reverse",eq_in:"%",is_term:!1,parent:n,callback:function(t){e.activate_autocomplete(t)}}),e.form.item_factory({id:"territory",name:"territory",label:tstring.territory||"territory",q_column:"p_territory",eq_in:"%",is_term:!0,parent:n,callback:function(t){e.activate_autocomplete(t)}}),e.form.item_factory({id:"group",name:"group",label:tstring.group||"group",q_column:"p_group",eq_in:"%",is_term:!0,parent:n,callback:function(t){e.activate_autocomplete(t)}}),e.form.item_factory({id:"material",name:"material",q_column:"ref_type_material",q_table:"any",label:tstring.material||"material",is_term:!1,parent:n,callback:function(t){e.activate_autocomplete(t)}}),e.form.item_factory({id:"collection",name:"collection",q_column:"ref_coins_collection",q_table:"any",label:tstring.collection||"collection",is_term:!1,parent:n,callback:function(t){e.activate_autocomplete(t)}}),e.form.item_factory({id:"denomination",name:"denomination",q_column:"ref_type_denomination",q_table:"any",label:tstring.denomination||"denomination",is_term:!1,parent:n,callback:function(t){e.activate_autocomplete(t)}}),e.form.item_factory({id:"number",name:"number",q_column:"term",q_table:"types",label:tstring.number||"number",is_term:!1,parent:n,callback:function(t){e.activate_autocomplete(t)}}),e.form.item_factory({id:"company",name:"company",q_column:"ref_coins_auction_company",q_table:"types",label:tstring.company||"company",is_term:!1,parent:n,callback:function(t){e.activate_autocomplete(t)}}),e.form.item_factory({id:"technique",name:"technique",q_column:"ref_type_technique",q_table:"types",label:tstring.technique||"technique",is_term:!1,parent:n,callback:function(t){e.activate_autocomplete(t)}}),e.form.item_factory({id:"equivalents",name:"equivalents",q_column:"ref_type_equivalents",q_table:"types",eq_in:"%",eq_out:"%",label:tstring.equivalents||"equivalents",is_term:!1,parent:n,callback:function(t){e.activate_autocomplete(t)}});const r=common.create_dom_element({element_type:"div",class_name:"form-group field button_submit",parent:t});common.create_dom_element({element_type:"input",type:"submit",id:"submit",value:tstring.search||"Search",class_name:"btn btn-light btn-block primary",parent:r}).addEventListener("click",(function(t){t.preventDefault(),e.form_submit(a)}));const o=e.form.build_operators_node();t.appendChild(o);const a=common.create_dom_element({element_type:"form",id:"search_form",class_name:"form-inline"});return a.appendChild(t),a},activate_autocomplete:function(e){return this.form.activate_autocomplete({form_item:e,table:"catalog"})},form_submit:function(e){const t=this,n=t.form.form_items,r=t.rows_list_container,o=r.parentNode,a=common.create_dom_element({element_type:"div",class_name:"spinner",parent:o}),l=[];for(let[e,t]of Object.entries(n))!0===t.is_term&&l.push(t);const i=[];for(let[e,t]of Object.entries(n)){const e=!0===t.is_term?"OR":"AND",n={};if(n[e]=[],t.q.length>0){const r="AND",o={};o[r]=[];const a={field:t.q_column,value:`'%${t.q}%'`,op:t.eq};o[r].push(a),n[e].push(o)}if(t.q_selected.length>0)for(let r=0;r<t.q_selected.length;r++){const o=t.q_selected[r].replace(/(')/g,"''"),a="AND",l={};l[a]=[];const i={field:t.q_column,value:!0===t.is_term?`'%"${o}"%'`:`'${o}'`,op:!0===t.is_term?"LIKE":"="};l[a].push(i),n[e].push(l)}n[e].length>0&&i.push(n)}if(SHOW_DEBUG,i.length<1)return a.remove(),!1;t.export_data_buttons||(t.export_data_buttons=page.render_export_data_buttons(),t.export_data_container.appendChild(t.export_data_buttons),t.export_data_container.classList.add("hide")),r.classList.add("loading"),o&&o.scrollIntoView({behavior:"smooth",block:"start",inline:"nearest"});const c={};c[e.querySelector('input[name="operators"]:checked').value]=i;return t.search_rows({filter:c,limit:0,process_result:{fn:"process_result::add_parents_and_children_recursive",columns:[{name:"parents"}]}}).then(e=>{for(;r.hasChildNodes();)r.removeChild(r.lastChild);r.classList.remove("loading"),a.remove(),t.draw_rows({target:t.rows_list_container,ar_rows:e}).then((function(){t.export_data_container.classList.remove("hide")}))})},search_rows:function(e){const t=e.filter||null,n=e.ar_fields||["*"],r=e.order||"norder ASC",o=page_globals.WEB_CURRENT_LANG_CODE,a=e.process_result||null,l=null!=e.limit?e.limit:30;return new Promise((function(e){const i=[],c=function(e){if(e){const t=Object.keys(e)[0],n=e[t],r=[],o=n.length;for(let e=0;e<o;e++){const t=n[e],o=Object.keys(t)[0];if("AND"===o||"OR"===o){const e=""+c(t);r.push(e);continue}let a;a="MATCH"===t.op?"MATCH ("+t.field+") AGAINST ("+t.value+" IN BOOLEAN MODE)":-1!==t.field.indexOf("AS")?t.field+" "+t.op+" "+t.value:"`"+t.field+"` "+t.op+" "+t.value,r.push(a),t.group&&i.push(t.group)}return r.join(" "+t+" ")}return null},_=c(t);!0===SHOW_DEBUG&&(console.log("--- search_rows parsed sql_filter:"),console.log(_));const s={dedalo_get:"records",table:"catalog",ar_fields:n,lang:o,sql_filter:_,limit:l,group:i.length>0?i.join(","):null,count:!1,order:r,process_result:a};data_manager.request({body:s}).then(t=>{console.log("--- search_rows API response:",t);const n=page.parse_catalog_data(t.result);event_manager.publish("data_request_done",{request_body:s,result:n,export_data_parser:page.export_parse_catalog_data}),e(n)})}))},draw_rows:function(e){const t=this,n=e.target,r=e.ar_rows||[];return new Promise((function(e){t.search_options.total,t.search_options.limit,t.search_options.offset;const o=n;if(r.length<1){for(;o.hasChildNodes();)o.removeChild(o.lastChild);common.create_dom_element({element_type:"div",class_name:"no_results_found",inner_html:tstring.no_results_found||"No results found",parent:o});return window.scrollTo(0,0),e(o),!1}return async function(){const e=new DocumentFragment,n=r.filter(e=>"mints"===e.term_table),o=[];for(let e=0;e<n.length;e++){const t=void 0!==n[e].parent[0]?n[e].parent[0]:null,a=t?r.find(e=>e.section_id===t):null;if(!a){console.warn("mint don't have public parent:",n[e]);continue}void 0===o.find(e=>e.section_id===t)&&o.push(a)}for(let n=0;n<o.length;n++){t.get_children(r,o[n],e)}return e}().then(t=>{for(;o.hasChildNodes();)o.removeChild(o.lastChild);o.appendChild(t),setTimeout((function(){const e=o;page.activate_images_gallery(e,!0)}),600),e(o)}),!0}))},get_children:function(e,t,n){const r=this,o=t.children,a=common.create_dom_element({element_type:"div",class_name:"children_contanier"});if(n.appendChild(a),o)for(let t=0;t<o.length;t++)r.get_child(e,o[t],a)},get_child:function(e,t,n){const r=this,o=e.find(e=>e.section_id===t);if(o){const t=r.render_rows(o,e);n.appendChild(t),o.children&&(r.get_children(e,o,t),t.addEventListener("mouseup",e=>{e.preventDefault();if(("SPAN"===e.target.tagName?e.target.parentNode:e.target)===t.firstChild){t.querySelector(".children_contanier").classList.toggle("hide")}},!1))}},render_rows:function(e,t){SHOW_DEBUG,catalog_row_fields.ar_rows=t;return catalog_row_fields.draw_item(e)}};