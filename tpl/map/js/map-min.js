"use strict";var map={form_container:null,rows_container:null,map_container:null,map_factory_instance:null,master_map_global_data:null,current_map_global_data:null,global_data:null,map_global_data:null,form:null,forn_node:null,set_up:function(e){console.log("--\x3e map set_up options:",e);const t=this;t.form_container=e.form_container,t.map_container=e.map_container,t.rows_container=e.rows_container,t.source_maps=[{name:"DARE",url:"//dh.gu.se/tiles/imperium/{z}/{x}/{y}.png",options:{maxZoom:11}},{name:"OSM",url:"//{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",options:{maxZoom:19}},{name:"Map Tiles",url:"https://api.maptiler.com/maps/basic/256/{z}/{x}/{y}@2x.png?key=udlBrEEE2SPm1In5dCNb",options:{maxZoom:20},default:!0},{name:"ARCGIS",url:"//server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",options:{}}],t.map_factory_instance=new map_factory,t.map_factory_instance.init({map_container:t.map_container,map_position:null,popup_builder:page.map_popup_builder,popup_options:page.maps_config.popup_options,source_maps:t.source_maps,legend:page.render_map_legend});const n={dedalo_get:"records",db_name:page_globals.WEB_DB,lang:page_globals.WEB_CURRENT_LANG_CODE,table:"map_global",ar_fields:"*",sql_filter:"coins_list IS NOT NULL && types_list IS NOT NULL",limit:0,count:!1,offset:0,order:null};data_manager.request({body:n}).then(e=>{if(console.log("--- search_rows API response:",e),e.result){t.master_map_global_data=page.parse_map_global_data(e.result),t.current_map_global_data=t.master_map_global_data;const n=t.current_map_global_data.filter((function(e){return null!==e.item})).map((function(e){return e.item}));t.map_factory_instance.parse_data_to_map(n).then((function(){t.map_container.classList.remove("hide_opacity")}))}}),t.form=new form_factory,t.form_node=t.render_form(),t.form_container.appendChild(t.form_node);return document.getElementById("search_icon").addEventListener("mousedown",(function(){t.form_node.classList.toggle("hide")})),event_manager.subscribe("map_selected_marker",(function(e){console.log("///-> map_selected_marker options:",e);const n=void 0!==e.item.group[0]?e.item.group[0]:null;if(n){for(;t.rows_container.hasChildNodes();)t.rows_container.removeChild(t.rows_container.lastChild);page.add_spinner(t.rows_container),t.load_map_selection_info(n).then((function(e){if(console.log("--\x3e load_map_selection_info response:",e),e){const n=t.render_types_list({global_data_item:e.global_data_item,types_rows:e.types_rows});t.rows_container.appendChild(n),page.remove_spinner(t.rows_container)}else page.remove_spinner(t.rows_container)}))}})),!0},render_form:function(){const e=this,t=new DocumentFragment,n=common.create_dom_element({element_type:"div",class_name:"form-row fields",parent:t});e.form.item_factory({id:"section_id",name:"section_id",label:tstring.is||"ID",q_column:"section_id",eq:"=",eq_in:"",eq_out:"",parent:n}),e.form.item_factory({id:"collection",name:"collection",label:tstring.collection||"collection",q_column:"collection",eq:"LIKE",eq_in:"%",eq_out:"%",parent:n,callback:function(t){e.form.activate_autocomplete({form_item:t,table:"coins"})}}),e.form.item_factory({id:"ref_auction",name:"ref_auction",label:tstring.auction||"auction",q_column:"ref_auction",eq:"LIKE",eq_in:"%",eq_out:"%",parent:n,callback:function(t){e.form.activate_autocomplete({form_item:t,table:"coins"})}}),e.form.item_factory({id:"mint",name:"mint",label:tstring.mint||"mint",q_column:"mint",eq:"LIKE",eq_in:"%",eq_out:"%",parent:n,callback:function(t){e.form.activate_autocomplete({form_item:t,table:"coins"})}}),e.form.item_factory({id:"findspot",name:"findspot",label:tstring.findspot||"findspot",q_column:"findspot",eq:"LIKE",eq_in:"%",eq_out:"%",parent:n,callback:function(t){e.form.activate_autocomplete({form_item:t,table:"coins"})}}),e.form.item_factory({id:"hoard",name:"hoard",label:tstring.hoard||"hoard",q_column:"hoard",eq:"LIKE",eq_in:"%",eq_out:"%",parent:n,callback:function(t){e.form.activate_autocomplete({form_item:t,table:"coins"})}});const o=common.create_dom_element({element_type:"div",class_name:"form-group field button_submit",parent:t});common.create_dom_element({element_type:"input",type:"submit",id:"submit",value:tstring.search||"Search",class_name:"btn btn-light btn-block primary",parent:o}).addEventListener("click",(function(t){t.preventDefault(),e.form_submit()}));const a=e.form.build_operators_node();t.appendChild(a);const r=common.create_dom_element({element_type:"form",id:"search_form",class_name:"form-inline hide"});return r.appendChild(t),r},form_submit:function(){const e=this,t=e.form_node;if(!t)return new Promise((function(e){console.error("Error on submit. Invalid form_node.",t),e(!1)}));for(;e.rows_container.hasChildNodes();)e.rows_container.removeChild(e.rows_container.lastChild);return e.map_container.classList.add("loading"),new Promise((function(n){const o=e.form.form_to_sql_filter({form_node:t});data_manager.request({body:{dedalo_get:"records",table:"coins",ar_fields:["section_id","mint_data","hoard_data","findspot_data","type_data"],sql_filter:o+" AND type_data IS NOT NULL",limit:0,count:!1,offset:0,order:null,process_result:null}}).then((function(t){console.log("--------------- form_submit api_response:",t),e.current_map_global_data=e.distribute_coins(t.result),console.log("self.current_map_global_data:",e.current_map_global_data);const n=e.current_map_global_data.map((function(e){return e.item}));e.map_factory_instance.init({map_container:e.map_container,map_position:null,popup_builder:page.map_popup_builder,popup_options:page.maps_config.popup_options,source_maps:e.source_maps,legend:page.render_map_legend}),e.map_factory_instance.parse_data_to_map(n,null),e.map_container.classList.remove("loading")}))}))},distribute_coins:function(e){const t=this,n=[],o=t.master_map_global_data.length;for(let a=0;a<o;a++){const o=t.master_map_global_data[a];let r=[];switch(o.table){case"mints":r=e.filter((function(e){return'["'+o.ref_section_id+'"]'===e.mint_data}));break;case"hoards":r=e.filter((function(e){return'["'+o.ref_section_id+'"]'===e.hoard_data}));break;case"findspots":r=e.filter((function(e){return'["'+o.ref_section_id+'"]'===e.findspot_data}))}if(r.length<1)continue;const i=r.map((function(e){return e.section_id})),_=[];for(let e=0;e<r.length;e++){const t=r[e].type_data?JSON.parse(r[e].type_data):null;t&&-1===_.indexOf(t[0])&&_.push(t[0])}const l=JSON.parse(JSON.stringify(o));l.coins_list=i,l.types_list=_;const s=(tstring.coins||"Coins")+" "+l.coins_list.length+"<br>"+(tstring.types||"Types")+" "+l.types_list.length;l.item.data.coins_total=i.length,l.item.data.types_total=_.length,l.item.data.description=s,n.push(l)}return n},load_map_selection_info:function(e){const t=this;return new Promise((function(n){const o=t.current_map_global_data.find((function(t){return t.section_id===e.term_id}));if(!o||!o.types_list||o.types_list.length<1)return console.warn("Ignored invalid item. Not found item or item.types_list in global_data! ",e.name,e),n(!1),!1;o.coins_list;const a="term_table='types' AND term_data IN("+o.types_list.map((function(e){return"'[\""+e+"\"]'"})).join(",")+")",r={dedalo_get:"records",db_name:page_globals.WEB_DB,lang:page_globals.WEB_CURRENT_LANG_CODE,table:"catalog",ar_fields:["*"],sql_filter:a,limit:0,count:!1,offset:0,order:"term ASC"};data_manager.request({body:r}).then(e=>{console.log("-> load_map_selection_info api_response:",e);const t=page.parse_catalog_data(e.result);n({global_data_item:o,types_rows:t})})}))},render_types_list:function(e){const t=e.global_data_item,n=e.types_rows,o=new DocumentFragment,a=common.create_dom_element({element_type:"div",class_name:"types_list_wrapper",parent:o}),r=common.create_dom_element({element_type:"div",class_name:"line-tittle-wrap",parent:a});let i;switch(t.table){case"mints":i="mint";break;case"hoards":i="hoard";break;case"findspots":i="findspot"}const _='<span class="note">'+tstring[i]+": </span>"+t.name;if(common.create_dom_element({element_type:"div",class_name:"line-tittle golden-color",inner_html:_,parent:r}),n&&n.length>0){const e=common.create_dom_element({element_type:"div",class_name:"types_wrap",parent:o});for(let t=0;t<n.length;t++){const o=catalog_row_fields.draw_item(n[t]);e.appendChild(o)}}return o}};