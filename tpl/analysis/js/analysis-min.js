var analysis_min=function(exports){"use strict";const t="rgba(255,190,92,0.5)";function e(t){if(this.constructor===e)throw new Error("Abstract class 'chart_wrapper' cannot be instantiated");this.div_wrapper=t,this.download_chart_container=void 0,this.controls_container=void 0}function n(t){if(this.constructor===n)throw new Error("Abstract class 'chartjs_chart_wrapper' cannot be instantiated");e.call(this,t),this.canvas=void 0,this.chart=void 0}function o(e,o,r){n.call(this,e),this._data=o,this._density=!1,this._n_bins_default=Math.ceil(Math.sqrt(this._data.length)),this._n_bins=void 0,this._xlabel=r,this._n_decimals=3,this._max_bins_multiplier=3,this._bar_color=t}function r(e,o,r){n.call(this,e),this._data=void 0,Array.isArray(o)?(this._check_array_valid(o),this._data=this._parse_array(o)):(this._check_object_valid(o),this._data=this._parse_object(o)),this._ylabel=r,this._bar_colors=Array(this._data.labels.length).fill(t)}e.prototype.render=function(){const t=this;this.div_wrapper.replaceChildren(),this.controls_container=void 0,this.download_chart_container=common.create_dom_element({element_type:"div",id:"download_chart_container",class_name:"o-purple",parent:this.div_wrapper});const e=common.create_dom_element({element_type:"select",id:"chart_export_format",parent:this.download_chart_container});for(const t of this.get_supported_export_formats())common.create_dom_element({element_type:"option",value:t,text_content:t.toUpperCase(),parent:e});common.create_dom_element({element_type:"button",text_content:"Download",parent:this.download_chart_container}).addEventListener("click",(()=>{t.download_chart(e.value)}))},e.prototype.download_chart=function(t){const e=`chart.${t}`,n=`download_chart_as_${t}`;if(void 0===this[n])throw new Error(`${n} is not implemented!`);this[n](e)},e.prototype.get_supported_export_formats=function(){throw new Error("Abstract method 'chart_wrapper.download_chart' cannot be called")},Object.setPrototypeOf(n.prototype,e.prototype),n.prototype.render=function(){e.prototype.render.call(this),this.canvas=common.create_dom_element({element_type:"canvas",id:"result_graph",class_name:"o-blue",parent:this.div_wrapper}),this.chart=void 0},n.prototype.get_supported_export_formats=function(){return["png"]},n.prototype.download_chart_as_png=function(t){let e=common.create_dom_element({element_type:"a",href:this.chart.toBase64Image()});e.setAttribute("download",t),e.click(),e.remove()},n.prototype.download_chart_as_svg=function(t){this._tweak_c2s();const e=this.canvas.offsetWidth,n=this.canvas.offsetHeight;this.chart.options.animation=!1,this.chart.options.reponsive=!1;const o=C2S(e,n);new Chart(o,this.chart.config._config);let r=common.create_dom_element({element_type:"a",href:"data:image/svg+xml;utf8,"+encodeURIComponent(o.getSerializedSvg())});r.setAttribute("download",t),r.click(),r.remove(),this.chart.options.animation=!0,this.chart.options.reponsive=!0},n.prototype._tweak_c2s=function(){C2S.prototype.getContext=function(t){return"2d"===t||"2D"===t?this:null},C2S.prototype.style=function(){return this.__canvas.style},C2S.prototype.getAttribute=function(t){return this[t]},C2S.prototype.addEventListener=function(t,e,n){}},Object.setPrototypeOf(o.prototype,n.prototype),o.prototype.get_density=function(){return this._density},o.prototype.set_density=function(t){if(this._density=t,!this.chart)return;const[e,n,o,r,a]=this._get_plotting_data();this.chart.data.datasets[0].label=this._get_density_string(),this.chart.data.datasets[0].data=n,this.chart.options.scales.y.title.text=this._get_density_string(),this.chart.update()},o.prototype._get_density_string=function(){return this._density?"Density":"Frequency"},o.prototype.get_n_bins=function(){return this._n_bins},o.prototype.set_n_bins=function(t){if(this._n_bins=t,!this.chart)return;const[e,n,o,r,a]=this._get_plotting_data();this.chart.data.datasets[0].data=n,this.chart.options.scales.x.min=r,this.chart.options.scales.x.max=a,this.chart.options.scales.x.ticks.stepSize=2*o,this.chart.options.plugins.tooltip.callbacks.title=this._get_tooltip_title_callback(e,o),this.chart.update()},o.prototype.get_bar_color=function(){return this._bar_color},o.prototype.set_bar_color=function(t){this._bar_color=t,this.chart&&(this.chart.data.datasets[0].backgroundColor=this._bar_color,this.chart.update())},o.prototype._get_plotting_data=function(){const t=Math.max(...this._data),e=Math.min(...this._data),n=(t-e)/this._n_bins,o=.5*n,r=Array.apply(null,Array(this._n_bins)).map(((t,n)=>e+(2*n+1)*o));let a=Array.apply(null,Array(this._n_bins)).map((()=>0));for(let e=0;e<this._data.length;e++)if(this._data[e]!==t){for(let t=0;t<this._n_bins;t++)if(this._data[e]>=r[t]-o&&this._data[e]<r[t]+o){a[t]++;break}}else a[this._n_bins-1]++;if(this._density){const t=a.reduce(((t,e)=>t+e),0);for(let e=0;e<this._n_bins;e++)a[e]/=t*n}return[r,r.map(((t,e)=>({x:t,y:a[e]}))),o,e,t]},o.prototype._get_tooltip_title_callback=function(t,e){const n=this._xlabel,o=this._n_decimals;return function(r){if(!r.length)return"";const a=r[0].dataIndex,i=t[a]-e,s=t[a]+e;return`${n}: ${i.toFixed(o)} - ${s.toFixed(o)}`}},o.prototype.render=function(){n.prototype.render.call(this),this._render_chart(),this._render_control_panel()},o.prototype._render_chart=function(){this._n_bins=this._n_bins_default;const[t,e,n,o,r]=this._get_plotting_data(),a={datasets:[{label:this._get_density_string(),data:e,categoryPercentage:1,barPercentage:1,backgroundColor:this._bar_color}]},i={x:{type:"linear",min:o,max:r,offset:!1,grid:{offset:!1},ticks:{stepSize:2*n,callback:(t,e,n)=>Number(t).toFixed(this._n_decimals)},title:{display:!0,text:this._xlabel,font:{size:14}}},y:{title:{display:!0,text:this._get_density_string(),font:{size:14}}}},s={legend:{display:!1},tooltip:{callbacks:{title:this._get_tooltip_title_callback(t,n)}}};this.chart=new Chart(this.canvas,{type:"bar",data:a,options:{scales:i,plugins:s,parsing:!1,normalized:!0}})},o.prototype._render_control_panel=function(){const t=this;this.controls_container=common.create_dom_element({element_type:"div",id:"controls",class_name:"o-green",parent:this.div_wrapper});const e=common.create_dom_element({element_type:"input",type:"range",value:this._n_bins_default,parent:this.controls_container});e.setAttribute("min",1),e.setAttribute("max",this._max_bins_multiplier*this._n_bins_default),e.addEventListener("input",(()=>{this.set_n_bins(Number(e.value))}));common.create_dom_element({element_type:"button",type:"button",text_content:"Reset",parent:this.controls_container}).addEventListener("click",(()=>{e.value=this._n_bins_default,this.set_n_bins(Number(e.value))}));const n=common.create_dom_element({element_type:"input",type:"checkbox",id:"density_checkbox",parent:this.controls_container});common.create_dom_element({element_type:"label",text_content:"Density",parent:this.controls_container}).setAttribute("for","density_checkbox"),n.addEventListener("change",(()=>{this.set_density(Boolean(n.checked))}));const o=common.create_dom_element({element_type:"div",id:"color_picker_container",parent:this.controls_container});new window.iro.ColorPicker(o,{color:this._bar_color,width:200,layoutDirection:"horizontal",layout:[{component:window.iro.ui.Wheel},{component:window.iro.ui.Slider},{component:window.iro.ui.Slider,options:{sliderType:"alpha"}}]}).on("color:change",(function(e){t.set_bar_color(e.rgbaString)}))},Object.setPrototypeOf(r.prototype,n.prototype),r.prototype._check_array_valid=function(t){if(!t.length)throw new Error("Input array is empty!");const e=typeof t[0];if("number"!==e&&"string"!==e)throw new Error("Input array is not made of numbers or strings");for(const n of t.slice(1))if(typeof n!==e)throw new Error("Input array combines multiple types")},r.prototype._parse_array=function(t){const e=t.filter(((t,e,n)=>n.indexOf(t)===e)),n=e.map((e=>t.filter((t=>t===e)).length));return{labels:e,values:n}},r.prototype._check_object_valid=function(t){if(!t)throw new Error("Input data object is null or undefined");if(!Object.keys(t).length)throw new Error("Input data object is empty");const e=Object.values(t);for(const t of e)if("number"!=typeof t)throw new Error("A value in the input data object is not a number")},r.prototype._parse_object=function(t){return{labels:Object.keys(t),values:Object.values(t)}},r.prototype.get_bar_colors=function(){return this._bar_colors},r.prototype.set_bar_colors=function(t){this._bar_colors=t,this.chart.data.datasets[0].backgroundColor=t,this.chart.update()},r.prototype.set_bar_color=function(t,e){if("number"!=typeof t)throw new Error("Index is not a number");if(!Number.isInteger(t))throw new Error("Index is not an integer");if(t<0||t>=this._data.labels.length)throw new Error("Index is out of bounds");this._bar_colors[t]=e,this.chart.data.datasets[0].backgroundColor[t]=e,this.chart.update()},r.prototype.render=function(){n.prototype.render.call(this),this._render_chart(),this._render_control_panel()},r.prototype._render_chart=function(){const t={labels:this._data.labels,datasets:[{label:this._ylabel,data:this._data.values,backgroundColor:this._bar_colors}]},e={y:{title:{display:!0,text:this._ylabel,font:{size:14}}}};this.chart=new Chart(this.canvas,{type:"bar",data:t,options:{scales:e,plugins:{legend:{display:!1}},normalized:!0}})},r.prototype._render_control_panel=function(){const t=this;this.controls_container=common.create_dom_element({element_type:"div",id:"controls",class_name:"o-green",parent:this.div_wrapper});const e=common.create_dom_element({element_type:"select",id:"bar_selection",parent:this.controls_container});for(const[t,n]of this._data.labels.entries())common.create_dom_element({element_type:"option",value:String(t),text_content:n,parent:e});const n=common.create_dom_element({element_type:"div",id:"color_picker_container",parent:this.controls_container}),o=new window.iro.ColorPicker(n,{color:this._bar_colors[0],width:200,layoutDirection:"horizontal",layout:[{component:window.iro.ui.Wheel},{component:window.iro.ui.Slider},{component:window.iro.ui.Slider,options:{sliderType:"alpha"}}]});e.addEventListener("change",(()=>{const n=Number(e.value);o.color.set(t._bar_colors[n])})),o.on("color:change",(function(n){const o=Number(e.value);t.set_bar_color(o,n.rgbaString)}))};const a={form:null,area_name:null,row:null,export_data_container:null,form_items_container:null,chart_wrapper_container:null,chart_wrapper:null,set_up:function(t){const e=this;e.area_name=t.area_name,e.export_data_container=t.export_data_container,e.row=t.row,e.form_items_container=t.form_items_container,e.chart_wrapper_container=t.chart_wrapper_container;const n=e.render_form();return e.form_items_container.appendChild(n),!0},render_form:function(){const t=this,e=new DocumentFragment;t.form=t.form||new form_factory;const n=common.create_dom_element({element_type:"div",class_name:"form-row fields",parent:e});t.form.item_factory({id:"mint",name:"mint",label:tstring.mint||"mint",q_column:"p_mint",value_wrapper:['["','"]'],eq:"LIKE",eq_in:"%",eq_out:"%",is_term:!0,parent:n,callback:function(e){t.form.activate_autocomplete({form_item:e,table:"catalog"})}});const o=common.create_dom_element({element_type:"div",class_name:"form-group field button_submit",parent:e});common.create_dom_element({element_type:"input",type:"submit",id:"submit",value:tstring.search||"Search",class_name:"btn btn-light btn-block primary",parent:o}).addEventListener("click",(function(e){e.preventDefault(),t.form_submit(a)}));common.create_dom_element({element_type:"input",type:"button",id:"button_reset",value:tstring.reset||"Reset",class_name:"btn btn-light btn-block secondary button_reset",parent:o}).addEventListener("click",(function(t){t.preventDefault(),window.location.replace(window.location.pathname)}));const r=t.form.build_operators_node();e.appendChild(r);const a=common.create_dom_element({element_type:"form",id:"search_form",class_name:"form-inline"});return a.appendChild(e),a},form_submit:function(t,e={}){const n=this;"boolean"!=typeof e.scroll_result||e.scroll_result;const r=e.form_items||n.form.form_items,a=n.form.build_filter({form_items:r});if(!a||a.length<1)return!1;n.search_rows({filter:a,limit:0}).then((t=>{event_manager.publish("form_submit",t),console.log(t);const e=t.map((t=>t.full_coins_reference_diameter_max)).flat().filter((t=>t));this.chart_wrapper=new o(this.chart_wrapper_container,e,"Diameter"),this.chart_wrapper.render()}))},search_rows:function(t){const e=this,n=t.filter||null,o=t.ar_fields||["*"],r=t.order||"norder ASC",a=page_globals.WEB_CURRENT_LANG_CODE,i=t.process_result||null,s=null!=t.limit?t.limit:30;return new Promise((function(t){const c=[],_=e.form.parse_sql_filter(n),l={dedalo_get:"records",table:"catalog",ar_fields:o,lang:a,sql_filter:_,limit:s,group:c.length>0?c.join(","):null,count:!1,order:r,process_result:i};data_manager.request({body:l}).then((e=>{const n=page.parse_catalog_data(e.result);t(n)}))}))}};return exports.analysis=a,Object.defineProperty(exports,"__esModule",{value:!0}),exports}({});
//# sourceMappingURL=analysis-min.js.map