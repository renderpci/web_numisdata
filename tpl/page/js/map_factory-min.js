"use strict";function map_factory(){this.target=null,this.data=null,this.source_maps={},this.popup_builder=null,this.map=null,this.layer_control=!1,this.loaded_document=!1,this.icon_main=null,this.icon_finds=null,this.icon_uncertain=null,this.popupOptions=null,this.current_layer=null,this.current_group=null,this.option_selected=null,this.initied=!1,this.initial_map_data={lat:40.65993615913156,lon:-3.2304345278385687,zoom:6,alt:0},this.source_maps=[{name:"osm",url:"//{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",default:!0},{name:"arcgis",url:"//server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}"}],this.init=function(n){const t=this;t.target=n.target,t.map_position=n.map_position,t.source_maps=n.source_maps||t.source_maps,t.popup_builder=n.popup_builder||t.build_popup_content,t.map&&(t.map.off(),t.map.remove());const e=t.map_position||t.initial_map_data,o=parseFloat(e.lat),a=parseFloat(e.lon),l=parseInt(e.zoom),r=(parseInt(e.alt),t.target);t.map=null,t.layer_control=!1,t.loaded_document=!1,t.icon_main=null,t.icon_finds=null,t.icon_uncertain=null,t.popupOptions=null,t.current_layer=null,t.current_group=null,t.option_selected=null;let i=null;const s={};for(let n=0;n<t.source_maps.length;n++){const e=t.source_maps[n],o=new L.TileLayer(e.url,e.options);s[e.name]=o,0!==n&&!0!==e.default||(i=o)}return t.map=new L.map(r,{layers:[i],center:new L.LatLng(o,a),zoom:l}),t.layer_control=L.control.layers(s).addTo(t.map),t.map.scrollWheelZoom.disable(),t.icon_main=L.icon({iconUrl:page_globals.__WEB_TEMPLATE_WEB__+"/assets/lib/leaflet/images/naranja.png",shadowUrl:page_globals.__WEB_TEMPLATE_WEB__+"/assets/lib/leaflet/images/marker-shadow.png",iconSize:[47,43],shadowSize:[41,41],iconAnchor:[10,19],shadowAnchor:[0,20],popupAnchor:[12,-20]}),t.icon_green=L.icon({iconUrl:page_globals.__WEB_TEMPLATE_WEB__+"/assets/lib/leaflet/images/verde.png",shadowUrl:page_globals.__WEB_TEMPLATE_WEB__+"/assets/lib/leaflet/images/marker-shadow.png",iconSize:[47,43],shadowSize:[41,41],iconAnchor:[10,19],shadowAnchor:[0,20],popupAnchor:[12,-20]}),t.popupOptions={maxWidth:"758",closeButton:!0},t.initied=!0,!0},this.render=function(n){const t=n.map_data;return this.parse_data_to_map(t),!0},this.parse_data_to_map=function(n,t){const e=this;if(e.current_group&&e.current_group.clearLayers(),!n||n.length<1)return!1;const o=e.group_by_place(n),a=[];for(let n=o.length-1;n>=0;n--){const t=o[n],l=e.popup_builder(t),r=t.group.filter(n=>"hoard"===n.type).length>0?e.icon_main:e.icon_green,i=L.marker([t.lat,t.lon],{icon:r}).bindPopup(l);i.on("click",(function(n){event_manager.publish("map_selected_marker",{item:t,event:n})})),a.push(i)}if(e.current_group=L.layerGroup(a),e.current_group.addTo(e.map),a&&a.length>0){const n=new L.featureGroup(a);n&&e.map.fitBounds(n.getBounds())}return!0},this.group_by_place=function(n){const t=[],e=n.length;for(let o=0;o<e;o++){const e=n[o],a=t.find(n=>n.lat===e.lat&&n.lon===e.lon);if(a)a.group.push(e.data);else{const n={lat:e.lat,lon:e.lon,group:[e.data]};t.push(n)}}return console.log("group_data:",t),t},this.build_popup_content=function(n){console.log("(!) Using default build_popup_content function:",n);const t=n.group;return common.create_dom_element({element_type:"div",class_name:"popup_wrapper",inner_html:t[0].name+" "+t[0].total_items+"("+t[0].items+")"})},this.reset_map=function(){const n=this.initial_map_data;return this.map.setView(new L.LatLng(n.lat,n.lon),n.zoom),!0}}