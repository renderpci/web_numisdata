"use strict";var thesaurus={search_options:{},view_mode:null,filters:{},filter_op:"AND",draw_delay:200,form:null,list:null,map:null,timeline:null,table:[],root_term:[],term_id:null,set_up:function(e){console.log("-> thesaurus set_up options:",e);const t=this;t.table=e.table,t.root_term=e.root_term,t.term_id=e.term_id;const n=e.rows_list;t.view_mode="tree";const o=common.create_dom_element({element_type:"div",class_name:"spinner"});return t.render_form({container:document.getElementById("items_container")}).then((function(){n.appendChild(o)})),t.load_tree_data({}).then((function(e){console.log("/// load_tree_data response:",e);t.render_data({target:n,ar_rows:e.result,set_hilite:t.term_id&&t.term_id.length>0}).then((function(){o.remove()}))})),!0},load_tree_data:function(e){const t=e.filter||null,n=e.ar_fields||["section_id","term_id","term","childrens","code","dd_relations","descriptor","illustration","indexation","model","norder","parent","related","scope_note","space","time","tld","mib_bibliography"]||["*"],o=e.order||"norder ASC",r=page_globals.WEB_CURRENT_LANG_CODE,l=e.table||this.table.join(","),a=[],i=function(e){if(e){const t=Object.keys(e)[0],n=e[t],o=[],r=n.length;for(let e=0;e<r;e++){const t=n[e],r=Object.keys(t)[0];if("AND"===r||"OR"===r){const e="("+i(t)+")";o.push(e);continue}const l=-1!==t.field.indexOf("AS")?t.field+" "+t.op+" "+t.value:"`"+t.field+"` "+t.op+" "+t.value;o.push(l),t.group&&a.push(t.group)}return o.join(" "+t+" ")}return null},s=i(t);SHOW_DEBUG;return data_manager.request({body:{dedalo_get:"records",db_name:page_globals.WEB_DB,table:l,ar_fields:n,lang:r,sql_filter:s,limit:0,count:!1,order:o}})},render_data:function(e){const t=this;return new Promise((function(n){const o=e.ar_rows,r=common.is_node(e.target)?e.target:document.getElementById(e.target);r.className="",r.classList.add(t.view_mode);const l=e.set_hilite||!1,a=t.view_mode,i=t.root_term;switch(a){default:case"tree":const e=t.term_id?[t.term_id]:null;t.data_clean=page.parse_tree_data(o,e),console.log("self.data_clean:",t.data_clean),t.tree=t.tree||new tree_factory,t.tree.init({target:r,data:t.data_clean,root_term:i,set_hilite:l}),t.tree.render().then((function(){n(!0)}))}}))},render_form:function(e){const t=this;return new Promise((function(n){const o=new DocumentFragment;t.form=t.form||new form_factory;const r=common.create_dom_element({element_type:"div",class_name:"global_search_container form-row fields",parent:o});t.form.item_factory({id:"term",name:"term",class_name:"global_search",label:tstring.term||"Term",q_column:"term",eq:"LIKE",eq_in:"%",eq_out:"%",parent:r,callback:function(e){const n=e.node_input;t.activate_autocomplete(n)}});const l=common.create_dom_element({element_type:"div",class_name:"form-group submit field",parent:o});common.create_dom_element({element_type:"input",type:"submit",id:"submit",value:tstring.buscar||"Search",class_name:"btn btn-light btn-block primary",parent:l}).addEventListener("click",(function(e){e.preventDefault(),t.form_submit()})),t.form.node=common.create_dom_element({element_type:"form",id:"search_form",class_name:"form-inline form_factory"}),t.form.node.appendChild(o),e.container.appendChild(t.form.node),n(t.form.node)}))},activate_autocomplete:function(e){const t=this;let n;return $(e).autocomplete({delay:150,minLength:1,source:function(o,r){const l=o.term;n=t.form.form_items[e.id];const a=n.q_column;t.search_rows({q:l,q_column:a,limit:25}).then(e=>{const t=[],n=e.result.length;for(let o=0;o<n;o++){const n=e.result[o];t.push({label:n.label,value:n.value})}!0===SHOW_DEBUG&&(console.log("--- autocomplete api_response:",e),console.log("autocomplete ar_result:",t)),r(t)})},select:function(e,o){return e.preventDefault(),t.form.add_selected_value(n,o.item.label,o.item.value),this.value="",!1},focus:function(){return!1},close:function(e,t){},change:function(e,t){},response:function(e,t){}}).on("keydown",(function(e){e.keyCode===$.ui.keyCode.ENTER&&$(this).autocomplete("close")})).focus((function(){$(this).autocomplete("search",null)})).blur((function(){})),!0},search_rows:function(e){const t=this;return new Promise((function(n){const o=performance.now(),r=e.q,l=e.q_column,a=e.q_selected||null,i=e.limit,s=t.data_clean.map(e=>({term:e.term,scope_note:e.scope_note,parent:e.parent,term_id:e.term_id,nd:e.nd}));let c=1;n({result:s.filter((function(e){if(i>0&&c>i)return!1;let t=!1;if(r&&r.length>0){const n=e[l].normalize("NFD").replace(/[\u0300-\u036f]/g,""),o=RegExp(r,"i");if(t=o.test(n),!t&&e.nd&&e.nd.length>0)for(let n=0;n<e.nd.length;n++){const r=e.nd[n].normalize("NFD").replace(/[\u0300-\u036f]/g,"");if(t=o.test(r),!0===t)break}}if(!t&&a)for(let n=0;n<a.length;n++)if(e.term_id===a[n]){t=!0;break}return!0===t&&c++,t})).map(e=>{const n=e.parent[0],o=t.data_clean.find(e=>e.term_id===n),r=o?" ("+o.term+")":"",l=e.nd?" ["+e.nd.join(", ")+"]":"";return{label:e.term+l+r,value:e.term_id}}),debug:{time:performance.now()-o}})}))},form_submit:function(){const e=this,t=e.form.form_items,n=t.term;console.log("form_items:",t),console.log("form_item:",n);return e.search_rows({q:n.q,q_column:n.q_column,q_selected:n.q_selected,limit:0}).then(t=>{!0===SHOW_DEBUG&&console.log("--- form_submit response:",t);const n=t.result.map(e=>e.value);e.term_id=null;const o=document.getElementById("rows_list");for(;o.hasChildNodes();)o.removeChild(o.lastChild);const r=common.create_dom_element({element_type:"div",id:"spinner",class_name:"spinner",parent:o});e.load_tree_data({}).then((function(t){const l=t.result.map((function(e){return-1!==n.indexOf(e.term_id)&&(e.hilite=!0,e.status="closed"),e}));e.render_data({target:o,ar_rows:l,set_hilite:!0}).then((function(){r.remove()}))}))})}};