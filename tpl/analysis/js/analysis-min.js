var analysis_min=function(exports){"use strict";const COLOR_PALETTE=["#1f77b4","#ff7f0e","#2ca02c","#d62728","#9467bd","#8c564b","#e377c2","#17becf"];function chart_wrapper(div_wrapper,options){if(this.constructor===chart_wrapper)throw new Error("Abstract class 'chart_wrapper' cannot be instantiated");chart_wrapper._n_charts_created++,this.id=chart_wrapper._n_charts_created,this.div_wrapper=div_wrapper,this._display_download=options.display_download||!1,this._download_chart_container=void 0,this.plot_container=void 0,this._display_control_panel=options.display_control_panel||!1,this._controls_container=void 0,this._controls_toggle=void 0,this.controls_content_container=void 0}function d3_chart_wrapper(div_wrapper,options){if(this.constructor===d3_chart_wrapper)throw new Error("Abstract class 'd3_chart_wrapper' cannot be instantiated");chart_wrapper.call(this,div_wrapper,options),this.svg=void 0,this._overflow=options.overflow||!1,this._outer_height=options.outer_height||"500px"}function toggle_visibility(element){0==element.attr("opacity")?element.transition().attr("opacity",1):element.transition().attr("opacity",0)}function linspace(start,stop,nsteps){const delta=(stop-start)/(nsteps-1);return d3.range(nsteps).map((i=>start+i*delta))}chart_wrapper._n_charts_created=0,chart_wrapper.prototype.id_string=function(){return`chart${this.id}`},chart_wrapper.prototype.render=function(){this.div_wrapper.replaceChildren(),this.render_plot(),this._display_control_panel&&this.render_control_panel(),this._display_download&&this._render_download_panel()},chart_wrapper.prototype._render_download_panel=function(){const supported_formats=this.get_supported_export_formats();if(!supported_formats.length)return;this.download_chart_container=common.create_dom_element({element_type:"div",id:`${this.id_string()}_download_chart_container`,class_name:"o-purple download_chart_container",parent:this.div_wrapper});const format_select=common.create_dom_element({element_type:"select",id:`${this.id_string()}_chart_export_format`,class_name:"chart_format_select",parent:this.download_chart_container});for(const format of supported_formats)common.create_dom_element({element_type:"option",value:format,text_content:format.toUpperCase(),parent:format_select});common.create_dom_element({element_type:"input",type:"button",class_name:"btn primary button_download chart",value:tstring.download||"Download",parent:this.download_chart_container}).addEventListener("click",(()=>{this.download_chart(format_select.value)}))},chart_wrapper.prototype.render_plot=function(){this.plot_container=common.create_dom_element({element_type:"div",id:`${this.id_string()}_plot_container`,class_name:"o-purple plot_container",parent:this.div_wrapper})},chart_wrapper.prototype.render_control_panel=function(){const self=this;this._controls_container=common.create_dom_element({element_type:"div",id:`${this.id_string()}_control_panel`,class_name:"control_panel",parent:this.div_wrapper}),this._controls_toggle=common.create_dom_element({element_type:"div",id:`${this.id_string()}_control_panel_toggle`,text_content:tstring.control_panel||"Control panel",class_name:"o-red control_panel_toggle opened",parent:this._controls_container}),this._controls_toggle.addEventListener("click",(function(){self._controls_toggle.classList.toggle("opened"),self.controls_content_container.classList.toggle("hide")})),this.controls_content_container=common.create_dom_element({element_type:"div",id:`${this.id_string()}_control_panel_content`,class_name:"o-green control_panel_content hide",parent:this._controls_container})},chart_wrapper.prototype.download_chart=function(format){const filename=`chart.${format}`,download_func_name=`download_chart_as_${format}`;if(void 0===this[download_func_name])throw new Error(`${download_func_name} is not implemented!`);this[download_func_name](filename)},chart_wrapper.prototype.get_supported_export_formats=function(){return[]},Object.setPrototypeOf(d3_chart_wrapper.prototype,chart_wrapper.prototype),d3_chart_wrapper.prototype.render_plot=function(){chart_wrapper.prototype.render_plot.call(this),this.svg=d3.select(this.plot_container).append("svg").attr("version","1.1").attr("xmlns","http://www.w3.org/2000/svg"),this._overflow?(this.svg.attr("width",null).attr("height",this._outer_height),this.plot_container.style="overflow: auto;"):this.svg.attr("width","100%")},d3_chart_wrapper.prototype.get_supported_export_formats=function(){return["svg"]},d3_chart_wrapper.prototype.download_chart_as_svg=function(filename){const svg_data=this.svg.node().outerHTML,svg_blob=new Blob([svg_data],{type:"image/svg+xml;charset=utf-8"}),url=URL.createObjectURL(svg_blob),tmpLink=common.create_dom_element({element_type:"a",href:url});tmpLink.setAttribute("download",filename),tmpLink.click(),tmpLink.remove(),URL.revokeObjectURL(url)};const CURVES={Basis:d3.curveBasis,"Basis closed":d3.curveBasisClosed,"Basis open":d3.curveBasisOpen,Bundle:d3.curveBundle,"Bump X":d3.curveBumpX,"Bump Y":d3.curveBumpY,Cardinal:d3.curveCardinal,"Cardinal closed":d3.curveCardinalClosed,"Cardinal open":d3.curveCardinalOpen,"Catmull-Rom":d3.curveCatmullRom,"Catmull-Rom closed":d3.curveCatmullRomClosed,"Catmull-Rom open":d3.curveCatmullRomOpen,Linear:d3.curveLinear,"Linear closed":d3.curveLinearClosed,"Monotone X":d3.curveMonotoneX,"Monotone Y":d3.curveMonotoneY,Natural:d3.curveNatural,Step:d3.curveStep,"Step after":d3.curveStepAfter,"Step before":d3.curveStepBefore};function compute_n_bins(){}function insert_after(new_node,existing_node){existing_node.parentNode.insertBefore(new_node,existing_node.nextSibling)}function array_equal(...arrs){if(!arrs.length)throw new Error("There are no input arrays");const size=arrs[0].length;for(const arr of arrs.slice(1))if(arr.length!==size)return!1;for(let i=0;i<size;i++){const value=arrs[0][i];for(const arr of arrs.slice(1))if(arr[i]!==value)return!1}return!0}function keyed_data(data){this._data=data,this.key_size=data[0].key.length}function calc_boxplot_metrics(values,whiskers_quantiles=null){const metrics={max:null,upper_fence:null,quartile3:null,median:null,mean:null,iqr:null,quartile1:null,lower_fence:null,min:null};return metrics.min=d3.min(values),metrics.quartile1=d3.quantile(values,.25),metrics.median=d3.median(values),metrics.mean=d3.mean(values),metrics.quartile3=d3.quantile(values,.75),metrics.max=d3.max(values),metrics.iqr=metrics.quartile3-metrics.quartile1,metrics.lower_fence=whiskers_quantiles?d3.quantile(values,whiskers_quantiles[0]/100):metrics.quartile1-1.5*metrics.iqr,metrics.upper_fence=whiskers_quantiles?d3.quantile(values,whiskers_quantiles[1]/100):metrics.quartile3+1.5*metrics.iqr,metrics}compute_n_bins.sqrt=function(values){return Math.ceil(Math.sqrt(values.length))},compute_n_bins.sturges=function(values){return Math.ceil(Math.log2(values.length))+1},compute_n_bins.rice=function(values){return Math.ceil(2*Math.pow(values.length,1/3))},compute_n_bins.doane=function(values){const n=values.length;if(n<2)throw new Error("Doane's rule needs at least 2 datapoints");const sigma=Math.sqrt(6*(n-2)/((n+1)*(n+3))),std=d3.deviation(values),mean=d3.mean(values),sum=d3.sum(values),skew=Math.sqrt(n*(n+1))/(n-2)*((sum-n*mean)/(n*Math.pow(std,3)));return 1+Math.ceil(Math.log2(n))+Math.ceil(Math.log2(1+Math.abs(skew)/sigma))},compute_n_bins.scott=function(values){if(values.length<2)throw new Error("Cannot compute standard deviation of an array with less than 2 values");return Math.ceil((d3.max(values)-d3.min(values))*Math.pow(values.length,1/3)/(3.49*d3.deviation(values)))},compute_n_bins.freedman_diaconis=function(values){const quartile3=d3.quantile(values,.75),quartile1=d3.quantile(values,.25),iqr=quartile3-quartile1;if(quartile1===quartile3)throw new Error("IQR is 0!");return Math.ceil((d3.max(values)-d3.min(values))*Math.pow(values.length,1/3)/(2*iqr))},keyed_data.prototype.key_values=function(rank){if(rank<1||rank>this.key_size)throw new Error(`Rank ${rank} does not exist in a key of size ${this.key_size}`);const index=this.key_size-rank;return Array.from(new Set(this._data.map((datum=>datum.key[index]))))},keyed_data.prototype.query=function(key_tpl){if(key_tpl.length!==this.key_size)throw new Error("Key template is of different size than the plot keys");return this._data.filter((ele=>{const key=ele.key;for(let i=0;i<key.length;i++)if(key_tpl[i]&&key_tpl[i]!==key[i])return!1;return!0}))},keyed_data.prototype.get_key_templates=function(rank){if(rank<1||rank>this.key_size)throw new Error(`Invalid rank ${rank} for key with size ${this.key_size}`);const i=this.key_size-rank,templates_wd=this._data.map((ele=>ele.key.slice(0,i+1).concat(Array(this.key_size-i-1).fill(null))));if(!templates_wd.length)return templates_wd;const templates=[templates_wd[0]];let tmp_template=templates_wd[0];for(const template of templates_wd.slice(1))array_equal(tmp_template,template)||(templates.push(template),tmp_template=template);return templates},keyed_data.prototype.get_next_key_component_values=function(pkey){const psize=pkey.length;if(psize>=this.key_size)throw new Error(`Input key ${pkey} is as long or longer than the actual keys!`);const key_tpl=pkey.concat(Array(this.key_size-psize).fill(null));return Array.from(new Set(this.query(key_tpl).map((ele=>ele.key[psize]))))};const GROUP_CHANGE_EVENT=new Event("ch_group_change"),KEY2_MARGIN$1=[10,33];function boxvio_chart_wrapper(div_wrapper,data,key_titles,options){d3_chart_wrapper.call(this,div_wrapper,options),this._tooltip_callback=options.tooltip_callback||null,this._tooltip_callback_options_attributes=options.tooltip_callback_options_attributes||null,this._whiskers_quantiles=options.whiskers_quantiles||null;const sort_xaxis=options.sort_xaxis||data[0].key.length>1||!1;if(!data.length)throw new Error("Data array is empty");this._data=sort_xaxis?data.sort(((a,b)=>a.key.join().localeCompare(b.key.join()))):data;for(const[i,ele]of this._data.entries())ele.metrics=calc_boxplot_metrics(ele.values,this._whiskers_quantiles),ele.outliers=ele.values.filter((v=>v<ele.metrics.lower_fence||v>ele.metrics.upper_fence)),ele.extent=d3.extent(ele.values);this._data_extent=d3.extent(this._data.map((ele=>ele.extent)).flat()),this._ids=this._data.map((ele=>ele.id)),this._key_titles=key_titles,this._kdm=new keyed_data(this._data),this._key2_values=this._kdm.key_size>1?this._kdm.key_values(2):null,this._colors=this._data.map(((_,i)=>COLOR_PALETTE[i%COLOR_PALETTE.length])),this._ylabel=options.ylabel||null,this.yaxis_padding=this._ylabel?62:35,this._full_width=this._data.length<150?330.664701211*Math.sqrt(this._data.length)-170.664701211+this.yaxis_padding:26*this._data.length+this.yaxis_padding,this._kdm.key_size>1&&(this._full_width+=this._key2_values.length*d3.sum(KEY2_MARGIN$1)),this._full_height=453,this._chart={},this._chart.tooltip_active=null,this._chart.margin={top:15,right:4,bottom:61,left:this.yaxis_padding},this._chart.width=this._full_width-this._chart.margin.left-this._chart.margin.right,this._chart.height=this._full_height-this._chart.margin.top-this._chart.margin.bottom,this._chart.yscale=d3.scaleLinear().range([this._chart.height,0]).domain(this._data_extent).clamp(!0),this._chart.yticks_division=2,this._chart.yaxis=d3.axisLeft(this._chart.yscale).tickFormat(((d,i)=>i%this._chart.yticks_division?"":d.toFixed(1))).ticks(19),this._chart.violin_scale={initial:.8,value:.8},this._chart.violin_bandwidth=(this._chart.width-this._key2_values.length*d3.sum(KEY2_MARGIN$1))/this._data.length,this._chart.box_scale={initial:.3,value:.3},this._chart.xscale=d3.scaleBand().domain(this._ids).range([0,this._chart.width]),this._chart.key2_start_x=this._kdm.key_size>1?this._compute_key2_start_x():null,this._chart.datum_start_x=this._compute_datum_start_x(),this._chart.xaxis=d3.axisBottom(this._chart.xscale).tickFormat((id=>this._data.find((datum=>datum.id===id)).key[this._kdm.key_size-1])),this._chart.xticklabel_angle=options.xticklabel_angle||0,this._chart.n_bins=this._data.map((ele=>{const initial_value=compute_n_bins.sturges(ele.values);return{initial:initial_value,value:initial_value}})),this._chart.histogram=this._data.map(((ele,i)=>d3.bin().domain(ele.extent).thresholds(linspace(ele.extent[0],ele.extent[1],this._chart.n_bins[i].value+1)))),this._chart.bins=this._data.map(((ele,i)=>this._chart.histogram[i](ele.values))),this._chart.supported_curves=["Basis","Bump Y","Cardinal","Catmull-Rom","Linear","Monotone Y","Natural","Step"],this._chart.violin_curve=CURVES[this._chart.supported_curves[0]],this._graphics={root_g:null,yaxwl_g:null,xaxis_g:null,yaxwl_g:null,yaxis_g:null,key2_dividers_g:null,violins_g:null,violins:[],boxes_g:null,outliers:[],whiskers:[],tooltip_div:null},this._controls={max_bins_multiplier:3,selected_index:0,sections:{general:{title:null,content_container:null},specific:{title:null,content_container:null}},grid_select:null,xticklabel_angle_slider:null,curve_select:null,show_checkboxes:{key2:null,violins:null,boxes:null,whiskers:null,outliers:null},scale:{violin:{slider:null,reset:null},box:{slider:null,reset:null}},violin_n_bins:{slider:null,reset:null,reset_all:null}}}Object.setPrototypeOf(boxvio_chart_wrapper.prototype,d3_chart_wrapper.prototype),boxvio_chart_wrapper.prototype._compute_key2_start_x=function(){const positions={},key_tpls=this._kdm.get_key_templates(2);let current_x=0;for(const key_tpl of key_tpls){const queried_data=this._kdm.query(key_tpl);positions[key_tpl[key_tpl.length-2]]=current_x,current_x+=d3.sum(KEY2_MARGIN$1)+this._chart.violin_bandwidth*queried_data.length}return positions},boxvio_chart_wrapper.prototype._compute_datum_start_x=function(){if(1===this._kdm.key_size)return this._ids.map((id=>this._chart.xscale(id)));const datum_start_x=[];let current_x=KEY2_MARGIN$1[1],current_key2=this._data[0].key[this._kdm.key_size-2];for(const datum of this._data){const key2=datum.key[this._kdm.key_size-2];current_key2!==key2&&(current_key2=key2,current_x+=d3.sum(KEY2_MARGIN$1)),datum_start_x.push(current_x),current_x+=this._chart.violin_bandwidth}return datum_start_x},boxvio_chart_wrapper.prototype.set_violin_scale=function(scale){this._chart.violin_scale.value=scale,this._graphics.violins_g.selectAll("*").remove(),this._render_violins(!0)},boxvio_chart_wrapper.prototype.set_n_bins=function(i,n_bins){const chart=this._chart,extent=this._data[i].extent;chart.n_bins[i].value=n_bins,chart.histogram[i].thresholds(linspace(extent[0],extent[1],n_bins+1)),chart.bins[i]=chart.histogram[i](this._data[i].values),this._graphics.violins[i].selectAll("*").remove(),this._render_violin(i)},boxvio_chart_wrapper.prototype.set_violin_curve=function(curve_name){this._chart.violin_curve=CURVES[curve_name],this._graphics.violins_g.selectAll("*").remove(),this._render_violins(!0)},boxvio_chart_wrapper.prototype.set_box_scale=function(scale){this._chart.box_scale.value=scale,this._graphics.boxes_g.selectAll("*").remove(),this._render_boxes(!0)},boxvio_chart_wrapper.prototype.render_plot=function(){d3_chart_wrapper.prototype.render_plot.call(this),this.svg.attr("viewBox",`0 0 ${this._full_width} ${this._full_height}`),this.svg.on("click",(e=>{e.stopPropagation(),this._hide_tooltip()})),this.plot_container.addEventListener("click",(e=>{e.stopPropagation(),this._hide_tooltip()})),this._graphics.root_g=this.svg.append("g").attr("transform",`translate(${this._chart.margin.left},${this._chart.margin.top})`),this._render_axis(),this._render_ygrid(),this._kdm.key_size>1&&this._render_key2_dividers(),this._render_violins(),this._render_boxes(),this._render_tooltip()},boxvio_chart_wrapper.prototype._render_axis=function(){const g=this._graphics.root_g;this._graphics.xaxwl_g=g.append("g").attr("transform",`translate(0,${this._chart.height})`);const xaxwl_g=this._graphics.xaxwl_g;if(this._graphics.xaxis_g=xaxwl_g.append("g").call(this._chart.xaxis),this._kdm.key_size>1){const half_bandwidth=this._chart.violin_bandwidth/2;this._graphics.xaxis_g.selectAll("g.tick").attr("transform",((_,i)=>`translate(${this._chart.datum_start_x[i]+half_bandwidth},0)`))}this.apply_xticklabel_angle(),xaxwl_g.append("text").attr("text-anchor","middle").attr("y",50).attr("x",this._chart.width/2).text(this._key_titles[this._key_titles.length-1]),this._graphics.yaxwl_g=g.append("g");const yaxwl_g=this._graphics.yaxwl_g;this._graphics.yaxis_g=yaxwl_g.append("g").call(this._chart.yaxis),yaxwl_g.append("text").attr("text-anchor","middle").attr("transform","rotate(-90)").attr("y",20-this._chart.margin.left).attr("x",-this._chart.height/2).text(this._ylabel)},boxvio_chart_wrapper.prototype.apply_xticklabel_angle=function(){const angle=this._chart.xticklabel_angle,xaxis_g=this._graphics.xaxis_g;angle<10?xaxis_g.selectAll("text").attr("text-anchor","middle").attr("dy","0.8em").attr("dx","0").attr("transform",`rotate(${-this._chart.xticklabel_angle})`):(xaxis_g.selectAll("text").attr("text-anchor","end").attr("dy",-angle*angle*6172839e-11+"em").attr("dx","-0.9em").attr("transform",`rotate(${-this._chart.xticklabel_angle})`),angle<50&&xaxis_g.selectAll("text").attr("dx","-0.7em"))},boxvio_chart_wrapper.prototype._render_ygrid=function(){this._graphics.yaxis_g.selectAll("g.tick").append("line").attr("x1",0).attr("y1",0).attr("x2",this._chart.width).attr("y2",0).attr("stroke",((_,i)=>i%2?"#E0E0E0":"#D1D1D1")).attr("stroke-width",((_,i)=>i%2?.5:.8)).attr("class",((_,i)=>i%2?"minor":"major")).attr("opacity",0)},boxvio_chart_wrapper.prototype.apply_ygrid_mode=function(mode){const major_lines=this._graphics.yaxis_g.selectAll("g.tick line.major"),major_opacity=major_lines.attr("opacity"),minor_lines=this._graphics.yaxis_g.selectAll("g.tick line.minor"),minor_opacity=minor_lines.attr("opacity");switch(mode){case"None":1==major_opacity&&toggle_visibility(major_lines),1==minor_opacity&&toggle_visibility(minor_lines);break;case"Major":0==major_opacity&&toggle_visibility(major_lines),1==minor_opacity&&toggle_visibility(minor_lines);break;case"Major + Minor":0==major_opacity&&toggle_visibility(major_lines),0==minor_opacity&&toggle_visibility(minor_lines);break;default:throw new Error(`Grid mode '${mode}' is not supported?`)}},boxvio_chart_wrapper.prototype._render_key2_dividers=function(){this._graphics.key2_dividers_g=this._graphics.root_g.append("g");const dividers_g=this._graphics.key2_dividers_g;for(const[index,key2]of this._key2_values.entries()){const x=this._chart.key2_start_x[key2],divider_g=dividers_g.append("g").attr("transform",`translate(${x},0)`);0!==index&&divider_g.append("line").attr("x1",0).attr("y1",0).attr("x2",0).attr("y2",this._chart.height).attr("stroke","gray").attr("stroke-width",.9).attr("stroke-dasharray",this._chart.height/35),divider_g.append("text").attr("text-anchor","end").attr("transform","rotate(-90)").attr("y","1.3em").attr("x","-0.6em").attr("font-size","0.8em").attr("fill","gray").text(key2)}},boxvio_chart_wrapper.prototype._render_violins=function(is_g_ready=!1){const chart=this._chart,g=this._graphics.root_g;is_g_ready||(this._graphics.violins_g=g.append("g"));const violins_g=this._graphics.violins_g;for(let i=0;i<this._data.length;i++)this._graphics.violins[i]=violins_g.append("g").classed("clickable",!0).attr("transform",`translate(${chart.datum_start_x[i]},0)`),this._graphics.violins[i].on("click",(e=>{e.stopPropagation(),this.set_selected_index(i)})),this._render_violin(i)},boxvio_chart_wrapper.prototype._render_violin=function(i){const bins=this._chart.bins[i],violin_scale=this._chart.violin_scale.value,bandwidth=this._chart.violin_bandwidth,yscale=this._chart.yscale,violin_curve=this._chart.violin_curve,max_count=d3.max(bins,(bin=>bin.length)),x_num=d3.scaleLinear().range([0,bandwidth]).domain([-max_count,max_count]);this._data[i].values.length>1&&this._graphics.violins[i].append("path").datum(bins).style("stroke","gray").style("stroke-width",.4).style("fill","#d2d2d2").attr("d",d3.area().x0((d=>x_num(-d.length*violin_scale))).x1((d=>x_num(d.length*violin_scale))).y((d=>yscale(d.x0))).curve(violin_curve))},boxvio_chart_wrapper.prototype._render_boxes=function(is_g_ready=!1){const chart=this._chart,g=this._graphics.root_g;is_g_ready||(this._graphics.boxes_g=g.append("g"));const boxes=this._graphics.boxes_g,bandwidth=chart.violin_bandwidth,box_width=this._chart.box_scale.value*bandwidth;for(const[i,ele]of this._data.entries()){const metrics=ele.metrics,color=this._colors[i],group_box=boxes.append("g").classed("clickable",!0).attr("transform",`translate(${chart.datum_start_x[i]+bandwidth/2},0)`);group_box.on("click",(e=>{e.stopPropagation(),this.set_selected_index(i)})),this._graphics.outliers[i]=group_box.append("g");const outliers=this._graphics.outliers[i];for(const outlier of ele.outliers)outliers.append("circle").attr("cx",0).attr("cy",chart.yscale(outlier)).attr("r",4).style("fill",color).style("opacity",.7);this._graphics.whiskers[i]=group_box.append("g");const whiskers=this._graphics.whiskers[i];whiskers.append("line").attr("x1",0).attr("y1",chart.yscale(metrics.lower_fence)).attr("x2",0).attr("y2",chart.yscale(metrics.upper_fence)).attr("stroke",color).attr("stroke-width",2),whiskers.append("line").attr("x1",-box_width/2).attr("y1",chart.yscale(metrics.lower_fence)).attr("x2",box_width/2).attr("y2",chart.yscale(metrics.lower_fence)).attr("stroke",color).attr("stroke-width",2),whiskers.append("line").attr("x1",-box_width/2).attr("y1",chart.yscale(metrics.upper_fence)).attr("x2",box_width/2).attr("y2",chart.yscale(metrics.upper_fence)).attr("stroke",color).attr("stroke-width",2);const iqr=group_box.append("g");ele.values.length>1&&iqr.append("rect").attr("x",-box_width/2).attr("y",chart.yscale(metrics.quartile3)).attr("width",box_width).attr("height",chart.yscale(metrics.quartile1)-chart.yscale(metrics.quartile3)).attr("fill",color),iqr.append("line").attr("x1",-box_width/2).attr("y1",chart.yscale(metrics.median)).attr("x2",box_width/2).attr("y2",chart.yscale(metrics.median)).attr("stroke","black").attr("stroke-width",3);iqr.append("circle").attr("cx",0).attr("cy",chart.yscale(metrics.median)).attr("r",4.5).style("fill","white").attr("stroke","black").attr("stroke-width",2).classed("clickable",!0).on("click",(e=>{e.stopPropagation(),this.set_selected_index(i),this._chart.tooltip_active!=i&&(this.tooltip_show(i),this._graphics.tooltip_div.style("display","flex"),this._chart.tooltip_active=i)}))}},boxvio_chart_wrapper.prototype.set_selected_index=function(i){this._controls.selected_index!==i&&(this._controls.selected_index=i,this._set_specific_controls_section_title(i),this._controls.violin_n_bins.slider.dispatchEvent(GROUP_CHANGE_EVENT))},boxvio_chart_wrapper.prototype._set_specific_controls_section_title=function(selected_index){const datum=this._data[selected_index];this._controls.sections.specific.title.innerText=`${tstring.settings_for||"Settings for"} ${datum.key.join(", ")} (${datum.id})`},boxvio_chart_wrapper.prototype._hide_tooltip=function(){this._graphics.tooltip_div.style("display","none"),this._chart.tooltip_active=null},boxvio_chart_wrapper.prototype._render_tooltip=function(){const tooltip_element=common.create_dom_element({element_type:"div",id:`${this.id_string()}_tooltip_div`,class_name:"o-red tooltip_div"});insert_after(tooltip_element,this.plot_container),this._graphics.tooltip_div=d3.select(tooltip_element),this._hide_tooltip();const tooltip_metrics=common.create_dom_element({element_type:"div",id:`${this.id_string()}_tooltip_metrics`,class_name:"tooltip_metrics_div",parent:tooltip_element});common.create_dom_element({element_type:"div",id:`${this.id_string()}_tooltip_metric_names_div`,class_name:"tooltip_metric_names_div",parent:tooltip_metrics}),common.create_dom_element({element_type:"div",id:`${this.id_string()}_tooltip_metric_values_div`,class_name:"tooltip_metric_values_div",parent:tooltip_metrics})},boxvio_chart_wrapper.prototype.tooltip_show=function(i){const self=this,values=self._data[i].values,metrics=self._data[i].metrics,metric_names=`${tstring.datapoints||"Datapoints"}<br>${tstring.mean||"Mean"}<br>${tstring.max||"Maximum"}`+(self._whiskers_quantiles?`<br>${tstring.quantile}-${self._whiskers_quantiles[1]}`:"")+`<br>${tstring.quantile||"Quantile"}-75`+`<br>${tstring.median||"Median"}`+`<br>${tstring.quantile||"Quantile"}-25`+(self._whiskers_quantiles?`<br>${tstring.quantile}-${self._whiskers_quantiles[0]}`:"")+`<br>${tstring.min||"Minimum"}`,metric_values=`${values.length}<br>${metrics.mean.toFixed(2)}<br>${metrics.max.toFixed(2)}`+(self._whiskers_quantiles?`<br>${metrics.upper_fence.toFixed(2)}`:"")+`<br>${metrics.quartile3.toFixed(2)}`+`<br>${metrics.median.toFixed(2)}`+`<br>${metrics.quartile1.toFixed(2)}`+(self._whiskers_quantiles?`<br>${metrics.lower_fence.toFixed(2)}`:"")+`<br>${metrics.min.toFixed(2)}`;if(self._graphics.tooltip_div.select("div.tooltip_metric_names_div").html(metric_names),self._graphics.tooltip_div.select("div.tooltip_metric_values_div").html(metric_values),self._tooltip_callback){const options={};for(const attr_name of this._tooltip_callback_options_attributes)options[attr_name]=this._data[i][attr_name];self._tooltip_callback(options).then((ele=>{const tooltip_element=self._graphics.tooltip_div.node();ele.id=`${self.id_string()}_tooltip_callback_div`,ele.classList.add("tooltip_callback_div");const last_child=tooltip_element.lastChild;last_child.classList.contains("tooltip_callback_div")&&last_child.remove(),tooltip_element.appendChild(ele)}))}},boxvio_chart_wrapper.prototype.render_control_panel=function(){d3_chart_wrapper.prototype.render_control_panel.call(this),this._controls.sections.general.title=common.create_dom_element({element_type:"div",text_content:tstring.general_settings||"General settings",class_name:"control_panel_toggle control_panel_toggle_section",parent:this.controls_content_container}),this._controls.sections.general.content_container=common.create_dom_element({element_type:"div",parent:this.controls_content_container});const upper_container=common.create_dom_element({element_type:"div",class_name:"control_panel_item controls_block",parent:this._controls.sections.general.content_container});this._render_grid_select(upper_container),this._render_xticklabel_angle_slider(upper_container),this._render_violin_curve_selector(upper_container),this._render_checkboxes(),this._render_scale_sliders(),this._controls.sections.specific.title=common.create_dom_element({element_type:"div",class_name:"control_panel_toggle control_panel_toggle_section",parent:this.controls_content_container}),this._set_specific_controls_section_title(this._controls.selected_index),this._controls.sections.specific.content_container=common.create_dom_element({element_type:"div",parent:this.controls_content_container}),this._render_n_bins_control(),this._control_panel_logic()},boxvio_chart_wrapper.prototype._render_grid_select=function(container){const select_container=common.create_dom_element({element_type:"div",parent:container}),grid_select_id=`${this.id_string()}_grid_select`;common.create_dom_element({element_type:"label",text_content:tstring.grid||"Grid",parent:select_container,style:{"margin-block":"auto"}}).setAttribute("for",grid_select_id);const grid_select=common.create_dom_element({element_type:"select",id:grid_select_id,parent:select_container});this._controls.grid_select=grid_select,common.create_dom_element({element_type:"option",value:"None",text_content:tstring.none_f||"None",parent:grid_select}),common.create_dom_element({element_type:"option",value:"Major",text_content:tstring.major||"Major",parent:grid_select}),common.create_dom_element({element_type:"option",value:"Major + Minor",text_content:tstring.major_minor||"Major + Minor",parent:grid_select})},boxvio_chart_wrapper.prototype._render_xticklabel_angle_slider=function(container){const slider_container=common.create_dom_element({element_type:"div",parent:container}),xticklabel_angle_slider_id=`${this.id_string()}_xticklabel_angle_slider`;common.create_dom_element({element_type:"label",text_content:tstring.xticklabel_angle||"X-Tick label angle",parent:slider_container}).setAttribute("for",xticklabel_angle_slider_id);const xticklabel_angle_slider=common.create_dom_element({element_type:"input",type:"range",id:xticklabel_angle_slider_id,parent:slider_container});this._controls.xticklabel_angle_slider=xticklabel_angle_slider,xticklabel_angle_slider.setAttribute("min",0),xticklabel_angle_slider.setAttribute("max",90),xticklabel_angle_slider.value=this._chart.xticklabel_angle},boxvio_chart_wrapper.prototype._render_violin_curve_selector=function(container){const select_container=common.create_dom_element({element_type:"div",parent:container}),curve_select_id=`${this.id_string()}_curve_select`;common.create_dom_element({element_type:"label",text_content:tstring.violin_curve||"Violin curve",parent:select_container}).setAttribute("for",curve_select_id);const curve_select=common.create_dom_element({element_type:"select",id:curve_select_id,parent:select_container});this._controls.curve_select=curve_select;for(const curve_name of this._chart.supported_curves)common.create_dom_element({element_type:"option",value:curve_name,text_content:curve_name,parent:curve_select})},boxvio_chart_wrapper.prototype._render_checkboxes=function(){const container_div=common.create_dom_element({element_type:"div",class_name:"control_panel_item checkboxes",parent:this._controls.sections.general.content_container});common.create_dom_element({element_type:"div",text_content:`${tstring.show||"Show"}:`,parent:container_div});const show_key2_div=common.create_dom_element({element_type:"div",parent:container_div}),show_key2_checkbox_id=`${this.id_string()}_show_key2_checkbox`,show_key2_checkbox=common.create_dom_element({element_type:"input",type:"checkbox",id:show_key2_checkbox_id,parent:show_key2_div});show_key2_checkbox.checked=!0,this._controls.show_checkboxes.key2=show_key2_checkbox;common.create_dom_element({element_type:"label",text_content:this._key_titles[this._kdm.key_size-2],parent:show_key2_div}).setAttribute("for",show_key2_checkbox_id);const show_violins_div=common.create_dom_element({element_type:"div",parent:container_div}),show_violins_checkbox_id=`${this.id_string()}_show_violins_checkbox`,show_violins_checkbox=common.create_dom_element({element_type:"input",type:"checkbox",id:show_violins_checkbox_id,parent:show_violins_div});show_violins_checkbox.checked=!0,this._controls.show_checkboxes.violins=show_violins_checkbox;common.create_dom_element({element_type:"label",text_content:tstring.violins||"Violins",parent:show_violins_div}).setAttribute("for",show_violins_checkbox_id);const show_boxes_div=common.create_dom_element({element_type:"div",parent:container_div}),show_boxes_checkbox_id=`${this.id_string()}_show_boxes_checkbox`,show_boxes_checkbox=common.create_dom_element({element_type:"input",type:"checkbox",id:show_boxes_checkbox_id,parent:show_boxes_div});show_boxes_checkbox.checked=!0,this._controls.show_checkboxes.boxes=show_boxes_checkbox;common.create_dom_element({element_type:"label",text_content:tstring.boxes||"Boxes",parent:show_boxes_div}).setAttribute("for",show_boxes_checkbox_id);const show_whiskers_div=common.create_dom_element({element_type:"div",parent:container_div}),show_whiskers_checkbox_id=`${this.id_string()}_show_whiskers_checkbox`,show_whiskers_checkbox=common.create_dom_element({element_type:"input",type:"checkbox",id:show_whiskers_checkbox_id,parent:show_whiskers_div});show_whiskers_checkbox.checked=!0,this._controls.show_checkboxes.whiskers=show_whiskers_checkbox;common.create_dom_element({element_type:"label",text_content:tstring.whiskers||"Whiskers",parent:show_whiskers_div}).setAttribute("for",show_whiskers_checkbox_id);const show_outliers_div=common.create_dom_element({element_type:"div",parent:container_div}),show_outliers_checkbox_id=`${this.id_string()}_show_outliers_checkbox`,show_outliers_checkbox=common.create_dom_element({element_type:"input",type:"checkbox",id:show_outliers_checkbox_id,parent:show_outliers_div});show_outliers_checkbox.checked=!0,this._controls.show_checkboxes.outliers=show_outliers_checkbox;common.create_dom_element({element_type:"label",text_content:tstring.outliers||"Outliers",parent:show_outliers_div}).setAttribute("for",show_outliers_checkbox_id)},boxvio_chart_wrapper.prototype._render_scale_sliders=function(){const container_div=common.create_dom_element({element_type:"div",parent:this._controls.sections.general.content_container,class_name:"control_panel_item scale_sliders"}),violin_container_div=common.create_dom_element({element_type:"div",parent:container_div}),violin_scale_slider_id=`${this.id_string()}_violin_scale_slider`;common.create_dom_element({element_type:"label",text_content:tstring.violin_width||"Violin width",parent:violin_container_div}).setAttribute("for",violin_scale_slider_id);const violin_scale_slider=common.create_dom_element({element_type:"input",type:"range",id:violin_scale_slider_id,parent:violin_container_div});violin_scale_slider.setAttribute("min",0),violin_scale_slider.setAttribute("max",1),violin_scale_slider.setAttribute("step",.05),violin_scale_slider.value=this._chart.violin_scale.initial,this._controls.scale.violin.slider=violin_scale_slider,this._controls.scale.violin.reset=common.create_dom_element({element_type:"button",type:"button",class_name:"small",text_content:tstring.reset||"Reset",parent:violin_container_div});const box_container_div=common.create_dom_element({element_type:"div",parent:container_div}),box_scale_slider_id=`${this.id_string()}_box_scale_slider`;common.create_dom_element({element_type:"label",text_content:tstring.box_width||"Box width",parent:box_container_div}).setAttribute("for",box_scale_slider_id);const box_scale_slider=common.create_dom_element({element_type:"input",type:"range",id:box_scale_slider_id,parent:box_container_div});box_scale_slider.setAttribute("min",0),box_scale_slider.setAttribute("max",1),box_scale_slider.setAttribute("step",.05),box_scale_slider.value=this._chart.box_scale.initial,this._controls.scale.box.slider=box_scale_slider,this._controls.scale.box.reset=common.create_dom_element({element_type:"button",type:"button",class_name:"small",text_content:tstring.reset||"Reset",parent:box_container_div})},boxvio_chart_wrapper.prototype._render_n_bins_control=function(){const container=common.create_dom_element({element_type:"div",parent:this._controls.sections.specific.content_container,class_name:"control_panel_item n_bins_control"}),violin_n_bins_slider_id=`${this.id_string()}_violin_n_bins_slider`;common.create_dom_element({element_type:"label",text_content:tstring.violin_resolution||"Violin resolution",parent:container}).setAttribute("for",violin_n_bins_slider_id);const violin_n_bins_slider=common.create_dom_element({element_type:"input",type:"range",id:violin_n_bins_slider_id,parent:container});this._controls.violin_n_bins.slider=violin_n_bins_slider,violin_n_bins_slider.setAttribute("min",2),violin_n_bins_slider.setAttribute("max",this._controls.max_bins_multiplier*this._chart.n_bins[this._controls.selected_index].initial),violin_n_bins_slider.value=this._chart.n_bins[this._controls.selected_index].value,this._controls.violin_n_bins.reset=common.create_dom_element({element_type:"button",type:"button",class_name:"small",text_content:tstring.reset||"Reset",parent:container}),this._controls.violin_n_bins.reset_all=common.create_dom_element({element_type:"button",type:"button",class_name:"small",text_content:tstring.reset_all_violins||"Reset all violins",parent:container})},boxvio_chart_wrapper.prototype._control_panel_logic=function(){this._controls.sections.general.title.addEventListener("click",(()=>{this._controls.sections.general.title.classList.toggle("opened"),this._controls.sections.general.content_container.classList.toggle("hide")})),this._controls.grid_select.addEventListener("change",(()=>{const mode=this._controls.grid_select.value;this.apply_ygrid_mode(mode)})),this._controls.xticklabel_angle_slider.addEventListener("input",(()=>{this._chart.xticklabel_angle=Number(this._controls.xticklabel_angle_slider.value),this.apply_xticklabel_angle()})),this._controls.curve_select.addEventListener("change",(()=>{this.set_violin_curve(this._controls.curve_select.value)})),this._controls.show_checkboxes.key2.addEventListener("change",(()=>{toggle_visibility(this._graphics.key2_dividers_g)})),this._controls.show_checkboxes.violins.addEventListener("change",(()=>{toggle_visibility(this._graphics.violins_g)})),this._controls.show_checkboxes.boxes.addEventListener("change",(()=>{toggle_visibility(this._graphics.boxes_g)})),this._controls.show_checkboxes.whiskers.addEventListener("change",(()=>{for(const whisker of this._graphics.whiskers)toggle_visibility(whisker)})),this._controls.show_checkboxes.outliers.addEventListener("change",(()=>{for(const group of this._graphics.outliers)toggle_visibility(group)})),this._controls.scale.violin.slider.addEventListener("input",(()=>{this.set_violin_scale(Number(this._controls.scale.violin.slider.value))})),this._controls.scale.violin.reset.addEventListener("click",(()=>{this._controls.scale.violin.slider.value=this._chart.violin_scale.initial,this.set_violin_scale(Number(this._controls.scale.violin.slider.value))})),this._controls.scale.box.slider.addEventListener("input",(()=>{this.set_box_scale(Number(this._controls.scale.box.slider.value))})),this._controls.scale.box.reset.addEventListener("click",(()=>{this._controls.scale.box.slider.value=this._chart.box_scale.initial,this.set_box_scale(Number(this._controls.scale.box.slider.value))})),this._controls.sections.specific.title.addEventListener("click",(()=>{this._controls.sections.specific.title.classList.toggle("opened"),this._controls.sections.specific.content_container.classList.toggle("hide")}));const violin_n_bins_slider=this._controls.violin_n_bins.slider;violin_n_bins_slider.addEventListener("input",(()=>{this.set_n_bins(this._controls.selected_index,Number(violin_n_bins_slider.value))})),violin_n_bins_slider.addEventListener("ch_group_change",(()=>{violin_n_bins_slider.setAttribute("max",this._controls.max_bins_multiplier*this._chart.n_bins[this._controls.selected_index].initial),violin_n_bins_slider.value=this._chart.n_bins[this._controls.selected_index].value})),this._controls.violin_n_bins.reset.addEventListener("click",(()=>{violin_n_bins_slider.value=this._chart.n_bins[this._controls.selected_index].initial,this.set_n_bins(this._controls.selected_index,Number(violin_n_bins_slider.value))})),this._controls.violin_n_bins.reset_all.addEventListener("click",(()=>{violin_n_bins_slider.value=this._chart.n_bins[this._controls.selected_index].initial;for(const[i,n_bins]of this._chart.n_bins.entries())this.set_n_bins(i,n_bins.initial)}))};const KEY2_MARGIN=[6,15];function clock_chart_wrapper(div_wrapper,data,options){d3_chart_wrapper.call(this,div_wrapper,options),this._tooltip_callback=options.tooltip_callback||null,this._tooltip_callback_options_attributes=options.tooltip_callback_options_attributes||null;const sort=options.sort||data[0].key.length>1||!1;this._data=sort?data.sort(((a,b)=>a.key.join().localeCompare(b.key.join()))):data,this._kdm=new keyed_data(this._data),this._key2_values=this._kdm.key_size>1?this._kdm.key_values(2):null,this._width=this._compute_width(),this._height=114,this._chart={},this._chart.key2_start_x=this._kdm.key_size>1?this._compute_key2_start_x():null,this._chart.datum_start_x=this._compute_datum_start_x(),this._chart.tooltip_active=null,this._graphics={root_g:null,key2_dividers_g:null,datum_g:null,tooltip_div:null}}Object.setPrototypeOf(clock_chart_wrapper.prototype,d3_chart_wrapper.prototype),clock_chart_wrapper.prototype._compute_width=function(){const n=this._data.length;if(1==this._kdm.key_size)return 100*n+6*(n-1);let width=this._key2_values.length*d3.sum(KEY2_MARGIN)-KEY2_MARGIN[0];for(const key2_value of this._key2_values){const n_groups=this._kdm.get_next_key_component_values([key2_value]).length;width+=100*n_groups+6*(n_groups-1)}return width},clock_chart_wrapper.prototype._compute_key2_start_x=function(){const positions={},key_tpls=this._kdm.get_key_templates(2);let current_x=0;for(const key_tpl of key_tpls){const queried_data=this._kdm.query(key_tpl);positions[key_tpl[key_tpl.length-2]]=current_x,current_x+=d3.sum(KEY2_MARGIN)+100*queried_data.length+6*(queried_data.length-1)}return positions},clock_chart_wrapper.prototype._compute_datum_start_x=function(){if(1===this._kdm.key_size)return Array(this._data.length).map(((_,i)=>106*i));const datum_start_x=[];let current_x=KEY2_MARGIN[1],current_key2=this._data[0].key[this._kdm.key_size-2];for(const datum of this._data){const key2=datum.key[this._kdm.key_size-2];current_key2!==key2&&(current_key2=key2,current_x+=d3.sum(KEY2_MARGIN)-6),datum_start_x.push(current_x),current_x+=106}return datum_start_x},clock_chart_wrapper.prototype.render_plot=function(){d3_chart_wrapper.prototype.render_plot.call(this),this.svg.attr("viewBox",`0 0 ${this._width} ${this._height}`),this.svg.on("click",(e=>{e.stopPropagation(),this._hide_tooltip()})),this.plot_container.addEventListener("click",(e=>{e.stopPropagation(),this._hide_tooltip()})),this._graphics.root_g=this.svg.append("g"),this._kdm.key_size>1&&this._render_key2_dividers(),this._graphics.datum_g=this._graphics.root_g.append("g");for(let i=0;i<this._data.length;i++)this._render_datum(i);this._render_tooltip()},clock_chart_wrapper.prototype._render_key2_dividers=function(){this._graphics.key2_dividers_g=this._graphics.root_g.append("g");const dividers_g=this._graphics.key2_dividers_g;for(const[index,key2]of this._key2_values.entries()){const x=this._chart.key2_start_x[key2],divider_g=dividers_g.append("g").attr("transform",`translate(${x},0)`);divider_g.append("line").attr("x1",0).attr("y1",0).attr("x2",0).attr("y2",this._height).attr("stroke","gray").attr("stroke-width",.9).attr("stroke-dasharray",this._height/35),divider_g.append("text").attr("text-anchor","end").attr("transform","rotate(-90)").attr("y","1.3em").attr("x","-0.6em").attr("font-size","0.3em").attr("fill","gray").text(key2)}},clock_chart_wrapper.prototype._render_datum=function(i){const datum=this._data[i],g=this._graphics.datum_g.append("g").attr("transform",`translate(${this._chart.datum_start_x[i]},0)`);this._render_handles(g,i,datum),this._render_label(g,datum)},clock_chart_wrapper.prototype._render_handles=function(container_g,i,datum){const values=datum.values,delta=2*Math.PI/values.length;let angle=Math.PI/2;const max_value=d3.max(values),scale=d3.scaleLinear().domain([0,max_value]).range([0,50]),g=container_g.append("g").attr("transform","translate(50,50)");for(const value of values){const handle_g=g.append("g");handle_g.append("line").attr("x1",0).attr("y1",0).attr("x2",50*Math.cos(angle)).attr("y2",-50*Math.sin(angle)).attr("stroke","#e3e3e3").attr("stroke-width",.6),handle_g.append("line").attr("x1",0).attr("y1",0).attr("x2",scale(value)*Math.cos(angle)).attr("y2",-scale(value)*Math.sin(angle)).attr("stroke","black").attr("stroke-width",1),angle-=delta}const circle=g.append("circle").style("fill","black").attr("r",2.5);this._tooltip_callback&&(circle.classed("clickable",!0),circle.on("click",(e=>{e.stopPropagation(),this._chart.tooltip_active!==i&&(this.tooltip_show(datum),this._graphics.tooltip_div.style("display","flex"),this._chart.tooltip_active=i)})))},clock_chart_wrapper.prototype._render_label=function(container_g,datum){const g=container_g.append("g").attr("transform","translate(50,100)"),key1=datum.key[this._kdm.key_size-1];datum.id,g.append("text").attr("text-anchor","middle").attr("y","1.5em").attr("font-size","0.25em").attr("fill","black").text(key1),g.append("text").attr("text-anchor","middle").attr("y","3.2em").attr("font-size","0.2em").attr("fill","black").text(`(${d3.sum(datum.values)})`)},clock_chart_wrapper.prototype._hide_tooltip=function(){this._graphics.tooltip_div.style("display","none"),this._chart.tooltip_active=null},clock_chart_wrapper.prototype._render_tooltip=function(){const tooltip_element=common.create_dom_element({element_type:"div",id:`${this.id_string()}_tooltip_div`,class_name:"o-red tooltip_div"});insert_after(tooltip_element,this.plot_container),this._graphics.tooltip_div=d3.select(tooltip_element),this._hide_tooltip()},clock_chart_wrapper.prototype.tooltip_show=function(datum){const self=this,options={};for(const attr_name of this._tooltip_callback_options_attributes)options[attr_name]=datum[attr_name];self._tooltip_callback(options).then((ele=>{const tooltip_element=self._graphics.tooltip_div.node();ele.id=`${self.id_string()}_tooltip_callback_div`,ele.classList.add("tooltip_callback_div"),tooltip_element.replaceChildren(ele)}))};const analysis={form:null,area_name:null,row:null,export_data_container:null,form_items_container:null,weight_chart_container:null,diameter_chart_container:null,clock_chart_container:null,weight_chart_wrapper:null,diameter_chart_wrapper:null,clock_chart_wrapper:null,set_up:function(options){this.area_name=options.area_name,this.export_data_container=options.export_data_container,this.row=options.row,this.form_items_container=options.form_items_container,this.weight_chart_container=options.weight_chart_container,this.diameter_chart_container=options.diameter_chart_container,this.clock_chart_container=options.clock_chart_container;const form_node=this.render_form();return this.form_items_container.appendChild(form_node),!0},render_form:function(){const self=this,fragment=new DocumentFragment;self.form=self.form||new form_factory;const form_row=common.create_dom_element({element_type:"div",class_name:"form-row fields",parent:fragment});self.form.item_factory({id:"mint",name:"mint",label:tstring.mint||"mint",q_column:"p_mint",value_wrapper:['["','"]'],eq:"LIKE",eq_in:"%",eq_out:"%",is_term:!0,parent:form_row,callback:function(form_item){self.form.activate_autocomplete({form_item:form_item,table:"catalog"})}}),self.form.item_factory({id:"number",name:"number",q_column:"term",q_table:"types",label:tstring.number_key||"Number & Key",is_term:!1,parent:form_row,group_op:"$or",callback:function(form_item){self.form.activate_autocomplete({form_item:form_item,table:"catalog"})}}),self.form.item_factory({id:"material",name:"material",q_column:"ref_type_material",q_table:"any",label:tstring.material||"material",is_term:!1,parent:form_row,callback:function(form_item){self.form.activate_autocomplete({form_item:form_item,table:"catalog"})}}),self.form.item_factory({id:"denomination",name:"denomination",q_column:"ref_type_denomination",q_table:"any",label:tstring.denomination||"denomination",is_term:!1,parent:form_row,callback:function(form_item){self.form.activate_autocomplete({form_item:form_item,table:"catalog"})}}),self.form.item_factory({id:"culture",name:"culture",label:tstring.culture||"culture",q_column:"p_culture",value_wrapper:['["','"]'],eq_in:"%",eq_out:"%",is_term:!0,parent:form_row,callback:function(form_item){self.form.activate_autocomplete({form_item:form_item,table:"catalog"})}}),self.form.item_factory({id:"iconography_obverse",name:"iconography_obverse",label:tstring.iconography_obverse||"iconography obverse",q_column:"ref_type_design_obverse_iconography",value_split:" | ",q_splittable:!0,q_selected_eq:"LIKE",eq_in:"%",eq_out:"%",is_term:!1,parent:form_row,callback:function(form_item){self.form.activate_autocomplete({form_item:form_item,table:"catalog"})}}),self.form.item_factory({id:"iconography_reverse",name:"iconography_reverse",label:tstring.iconography_reverse||"iconography reverse",q_column:"ref_type_design_reverse_iconography",value_split:" | ",q_splittable:!0,q_selected_eq:"LIKE",eq_in:"%",eq_out:"%",is_term:!1,parent:form_row,callback:function(form_item){self.form.activate_autocomplete({form_item:form_item,table:"catalog"})}}),self.form.item_factory({id:"range_slider",name:"range_slider",input_type:"range_slider",label:tstring.period||"Period",class_name:"range_slider",q_column:"ref_date_in,ref_date_end",sql_filter:null,parent:form_row,callback:function(form_item){const node_input=form_item.node_input,range_slider_value_in=node_input.parentNode.querySelector("#range_slider_in"),range_slider_value_out=node_input.parentNode.querySelector("#range_slider_out");self.get_catalog_range_years().then((function(range_data){$(node_input).slider("instance")&&$(node_input).slider("destroy"),form_item.sql_filter=null,range_slider_value_in.value=range_data.min,range_slider_value_in.addEventListener("change",(function(e){const value=e.target.value>=range_data.min?e.target.value:range_data.min;$(node_input).slider("values",0,value),e.target.value=value})),range_slider_value_out.value=range_data.max,range_slider_value_out.addEventListener("change",(function(e){const value=e.target.value<=range_data.max?e.target.value:range_data.max;$(node_input).slider("values",1,e.target.value),e.target.value=value})),$(node_input).slider({range:!0,min:range_data.min,max:range_data.max,step:1,values:[range_data.min,range_data.max],slide:function(event,ui){range_slider_value_in.value=ui.values[0],range_slider_value_out.value=ui.values[1]},change:function(event,ui){form_item.sql_filter="(ref_date_in >= "+ui.values[0]+" AND ref_date_in <= "+ui.values[1]+")",form_item.q=ui.value}})}))}});const submit_group=common.create_dom_element({element_type:"div",class_name:"form-group field button_submit",parent:fragment});common.create_dom_element({element_type:"input",type:"submit",id:"submit",value:tstring.search||"Search",class_name:"btn btn-light btn-block primary",parent:submit_group}).addEventListener("click",(function(e){e.preventDefault(),self.form_submit(form)}));common.create_dom_element({element_type:"input",type:"button",id:"button_reset",value:tstring.reset||"Reset",class_name:"btn btn-light btn-block secondary button_reset",parent:submit_group}).addEventListener("click",(function(e){e.preventDefault(),window.location.replace(window.location.pathname)}));const operators_node=self.form.build_operators_node();fragment.appendChild(operators_node);const form=common.create_dom_element({element_type:"form",id:"search_form",class_name:"form-inline"});return form.appendChild(fragment),form},form_submit:function(form_obj,options={}){"boolean"!=typeof options.scroll_result||options.scroll_result;const form_items=options.form_items||this.form.form_items,filter=this.form.build_filter({form_items:form_items});if(!filter||filter.length<1)return!1;const section_container={weight:document.getElementById("weight_section"),diameter:document.getElementById("diameter_section"),clock:document.getElementById("clock_section")};for(const[sec_name,container]of Object.entries(section_container))container.classList.add("hide");this.diameter_chart_container.replaceChildren(),this.weight_chart_container.replaceChildren(),this.clock_chart_container.replaceChildren();const result=document.getElementById("result"),spinner=common.create_dom_element({element_type:"div",class_name:"spinner",parent:result});return this.search_rows({filter:filter,limit:0,process_result:{fn:"process_result::add_parents_and_children_recursive",columns:[{name:"parents"}]}}).then((parsed_data=>{event_manager.publish("form_submit",parsed_data);const data=[];for(const[i,ele]of parsed_data.entries()){const section_id=ele.section_id,number_key=ele.ref_type_number?ele.ref_type_number:`Missing Number & Key (${i})`,mint=ele.p_mint?ele.p_mint[0]:`Missing mint (${ele.section_id})`,material=ele.ref_type_material?ele.ref_type_material:`Missing material (${i})`,denomination=ele.ref_type_denomination?ele.ref_type_denomination:`Missing denomination ${i}`,tmp_data={},calculable=ele.full_coins_reference_calculable,diameter_max=ele.full_coins_reference_diameter_max,diameter_min=ele.full_coins_reference_diameter_min,weight=ele.full_coins_reference_weight,axis=ele.full_coins_reference_axis;if(diameter_max&&diameter_max.length){const tmp_diameter_max=diameter_max.filter(((v,i)=>v&&calculable[i]));tmp_diameter_max.length&&(tmp_data.diameter_max=tmp_diameter_max)}if(diameter_min&&diameter_min.length){const tmp_diameter_min=diameter_min.filter(((v,i)=>v&&calculable[i]));tmp_diameter_min.length&&(tmp_data.diameter_min=tmp_diameter_min)}if(weight&&weight.length){const tmp_weight=weight.filter(((v,i)=>v&&calculable[i]));tmp_weight.length&&(tmp_data.weight=tmp_weight)}if(axis&&axis.length){const tmp_axis=axis.filter((v=>v));tmp_axis.length&&(tmp_data.axis=tmp_axis)}Object.keys(tmp_data).length&&(tmp_data.section_id=section_id,tmp_data.number_key=number_key,tmp_data.mint=mint,tmp_data.type_number=number_key,tmp_data.material=material,tmp_data.denomination=denomination,data.push(tmp_data))}const weights=data.filter((ele=>ele.weight)).map((ele=>({key:[ele.mint,ele.number_key],values:ele.weight,id:ele.section_id,mint:ele.mint,type_number:ele.number_key}))),diameters=data.filter((ele=>ele.diameter_max)).map((ele=>({key:[ele.mint,ele.number_key],values:ele.diameter_max,id:ele.section_id,mint:ele.mint,type_number:ele.number_key}))),axes=data.filter((ele=>ele.axis&&ele.axis.length)).map((ele=>{const axis=Array(12).fill(0);for(const hour of ele.axis)axis[hour%12]++;return{key:[ele.mint,ele.number_key],values:axis,id:ele.section_id,mint:ele.mint,type_number:ele.number_key}}));spinner.remove(),weights.length&&(section_container.weight.classList.remove("hide"),this.weight_chart_wrapper=new boxvio_chart_wrapper(this.weight_chart_container,weights,[tstring.mint||"Mint",tstring.number||"Number"],{whiskers_quantiles:[10,90],ylabel:tstring.weight||"Weight",overflow:!0,display_control_panel:!0,display_download:!0,sort_xaxis:!0,tooltip_callback:type_tooltip_callback,tooltip_callback_options_attributes:["id","type_number","mint"]}),this.weight_chart_wrapper.render()),diameters.length&&(section_container.diameter.classList.remove("hide"),this.diameter_chart_wrapper=new boxvio_chart_wrapper(this.diameter_chart_container,diameters,[tstring.mint||"Mint",tstring.number||"Number"],{whiskers_quantiles:[10,90],ylabel:tstring.diameter||"Diameter",overflow:!0,display_control_panel:!0,display_download:!0,sort_xaxis:!0,tooltip_callback:type_tooltip_callback,tooltip_callback_options_attributes:["id","type_number","mint"]}),this.diameter_chart_wrapper.render()),axes.length&&(section_container.clock.classList.remove("hide"),this.clock_chart_wrapper=new clock_chart_wrapper(this.clock_chart_container,axes,{overflow:!0,outer_height:"300px",display_download:!0,sort:!0,tooltip_callback:type_tooltip_callback,tooltip_callback_options_attributes:["id","type_number","mint"]}),this.clock_chart_wrapper.render())}))},search_rows:function(options){const self=this,filter=options.filter||null,ar_fields=options.ar_fields||["*"],order=options.order||"norder ASC",lang=page_globals.WEB_CURRENT_LANG_CODE,process_result=options.process_result||null,limit=null!=options.limit?options.limit:100;return new Promise((function(resolve){const group=[],sql_filter=self.form.parse_sql_filter(filter),request_body={dedalo_get:"records",table:"catalog",ar_fields:ar_fields,lang:lang,sql_filter:sql_filter,limit:limit,group:group.length>0?group.join(","):null,count:!1,order:order,process_result:process_result};data_manager.request({body:request_body}).then((response=>{const data=page.parse_catalog_data(response.result);resolve(data)}))}))},get_catalog_range_years:function(){return new Promise((function(resolve){const request_body={dedalo_get:"records",db_name:page_globals.WEB_DB,lang:page_globals.WEB_CURRENT_LANG_CODE,table:"catalog",ar_fields:["id","section_id","MIN(ref_date_in + 0) AS min","MAX(ref_date_in + 0) AS max"],limit:0,count:!1,offset:0,order:"id ASC"};data_manager.request({body:request_body}).then((function(api_response){let min=0,max=0;if(api_response.result)for(let i=0;i<api_response.result.length;i++){const row=api_response.result[i],current_min=parseInt(row.min);(0===min||current_min<min)&&(min=current_min);max=parseInt(row.max)}resolve({min:min,max:max})}))}))}};async function type_tooltip_callback(options){const section_id=options.id,type_number=options.type_number,mint=options.mint,catalog_request_options={dedalo_get:"records",lang:page_globals.WEB_CURRENT_LANG_CODE,table:"catalog",ar_fields:["*"],section_id:section_id,limit:1,count:!1},type_data=(await data_manager.request({body:catalog_request_options})).result||null;if(!type_data)return common.create_dom_element({element_type:"div",text_content:`Could not find number ${type_number} for mint ${mint} in the database.`});const type_row=page.parse_catalog_data(type_data)[0];type_row.add_denomination=!0;const ele=catalog_row_fields.draw_item(type_row);return ele.getElementsByClassName("coins_images")[0].removeAttribute("style"),ele}return exports.analysis=analysis,exports}({});